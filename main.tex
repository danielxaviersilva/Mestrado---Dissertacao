\documentclass[
    % -- opções da classe memoir --
    12pt,                % tamanho da fonte
    %openright,            % capítulos começam em pág ímpar (insere página vazia caso preciso)
    oneside,            % twoside para impressão em verso e anverso. Oposto a oneside
    a4paper,            % tamanho do papel.
    % -- opções da classe abntex2 --
    %section=TITLE,        % títulos de capítulos convertidos em letras maiúsculas
    %section=TITLE,        % títulos de seções convertidos em letras maiúsculas
    %subsection=TITLE,    % títulos de subseções convertidos em letras maiúsculas
    %subsubsection=TITLE,% títulos de subsubseções convertidos em letras maiúsculas
    % -- opções do pacote babel --
    english,            % idioma adicional para hifenização
    french,                % idioma adicional para hifenização
    spanish,            % idioma adicional para hifenização
    brazil                % o último idioma é o principal do documento
    ]{abntex2}

% ---
% Pacotes básicos
% ---
\usepackage{lmodern}            % Usa a fonte Latin Modern            
\usepackage[T1]{fontenc}        % Selecao de codigos de fonte.
\usepackage[utf8]{inputenc}        % Codificacao do documento (conversão automática dos acentos)
\usepackage{indentfirst}        % Indenta o primeiro parágrafo de cada seção.
\usepackage{lastpage}            % Usado pela Ficha catalográfica

\usepackage{color}                % Controle das cores
%\usepackage[demo]{graphicx}
\usepackage{graphicx}            % Inclusão de gráficos
\usepackage{microtype}             % para melhorias de justificação
\usepackage{amsmath}

%para R chique e curvo
\usepackage{mathrsfs}

\usepackage[position=bottom]{subfig}
%\usepackage[hang]{subfigure}
%\usepackage{subfigure}

%\usepackage[utf8]{inputenc}
\usepackage{algorithm}
\usepackage{algpseudocode}
%\usepackage{algorithm2e}

\makeatletter
\renewcommand{\ALG@name}{Algoritmo}
\makeatother
\renewcommand{\listalgorithmname}{Lista de Algoritmos}

\usepackage[brazil]{babel}
\usepackage[justification=centering]{caption}

%\newcommand\algorithmicprocedure{\textbf{procedure}}
%\newcommand{\algorithmicendprocedure}{\algorithmicend\ \algorithmicprocedure}
%\makeatletter
%\newcommand\PROCEDURE[3][default]{%
%  \ALC@it
%  \algorithmicprocedure\ \textsc{#2}(#3)%
%  \ALC@com{#1}%
%  \begin{ALC@prc}%
%}
%\newcommand\ENDPROCEDURE{%
%  \end{ALC@prc}%
%  \ifthenelse{\boolean{ALC@noend}}{}{%
%    \ALC@it\algorithmicendprocedure
%  }%
%}
\newenvironment{ALC@prc}{\begin{ALC@g}}{\end{ALC@g}}
\makeatother

\algnewcommand\algorithmicforeach{\textbf{for each}}
\algdef{S}[FOR]{ForEach}[1]{\algorithmicforeach\ #1\ \algorithmicdo}


% adicionado por Ting
\setlength{\marginparwidth}{2cm}
\usepackage{todonotes}
%\usepackage{soul}
\usepackage[normalem]{ulem}
\usepackage{hyperref}

%\setlength\afterchapskip{\lineskip}




% ---
        
% ---
% Pacotes adicionais, usados apenas no \^{a}mbito do Modelo Can\^{o}nico do abnteX2
% ---
\usepackage{lipsum}				% para gera\c{c}\~{a}o de dummy text
\usepackage{nomencl}
\usepackage{amsmath}
\usepackage{bbm}
\usepackage{multirow}
\usepackage{rotating}
\usepackage{pdfpages}
%\usepackage[font=footnotesize]{subfig}
\usepackage{booktabs}
\usepackage{pdflscape}
\usepackage{chngcntr}
\usepackage{amsmath,amsfonts,amssymb}

\usepackage{algorithm}

\usepackage{amsmath,amsfonts,amssymb}


%\let\printglossary\relax
%\let\theglossary\relax
%\let\endtheglossary\relax

\usepackage[nonumberlist,acronym,nomain]{glossaries} % nonnumberlist nao mostra as paginas nas quais os acronimos aparecem no texto
%\newglossary[tlg]{simbolos}{tld}{tdn}{Lista de símbolos}
% Generate the glossary
%\makeglossaries


\counterwithin{figure}{chapter}
\counterwithin{table}{chapter}
% Pacotes de citações
% ---
\usepackage[brazilian,hyperpageref]{backref}     % Paginas com as citações na bibl
\usepackage[alf]{abntex2cite}    % Citações padrão ABNT

\usepackage{unicamp}

% ---
% CONFiguraÇÕES DE PACOTES
% ---

% ---
% ConFigurações do pacote backref
% Usado sem a opção hyperpageref de backref
\renewcommand{\backrefpagesname}{Citado na(s) página(s):~}
% Texto padrão antes do número das páginas
\renewcommand{\backref}{}
% Define os textos da citação
\renewcommand*{\backrefalt}[4]{
    \ifcase #1 %
        Nenhuma citação no texto.%
    \or
        Citado na página #2.%
    \else
        Citado #1 vezes nas páginas #2.%
    \fi}%
% ---

%Redefinições de comando para pseudocódigo - Portugues
% Declaracoes em Português
%\algrenewcommand\algorithmicend{\textbf{fim}}
%\algrenewcommand\algorithmicdo{\textbf{faça}}
%\algrenewcommand\algorithmicwhile{\textbf{enqua%nto}}
%\algrenewcommand\algorithmicfor{\textbf{para}}
%\algrenewcommand\algorithmicif{\textbf{se}}
%\algrenewcommand\algorithmicthen{\textbf{então}%}
%\algrenewcommand\algorithmicelse{\textbf{senão}%}
%\algrenewcommand\algorithmicreturn{\textbf{devo%lve}}
%\algrenewcommand\algorithmicfunction{\textbf{fu%nção}}
%
%% Rearranja os finais de cada estrutura
%\algrenewtext{EndWhile}{\algorithmicend\ %\algorithmicwhile}
%\algrenewtext{EndFor}{\algorithmicend\ %\algorithmicfor}
%\algrenewtext{EndIf}{\algorithmicend\ %\algorithmicif}
%\algrenewtext{EndFunction}{\algorithmicend\ %\algorithmicfunction}
%
%% O comando For, a seguir, retorna 'para #1 -- %#2 até #3 faça'
%\algnewcommand\algorithmicto{\textbf{até}}
%\algrenewtext{For}[3]%
%{\algorithmicfor\ #1 $\gets$ #2 \algorithmicto\ %#3 \algorithmicdo}

% ---


% ---
% Informações de dados para CAPA e FOLHA DE ROSTO
% ---

%\tipotrabalho{Relatório de Qualificação de Mestrado}
% O preambulo deve conter o tipo do trabalho, o objetivo,
% o nome da instituição e a área de concentração

% ---


% ---
% Configurações de aparência do PDF final

% alterando o aspecto da cor azul
\definecolor{blue}{RGB}{41,5,195}

% informações do PDF
\makeatletter
\hypersetup{
         %pagebackref=true,
        pdftitle={\@title},
        pdfauthor={\@author},
        pdfsubject={\imprimirpreambulo},
        pdfcreator={LaTeX with abnTeX2},
        pdfkeywords={abnt}{latex}{abntex}{abntex2}{trabalho acadêmico},
        colorlinks=true,               % false: boxed links; true: colored links
        linkcolor= blue,              % color of internal links
        citecolor=blue,                % color of links to bibliography
        filecolor=magenta,              % color of file links
        urlcolor=blue,
        bookmarksdepth=4
}
\makeatother
% ---

% ---
% Espaçamentos entre linhas e parágrafos
% ---

% O tamanho do parágrafo é dado por:
\setlength{\parindent}{2cm}

% Controle do espaçamento entre um parágrafo e outro:
\setlength{\parskip}{0.2cm}  % tente também \onelineskip

\setlength\afterchapskip{\lineskip}

\titulo{Visualização Interativa de Funções de Distribuição de Orientação em Ambiente de Visualização Multimodal}
\autor{Daniel Xavier Silva}
\orientador{Profa. Dra. Wu Shin-Ting}
\local{Campinas}
\data{2021}
\instituicao{%
  UNIVERSIDADE ESTADUAL DE CAMPINAS
    \par
    Faculdade de Engenharia Elétrica e de Computação
  %Departamento de Engenharia de Computação e Automação Industrial - DCA\par
  %Faculdade de Engenharia Elétrica e de Computação - FEEC
  }
  \tipotrabalho{Dissertação (Mestrado)}
  \preambulo{Dissertação apresentada à Faculdade de Engenharia Elétrica e de Computação da Universidade Estadual de Campinas como parte dos requisitos exigidos para a obtenção do título de Mestre em Engenharia Elétrica, na Área de Engenharia de Computação.}

% ---
% compila o indice
% ---
\makeindex
% ---

% ----
% Início do documento
% ----

\begin{document}



% ----------------------------------------------------------
% ELEMENTOS PRÉ-TEXTUAIS
% ----------------------------------------------------------
% \pretextual

% ---
% Capa
% ---
% ---

\imprimircapa
% ---
% Folha de rosto
% (o * indica que haverá a ficha bibliográfica)
% ---
\imprimirfolhaderosto*
% ---

% ---
% Inserir a ficha bibliografica
% ---
\begin{fichacatalografica}
    \vspace*{\fill}
    \begin{center}
        \textsc{Inclua aqui o pdf com a ficha catalogr\'{a}fica fornecida pela BAE.}
    \end{center}
    \vspace*{\fill}
    %\includepdf{fig_ficha_catalografica.pdf}
\end{fichacatalografica}

% Isto é um exemplo de Ficha Catalográfica, ou ``Dados internacionais de
% catalogação-na-publicação''. Você pode utilizar este modelo como referência.
% Porém, provavelmente a biblioteca da sua universidade lhe fornecerá um PDF
% com a ficha catalográfica definitiva após a defesa do trabalho. Quando estiver
% com o documento, salve-o como PDF no diretório do seu projeto e substitua todo
% o conteúdo de implementação deste arquivo pelo comando abaixo:
%
% \begin{fichacatalografica}
%     \includepdf{fig_ficha_catalografica.pdf}
% \end{fichacatalografica}
% \begin{fichacatalografica}
%     \vspace*{\fill}                    % Posição vertical
%     \hrule                            % Linha horizontal
%     \begin{center}                    % Minipage Centralizado
%     \begin{minipage}[c]{12.5cm}        % Largura
    
%     \imprimirautor
    
%     \hspace{0.5cm} \imprimirtitulo  / \imprimirautor. --
%     \imprimirlocal, \imprimirdata-
    
%     \hspace{0.5cm} \pageref{LastPage} p. : il. (algumas color.) ; 30 cm.\\
    
%     \hspace{0.5cm} \imprimirorientadorRotulo~\imprimirorientador\\
    
%     \hspace{0.5cm}
%     \parbox[t]{\textwidth}{\imprimirtipotrabalho~--~\imprimirinstituicao,
%     \imprimirdata.}\\
    
%     \hspace{0.5cm}
%         1. Palavra-chave1.
%         2. Palavra-chave2.
%         I. Orientador.
%         II. Universidade xxx.
%         III. Faculdade de xxx.
%         IV. Título\\             
    
%     \hspace{8.75cm} CDU 02:141:005.7\\
    
%     \end{minipage}
%     \end{center}
%     \hrule
% \end{fichacatalografica}


% \includepdf{folhadeaprovacao_final.pdf}
%
% --- Inserir folha de aprova\c{c}\~{a}o ---

% Isto \'{e} um exemplo de Folha de aprova\c{c}\~{a}o, elemento obrigat\'{o}rio da NBR
% 14724/2011 (se\c{c}\~{a}o 4.2.1.3). Voc\^{e} pode utilizar este modelo at\'{e} a aprova\c{c}\~{a}o
% do trabalho. Ap\'{o}s isso, substitua todo o conte\'{u}do deste arquivo por uma
% imagem da p\'{a}gina assinada pela banca com o comando abaixo:
%
% \begin{folhadeaprovacao}
% \includepdf{folhadeaprovacao_final.pdf}
% \end{folhadeaprovacao}
%
\begin{folhadeaprovacao}

  \begin{center}
    COMISS\~{A}O JULGADORA - TESE DE DOUTORADO
    %\textsc{Inclua aqui a folha de assinaturas.}
\end{center}
\noindent
\begin{minipage}{\textwidth}\SingleSpacing
Candidato(a): Daniel Xavier Silva     RA: 229988

Data de defesa: XX de MES de 202X

T\'{i}tulo da Tese: "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
\vspace{2cm}

Profa. Dra. Wu Shin-Ting (Presidente)

Profa. Dra. xxxxxxx

Profa. Dra. xxxxxxx

Profa. Dra. xxxxxxxxx

Profa. Dra xxxxxxxxxxxx

\vspace{2cm}

A Ata de Defesa, com as respectivas assinaturas dos membros da Comissão Julgadora, encontra-se no SIGA (Sistema de Fluxo de Dissertação/Tese) e na Secretaria de Pós-Graduação da Faculdade de Engenharia Elétrica e de Computação.
\end{minipage}

\end{folhadeaprovacao}
% ---

% ---
% Dedicatória
% ---
\begin{dedicatoria}
   \vspace*{\fill}
   \centering
   \noindent
   \textit{!!Eu dedico este trabalho} \vspace*{\fill}
\end{dedicatoria}
% ---

% ---
% Agradecimentos
% ---
% ---
\begin{agradecimentos}
    !!O presente trabalho foi realizado com apoio do CNPq, Conselho Nacional de Desenvolvimento Científico  e Tecnológico – Brasil.
\end{agradecimentos}

% ---
% Epígrafe
% ---
\begin{epigrafe}
    \vspace*{\fill}
	\begin{flushright}
		\textit{``Escreva aqui a sua ep\'{\i}grafe (Opcional)''\\
		(Cita\c{c}\~{a}o)}
	\end{flushright}
\end{epigrafe}
% ---

% ---
% RESUMOS

%% resumo em português
\setlength{\absparsep}{18pt} % ajusta o espaçamento %dos parágrafos do resumo
\begin{resumo}

A ressonância magnética ponderada por difusão (DWI) é uma modalidade de imageamento que mensura a difusão de fluidos. Aplicada ao cérebro, o DWI é único no que diz respeito à quantificação deste fenômeno na água em tecido vivo. Na substância branca do cérebro, a difusão tem a mesma direção preferencial de suas fibras, o que possibilita a inferência da sua arquitetura \textit{in-vivo} e de forma não-invasiva. Para este fim, há métodos de imageamento que modelam este fenômeno, sendo o imageamento por tensor de difusão (\textit{Diffusion Tensor Imaging}, DTI) o mais conhecido e difundido clinicamente. A partir do tensor, métricas, como informações referentes à direção preferencial de difusão, possibilitam o inferimento da arquitetura da substância branca e tornam viável estudos e diagnósticos. No entanto, o modelo utilizado no DTI falha no mapeamento do comportamento difusão em regiões de substância branca onde há duas ou mais populações de fibras localizadas no mesmo \textit{voxel}. Face a este problema, grupos de pesquisa passaram a propor métodos de mais alta ordem para modelar a difusão com o objetivo de superar o problema do DTI e possibilitar o inferimento da arquitetura da substância branca de forma mais precisa. Este trabalho tem como objetivo a integração de um método de alta ordem em um ambiente de visualização multimodal interativo para processamento de volumes de difusão, e sua visualização interativa em glifos. Apresentamos uma introdução aos métodos de alta ordem e sua motivação e detalhamos a implementação computacional do método Amostragem Generalizado no Espaço-Q (\textit{Generalized Q-Space Imaging}, GQI). Afim de proporcionar uma visão tridimensional dos dados obtidos através do método, desenvolvemos um algoritmo interativo acelerado por GPU que mapeiam os dados provenientes de métodos de alta ordem em glifos. Os glifos propiciam a inferência da trajetória de fibras subjacentes e avaliação dos dados gerados, que é fundamental para pesquisa na área.


\vspace{\onelineskip}
\noindent\textbf{Palavras-chave}: amostragem generalizada no espaço-Q, HARDI, ressonância magnética ponderada por difusão, renderização de glifos, computação gráfica, plotagem polar esférica
\end{resumo}
\pagebreak
%
%% resumo em inglês
\begin{resumo}[Abstract]
 \begin{otherlanguage*}{english}
 
Diffusion-weighted magnetic resonance (DWI) is an imaging modality that measures fluid diffusion. Applied to the brain, DWI is unique when it comes to quantifying this phenomenon in water in living tissue. In the white matter of the brain, the diffusion has the preferential direction of its fibers, which allows the inference of its \textit{in-vivo} architecture and noninvasively. For this purpose, there are imaging methods that model this phenomenon, and the diffusion tensor imaging (DTI) is the most well-known and clinically disseminated. From the tensor metrics, such as information regarding the preferred direction of diffusion, it is possible to infer the white matter architecture and make studies and diagnoses viable. However, the model used in DTI cannot resolve regions of white matter where there are two or more fiber populations in the same voxel. Facing this problem, research groups started to propose higher-order methods to model a diffusion in order to overcome the DTI problem and make it possible to infer the white matter architecture more precisely. This work aims to integrate a high-order method in an interactive multimodal visualization environment for processing diffusion volumes, and its interactive visualization in glyphs. We present an introduction to high-order methods and their motivation and detail the computational implementation of the Generalized Q-Sampling Imaging. In order to provide a three-dimensional view of the data obtained through the method, we developed an interactive GPU-accelerated algorithm that maps the data from the high-order method into glyphs. The glyphs provides the inference of the underlying fiber trajectory and evaluation of the generated data, which have great utility for the research in the area.

\vspace{\onelineskip}
\noindent\textbf{Palavras-chave}: Generalized Q-Sampling Imaging, HARDI, diffusion-weighted magnetic resonance imaging, glyph rendering, computer graphics, spherical polar plot
 \end{otherlanguage*}
\end{resumo}


% ---
% inserir lista de ilustrações
% ---
\pdfbookmark[0]{\listfigurename}{lof}
\listoffigures*
\cleardoublepage
% ---

% ---
% inserir lista de tabelas
% ---
\pdfbookmark[0]{\listtablename}{lot}
\listoftables*
\cleardoublepage
% ---

% ---
% inserir lista de abreviaturas e siglas
% ---
\begin{siglas}
\item[DWI] \textit{Diffusion Weighted Magnetic Resonance Imaging} (Ressonância Magnética Ponderada por Gradientes de Difusão)
  
\item[DTI] \textit{Diffusion Tensor Imaging} (Imageamento por Tensor de Difusão)

\item[HARDI] \textit{High Angular Resolution Diffusion Imaging} (Imageamento de difusão por alta resolução angular)

\item[PGSE] \textit{Pulsed Gradient Spin Echo}

\item[EPI] \textit{Echo-Planar Imaging}

\item[ADC] \textit{Apparent Diffusion Coefficient} (coeficiente de difusão aparente)

%\item[FA] \textit{Fractional Anisotropy} (Anisotropia Fracionada)

%\item[QBI] \textit{Q-Ball Imaging}

\item[MRI] Magnetic Resonance Imaging (Imageamento por Ressonância Magnética)

%\item[CST] \textit{Corticospinal Tract} (Trato Corticoespinhal)

\item[GQI] \textit{Generalized Q-Sampling Imaging} (amostragem generalizada no espaço Q)

%\item[ROI] \textit{Region of Interest} (Região de Interesse)

\item[ODF] \textit{Orientation Distribution Function} (Função de Distribuição de orientação)

\item[fODF] \textit{Fiber Orientation Distribution Function} (Função de Distribuição de Orientação de Fibra)

\item[dODF] \textit{Diffusion Orientation Distribution Function} (Função de Distribuição de Orientação de Difusão)

\item[ISMRM]    \textit{International Society for Magnetic Resonance in Medicine} (Sociedade Internacional para Ressonância Magnética em Medicina)

\item[UNICAMP] Universidade Estadual de Campinas

%\item[SLF] \textit{Superior Longitudinal Fasciculus} (Fascículo Longitudinal Superior)

%\item[CC] Corpo Caloso

%\item[GFA] \textit{Generalized Fractional Anisotropy} Anisotropia Fracionada Generalizada
\item[VMTK-Neuro] \textit{Manipulation Toolkit for NeuroImages}

\item[DSI] \textit{Diffusion Spectrum Imaging} (Imagemento por Espectro de difusão)

\item [CPU] \textit{Computer Processing Unit} (Unidade de Processamento Computacional)

\item [GPU] \textit{Graphics Processing Unit} (Unidade de Processamento Gráfico)
\end{siglas}


% ---

% ---
% inserir lista de símbolos
% ---

% ---

% ---
% inserir o sumario
% ---
\pdfbookmark[0]{\contentsname}{toc}
\tableofcontents*
\cleardoublepage
% ---



% ----------------------------------------------------------
% ELEMENTOS TEXTUAIS
% ----------------------------------------------------------
\textual



\chapter{Introdução}
\label{sec:introducao}

A difusão molecular é um processo físico que se refere ao movimento aleatório de moléculas de fluídos que resultam da sua energia térmica \cite{lebihan2006}. 
Pode-se categorizar o movimento de difusão em relação ao meio da sua ocorrência em difusão isotrópica e anisotrópica. A difusão isotrópica é quando a difusão é igual em todas as direções. Ela ocorre em um meio que não oferece obstáculos (Fig. \ref{fig::intro_difusao_isotropica}). Enquanto na difusão anisotrópica, o meio apresenta restrições ao movimento (Fig. \ref{fig::intro_difusao_anisotropica}).

No cérebro, o processo de difusão ocorre majoritariamente com moléculas de água e difere significantemente da difusão isotrópica \cite{lebihan2006}. As moléculas interagem com os corpos celulares de neurônios (substância cinzenta) e feixes de dendritos e axônios (substância branca).
Há diferenças na forma de ocorrência da difusão nas substâncias branca e cinzenta do cérebro. Na substância cinzenta, a característica da difusão é altamente complexa devido à sua organização em camadas, o que torna a interpretação do fenômeno bem desafiadora. A substância branca, por sua vez, é composta por fibras organizadas em um conjunto coerente e compactado que faz a conexão entre neurônios localizados em diferentes partes do cérebro, o que faz a difusão ter um comportamento proeminente ao longo da direção do feixe de fibras \cite{DTI_Handbook}.

A ocorrência da difusão na direção dos feixes se deve aos obstáculos impostos pelas fibras, no qual permite que a água na região entre fibras se difunda predominantemente na direção do feixe, e encontre menos obstáculos em comparação a direções mais próximas das direções perpendiculares às fibras. As barreiras ilustradas em Fig. \ref{fig::intro_difusao_anisotropica} são análogas 
às barreiras impostas pela substância branca sobre a água no cérebro.


\begin{figure}[ht]
\centering
\captionsetup[subfloat]{farskip=0pt,nearskip=0pt}
    \subfloat[Tempo = 0]{\includegraphics[width=.25\linewidth, angle=0]{figs/Introducao/Difusao_isotropica/water_molecule_t0.png}
    \label{fig::intro_difusao_isotropica_0}
    }
    \subfloat[Tempo = t]{\includegraphics[width=.25\linewidth, angle=0]{figs/Introducao/Difusao_isotropica/water_molecule_t1.png}
    \label{fig::intro_difusao_isotropica_1}
    }
    \subfloat[Tempo = 2t]{\includegraphics[width=.25\linewidth, angle=0]{figs/Introducao/Difusao_isotropica/water_molecule_t2.png}
    \label{fig::intro_difusao_isotropica_2}
    }
    \caption{Ilustração visual da difusão isotrópica. Os pontos azuis e vermelhos representam moléculas de fluidos. As moléculas em vermelho, inicialmente concentradas, se movimentam sem uma direção preferencial. \\ Fonte: \cite{voltoline2016}}
    \label{fig::intro_difusao_isotropica}
\end{figure}

\begin{figure}[ht]
\centering
\captionsetup[subfloat]{farskip=0pt,nearskip=0pt}
    \subfloat[Tempo = 0]{\includegraphics[width=.25\linewidth, angle=0]{figs/Introducao/Difusao_anisotropica/water_molecule_anisotropic_t0.png}
    \label{fig::intro_difusao_anisotropica_0}
    }
    \subfloat[Tempo = t]{\includegraphics[width=.25\linewidth, angle=0]{figs/Introducao/Difusao_anisotropica/water_molecule_anisotropic_t1.png}
    \label{fig::intro_difusao_anisotropica_1}
    }
    \subfloat[Tempo = 2t]{\includegraphics[width=.25\linewidth, angle=0]{figs/Introducao/Difusao_anisotropica/water_molecule_anisotropic_t2.png}
    \label{fig::intro_difusao_anisotropica_2}
    }
    \caption{Ilustração visual da difusão anisotrópica. Os pontos azuis e vermelhos representam moléculas de fluidos. As moléculas em vermelho, inicialmente concentradas, se movimentam de forma predominante em uma direção devido às restrições físicas em seu entorno. \\ Fonte: \cite{voltoline2016}
    }
    \label{fig::intro_difusao_anisotropica}
\end{figure}



%\todo{Por quê}
A medição das características de difusão da água no cérebro pode fornecer informações sobre a substância branca quanto à direção de fibras e conectividade do cérebro. Esta medição é possível através da ressonância magnética ponderada por difusão (\textit{diffusion-weighted magnetic resonance imaging}, DW-MRI ou DWI), que é no estado-da-arte o único meio não-invasivo a permitir tal informação. O DWI mede sinais de movimento browniano das moléculas de água dentro das amostras de um cérebro submetido a diferentes campos magnéticos.



%O DWI é uma forma de ressonância magnética que gera contraste a partir da difusão das moléculas de água em determinadas direções \cite{DTI_Handbook}. %A partir do sinal adquirido, há ferramentas que  possibilitam o seu mapeamento em  fibras nervosas do cérebro humano \textit{in-vivo}.

%A ressonância magnética ponderada na sequência de difusão (\textit{diffusion-weighted magnetic resonance imaging} - DW-MRI ou DWI) é uma sequência de ressonância magnética que mensura a difusão das moléculas de água em determinadas direções \cite{DTI_Handbook}. A partir do sinal adquirido, há ferramentas que  possibilitam o seu mapeamento em  fibras nervosas do cérebro humano \textit{in-vivo}.

%!!A forma mais comum para gerar o DWI é através da sequência e pulsos PGSE (\textit{Pulsed Gradient Spin Echo}).


%Na aquisição do DWI, é escaneado um conjunto de volumes em que cada um possui a ponderação de único gradiente de difusão associado a um valor-b\footnote{O valor-b é uma métrica de sensitividade para difusão e é função de parâmetros da aquisição do DWI, como função da intensidade, duração e o intervalo de tempo dos gradientes de ponderação de difusão. Quanto maior o seu valor, maior o decaimento do sinal relativo à difusão.}, e, adicionalmente, um ou mais volumes sem ponderação de gradiente, denominado volume b0. A quantidade de volumes ponderados para diferentes direções de gradiente é denominada de resolução angular.

Há diversas técnicas para sumarizar os sinais coletados em potenciais caminhos de fibras nervosas (tractografia). Essas técnicas são objeto de pesquisa desde o início dos anos 90 \cite{descoteaux2015}. Há também pesquisas na área de visualização em métodos de imageamento aplicados a aquisições DWI, tanto no que diz respeito à criação de glifos representativos do comportamento de difusão, quanto à reconstrução das fibras do cérebro.

O método de imageamento mais amplamente utilizada para estes fins é chamada de imageamento por tensor de difusão (\textit{Diffusion Tensor Imaging}, DTI), proposto por \citeonline{Basser1994}. %\sout{há mais de 25 anos}\textcolor{red}{desde os primeiros trabalhos seminais ...}.
Representando a difusão molecular de água como um modelo Gaussiano de dispersão,  o DTI consiste em um mapeamento, por amostra, dos sinais de difusão em tensores de ordem 2, representados por matrizes 3x3 simétricas. A informação referente ao processo de difusão é comumente extraída dos três autovetores e autovalores dessas matrizes.

%\sout{Há pesquisas na área de visualização em métodos de imageamento aplicados a aquisições DWI, tanto no que diz respeito à criação de glifos representativos do comportamento de difusão, quanto à reconstrução das fibras do cérebro -- denominada tractografia.}

\citeonline{Basser1994} e \citeonline{Kindlmann2004} propuseram glifos representativos que sintetizam a difusão por amostra a partir do DTI. A Fig. \ref{fig::intro_ex_DTI_glifos} ilustra glifos propostos por \citeonline{Kindlmann2004}, denominados superquádricos. Esses glifos são gráficos de funções superquádricas cujos coeficientes e expoentes refletem os autovalores e autovetores dos tensores de difusão.

A visualização do comportamento de difusão por amostra facilita a análise local dos sinais escaneados, mas o objetivo final da maioria das aplicações são os feixes de fibras que conectam de forma plausível as amostras locais de difusão. Técnicas usadas para tal reconstrução são conhecidas por tractografia. As fibras reconstruídas podem ser representadas por linhas, como ilustrado na Fig. \ref{fig::intro_ex_DTI_tractografia}. Algoritmos de tractografia baseados em DTI foram propostos, por exemplo, por \citeonline{Weinstein1999} e \citeonline{basser2000} e são categorizadas como determinísticas \textit{streamline}. Estes algoritmos consistem essencialmente em conectar as amostras pelas direções dos autovetores de tensores de difusão locais até um critérios de parada ser satisfeito. Estes critérios são relacionados à chegada da linha em regiões fora de matéria branca. Informações adicionais sobre as diferentes abordagens em tractografia podem ser encontradas em \cite{tournier2011, DTI_Handbook}.

\begin{figure}[ht]
\captionsetup[subfloat]{farskip=0pt,nearskip=0pt}
    \subfloat[Tensores de difusão representado por glifos superquádricos em uma fatia axial do cérebro na região do corpo caloso. As cores representam a direção predominante de difusão onde vermelho é esquerda-direita, azul é superior-inferior e verde é anterior-posterior]{\includegraphics[width=.52\linewidth, angle=0]{figs/Introducao/ex_DTI_Superquadrica.png}
    \label{fig::intro_ex_DTI_glifos}}
    \hfill
    \subfloat[Trato fascículo inferior fronto-occipital (IFOF). A cor predominantemente verde indica sua trajetória, que ocorre na direção anterior-posterior. As linhas são reconstruídas com base no proposto por \citeonline{Weinstein1999} ]{\includegraphics[width=.46\linewidth, angle=0]{figs/Introducao/ex_DTI_tractography.png}
    \label{fig::intro_ex_DTI_tractografia}}
    \caption{Ilustração de resultados de pesquisa na área de visualização em ressonância magnética de difusão utilizando o DTI.}
    \label{fig::intro_ex_DTI}
\end{figure}

%\todo[inline]{ Confira se as literaturas citadas abaixo são relacionadas com glifos e tractografia ... para não tirar o foco. Além de glifos, há várias formas de visualizar os dados dos tensores. Muitos trabalhos visualizam somente FA, ADC, etc.}

% \textcolor{magenta}{
% A partir da visualização de dados extraídos dos tensores, há estudos que buscam inferir sobre a substância branca e utilizá-las em diferentes estudos e diagnósticos. Como alguns exemplos, temos:
% \begin{itemize}
%     \item evidência de correlações de métricas do DTI com a degeneração do cérebro causada pela esclerose lateral amiotrófica e o seu potencial uso como biomarcador \cite{cirillo2012, baek2020};
%     \item diagnósticos de isquemia cerebral aguda em estágios iniciais, o que não é possível com MRI convencionais \cite{dong2004};
%     \item aplicação de métricas e tractografia à redes cognitivas na epilepsia do lobo temporal \cite{leyden2015}
% \end{itemize}
% }

Devido a sua natureza de modelagem, o DTI apresenta limitações. O modelo Gaussiano descreve bem regiões de fibras em que o comportamento de difusão ocorre predominantemente em uma direção. Em pontos que contém múltiplas fibras e que estão dispostas nas mais variadas configurações (por exemplo: cruzamento, bifurcação, fusão, espalhamento, \todo{toque? \textcolor{green}{A expressão que o pessoal usa é essa... o formato das fibras é:  ")(" é o nome toque não dá essa impressão  }} ``beijo'') o modelo Gaussiano não sintetiza de forma correta o comportamento da difusão, impedindo o cômputo das direções plausíveis para reconstrução de uma fibra de interesse \cite{fillard2011, daducci2014}. Há uma estimativa que entre 66\% a 90\% da substância branca do cérebro contém múltiplas configurações de cruzamento de fibra \cite{descoteaux2015} e a limitação do DTI é um obstáculo para traçar caminhos plausíveis de fibras do cérebro.

Cientes das limitações do DTI, pesquisadores da área propuseram métodos de imageamento com modelos matemáticos mais avançados e descritivos do processo de difusão, os quais passaram a demandar aquisições
%\todo{Escreveria qtdes para mostrar "mais".}
com uma quantidade maior de amostras de sinais de difusão por \textit{voxel} em comparação às aquisições utilizadas para o DTI. %Tais aquisições são denominadas imagem de difusão por \todo{Ou simplesmente alta resolução como Q-Space Imaging (QSI)}alta resolução angular  (HARDI - \textit{High Angular Resolution Diffusion Imaging}). 
A tese de doutorado de David Tuch \cite{tuch2002} é o trabalho seminal da área.




%  do tensor de difusão representam três direções ortogonais cujos respectivos autovalores representam a magnitude de difusão, que são máximos para restrição de ortogonalidade.

%\todo[inline]{Abstraindo o que você escreveu ... há duas linhas de empenho: visualização dos sinais de difusão por amostra (modelagem local da geometria das fibras) e/ou por fibra (modelagem global da conectividade das amostras). É melhor colocar Fig 1.1 e 1.2 uma ao lado da outra. Facilita análise comparativa.}








%\begin{figure}[ht]
%
%\centering
%\includegraphics[width=.485\linewidth, %angle=00]{figs/Introducao/ex_DTI_Superquadric%a.png}
%\centering
%\caption{Tensor de difusão representado por %glifos superquádricos em uma fatia axial do %cérebro na região do corpo caloso. As cores %representam a direção predominante de difusão %onde vermelho é esquerda-direita, azul é %superior-inferior e verde é %anterior-posterior}
%\label{fig::intro_ex_DTI_Superquadrica}
%\end{figure}

%\begin{figure}[ht]
%\centering
%\includegraphics[width=.485\linewidth, %angle=00]{figs/Introducao/ex_DTI_tractography%.png}
%\caption{Trato fascículo inferior %fronto-occipital (IFOF). A cor %predominantemente verde indica sua %trajetória, que ocorre na direção %anterior-posterior}
%\label{fig::intro_ex_DTI_Tractografia}
%\hfill
%\end{figure}




%\section{Motivação}
%\label{ssec:motivation}



%Uma aquisição DWI é considerada HARDI se há 45 ou mais gradientes de ponderação de difusão. Esta modalidade de aquisição se diferencia de uma aquisição DTI, que costuma possuir entre 6 a 32 direções \cite{descoteaux2015}.


%\todo{\url{https://www.researchgate.net/figure/Sampling-schemes-in-q-space-a-Cartesian-sampling-dedicated-to-diffusion-spectrum_fig3_319558026}}.

Durante a década de 2000, foram propostos métodos de imageamento mais descritivos do processo de difusão que o DTI, como demonstram os trabalhos conduzidos por Tuch \cite{tuch2002}, \cite{TuchQBall2004}, Tournier et al. \cite{tournier2007}, Wedeen et al. \cite{wedeen2005} e Yeh et al. \cite{yeh2010}. Estes métodos tinham como objetivo principal resolver o problema de cruzamento de fibras, assim superando as limitações do DTI. Para diferenciá-los do DTI, neste trabalho chamaremos estes métodos de imageamento de \textsf{métodos alta ordem}.

%Durante a década de 2000, foram propostos métodos de imageamento mais descritivos do processo de difusão que o DTI . Alguns deles consistem na abordagem multi-tensor \cite{tuch2002}, o \textit{Q-Ball Imaging} (QBI) \cite{tuch2002, Kindlmann2004}, \textit{constrained spherical deconvolution} (CSD) \cite{tournier2007}, \textit{diffusion spectrum imaging} (DSI) \cite{tuch2002,wedeen2005} e a amostragem generalizada do espaço Q (GQI - \textit{generalized Q-space sampling}) \cite{yeh2010}.  no qual padrões de fibras subjacentes podem ser inferidos. Para diferenciá-los do DTI, neste trabalho chamaremos estes métodos de imageamento de \textbf{métodos HARDI}.

%Uma ODF, no contexto de DWI, consiste em uma função que associa um conjunto de direções a um valor escalar de difusividade. A representação em forma de glifos para ODFs geralmente consistem na plotagem polar esférica (\textit{spherical polar plot}) de uma ODF min-max normalizada no intervalo [0, 1] \cite{TuchQBall2004}, conforme mostrado na Fig. \ref{fig::ex_glifo_hardi}. Chamaremos esta categoria de glifos neste trabalho de \textbf{glifos ODF}. A renderização interativa desses glifos é um ponto principal deste trabalho e os trabalhos de \citeonline{shattuck2008} e \citeonline{peeters2009, almsick2011} trazem diferentes abordagens para este fim.

%\begin{figure}[h]
%   \centering
%       \addtolength{\leftskip} {-2cm} % increase (absolute) value if needed
%    \addtolength{\rightskip}{-2cm}
%
%    %\vspace*{3mm}
%    \centering
%    \includegraphics[width=.35\linewidth, angle=0]{figs/Introducao/SphericalMeshModulation.png}
%   \caption{Plotagem polar esférica de uma ODF e sua versão min-max normalizada. A normalização enfatiza a direção dominante de difusão. As cores representam a direção no espaço da superfície, onde o vermelho representa horizontal; verde, a vertical; e azul a direção normal ao plano da tela.}
%    \label{fig::ex_glifo_hardi}
%\end{figure}

\todo[inline]{Não entendi a parte em magenta ... O texto que adicionei não se conecta com ela. "em uma função" é muito vaga. Pelo menos explicita qual tipo de função ... \textcolor{green}{feito!}}

Os métodos usualmente sintetizam os sinais de difusão locais em uma função de distribuição de orientação (\textit{Orientation Distribution Function}, ODF). Estas funções associam uma direção, representada pelo vetor unitário $\mathbf{\hat{u}}$, a um valor escalar de probabilidade $\psi(\mathbf{\hat{u}})$ representativo de difusão \cite{TuchQBall2004, wedeen2005} ou de fibra \cite{Tournier2004DirectEO, tournier2007}. %O primeiro uso desta categoria de funções é documentado por \citeonline{tuch2002}, que mostra que há uma relação de Fourier tridimensional entre os sinais de difusão para a função de difusão. Adicionalmente, o conteúdo direcional da difusão é obtido através através da integração na coordenada radial da função de difusão.

Em ambas as modalidades de ODF, a informação sobre a distribuição de fibras subjacente é extraída de um conjunto de direções feita através do cômputo dos máximos locais destas funções. Se o cômputo das ODFs são feitos a partir de aquisições com uma relação sinal ruído razoável, as fibras tendem a ser bem modeladas através de seus máximos locais \cite{fillard2011}.

%\textcolor{red}{Foi demonstrado por ??? \cite{???} que, sem pré-condicionar o comportamento de difusão a um modelo matemático, é possível reconstruir uma função de distribuição, também conhecida por função de densidade de probabilidade, de \todo{orientações?}direções de fibras subjacentes às amostras dos sinais escaneados.} 
%\sout{Os métodos definem transformadas que são aplicadas nas amostras dos sinais de difusão em cada \textit{voxel} em uma função, na qual a distribuição de direções de fibra subjacentes podem ser inferidas.} \textcolor{magenta}{A extração geralmente é feita através da detecção de máximos locais \todo{quais?}destas funções, nos quais, se aplicados sobre aquisições com uma relação sinal ruído razoável, tendem a modelar bem \todo{qual distribuição?}}

A partir da extração de direções fibras subjacentes, tem sido possível gerar tractografias mais coerentes com os tratos reais e que levem em consideração mais nuances do sinal de difusão que o DTI, especialmente em regiões que contém as mais diversas configurações de múltiplas de fibras. Entre os trabalhos que trazem evidências da melhoria da tractografia utilizando métodos de alta ordem, temos:

\begin{itemize}
    \item \citeonline{berman2009} evidencia a melhor reconstrução da conectividade do trato motor na presença de tumor;
    \item \citeonline{bucci2013} evidencia um melhor delineamento do trato corticoespinhal utilizando um método de alta ordem em comparação ao DTI, com validação por estimulação cortical;
    \item \citeonline{kuhnt2013} documenta a melhora da tractografia das radiações ópticas em pacientes com glioma.
\end{itemize}
Mesmo com estas evidências, aquisições e métodos de alta ordem não são popularmente utilizadas clinicamente.


%A partir das ODFs, a direção local de fibras em um \textit{voxel} é modelada de forma adequada pela extração de seus máximos locais \cite{fillard2011}, sendo assim a base para algoritmos de tractografia.  %\textcolor{red}{Porém, (comentar o que falta ainda para popularizar o seu uso clínico em relação a DTI) ...}

No uso clínico, o DTI é ainda muito mais utilizado que métodos alta ordem. As vantagens do DTI se referem a sua aquisição, que requer uma quantidade de dados menor, implicando em um menor tempo para ser feita, e a popularidade de aplicativos que processam DWI por este método de imageamento. Adicionalmente, o DTI demanda uma menor quantidade memória para armazenar parâmetros intrínsecos ao seu método comparados aos métodos de alta ordem e, geralmente o cômputo de parâmetros relacionados em diferentes aplicações, como o próprio cômputo do método, renderização de glifos e tractografia, são computacionalmente menos exigentes. Face a estas dificuldades, a comunidade ainda não desenvolveu  um aplicativo que justifique os tempos de aquisição mais longos \cite{descoteaux2015}.

%Falar de tratos que HARDI resolve e DTI não?

%Em tractografia, tanto baseada em DTI, quanto HARDI, há avanços no entendimento de patologias, como esclerose múltipla, mal de Parkinson, esquizofrenia e derrame \cite{SCHILLING2019194}, e mesmo com essas aplicabilidades, há muitos desafios na área.

%Embora os máximos de ODF obtidas através de métodos HARDI consigam resolver os problemas que dizem respeito à estimativa de direções de fibras de forma local, os métodos não inferem sobre a configuração de fibras -- por exemplo, se as diferentes fibras se cruzam ou se "beijam" \cite{SCHILLING2019194}. A busca por informações adicionais para inferir a natureza da configuração entre múltiplas fibras em diferentes regiões é uma oportunidade ainda em aberto.

%%RELER O ARTIGO DO SCHILING E MOSTRAR OPORTUNIDADES 



%\todo[inline]{Sugiro mencionar aqui o artigo de Schilling et al. mostrando os desafios ainda em aberto.}

\section{Motivação e Objetivos}
\label{ssec:motivation}

Motivados pela maior fidelidade na tractografia dos métodos de alta ordem no mapeamento de tratos em comparação aos tratos reais, nosso grupo de pesquisa tem a intenção de desenvolver um sistema de visualização interativa que mapeia ODFs em glifos e um algoritmo de tractografia interativo baseado na distribuição direcional local de fibras, como ilustrado no fluxograma da Fig. \ref{fig::flowchart_vmtk_hardi}.

Possuímos um ambiente de visualização multimodal para volumes médicos, chamado Visual \textit{Manipulation Toolkit for NeuroImages} (VMTK-Neuro) \cite{VMTKNeuro}. O aplicativo renderiza em tempo real volumes de ressonância magnética (\textit{magnetic resonance imaging} - MRI) e possui ferramentas de exploração 3D para volumes DWI a partir do DTI, no qual há as funcionalidades de renderização interativa de glifos superquádricos e a funcionalidade de tractografia (Fig. \ref{fig::intro_ex_DTI}). Usando o ambiente como infraestrutura, consideramos que o próximo passo para pesquisa no DWI leva em consideração a implementação de um método de alta ordem e a exploração de seus dados objetivando o desenvolvimento de algoritmos de reconstrução de fibras.

\begin{figure}[ht]
   \centering
       \addtolength{\leftskip} {-2cm} % increase (absolute) value if needed
    \addtolength{\rightskip}{-2cm}

    %\vspace*{3mm}
    \centering
    \includegraphics[width=.9\linewidth, angle=0]{figs/Introducao/fluxograma_VMTK_HARDI.png}
    \caption{Fluxograma do ambiente de visualização multimodal para método de alta ordem para DWI. Os capítulos \ref{chapter::metodos_hardi} e \ref{chap::renderizacao_interativa_de_perfis_de_difusao} trazem o detalhamento dos blocos destacados em azul.}
    \label{fig::flowchart_vmtk_hardi}
\end{figure}

%\section{Objetivos}
%\label{sec::objetivos}
Baseados no fluxograma da Fig. \ref{fig::flowchart_vmtk_hardi}, podemos esquematizar os passos para visualização de ODFs em glifos e tractografia em:

\begin{enumerate}
    \item a implementação de um método de imageamento de alta ordem para difusão;
    \item a visualização multimodal dos dados que descrevem a difusão através do método em glifos;
    \item Cômputo da distribuição de fibras subjacentes \textit{voxel} a \textit{voxel}; e
    \item implementação de um algoritmo de tractografia
\end{enumerate}


Cumprindo estes objetivos, estaremos aptos a fazer pesquisas na área de tractografia baseadas em métodos de alta ordem, tanto no que diz respeito a contribuição em métodos e algoritmos, quanto em aplicações clínicas. Sobre métodos de tractografia, \citeonline{SCHILLING2019194} menciona os desafios, oportunidades e limitações nesta área de tractografia, e menciona que a próxima evolução em tractografia há de vir a partir do uso de outras fontes de informação, no qual podemos ter futuras conjecturas para investigação em como podemos utilizar dados co-registrados em adição ao DWI para dar passos adicionais nesta área.

% do uso de métodos de alta ordem em tractografia sobre os desafios da área, temos a intenção de dar 

%Todas as implementações e experimentos do trabalho são realizados no aplicativo VMTK-Neuro (\textit{Visual Manipulation ToolKit for Neuroimages}) \cite{VMTKNeuro}, que é um ambiente de visualização exploratória multimodal multi-plataforma desenvolvida e mantida pelo grupo de pesquisa da Faculdade de Engenharia Elétrica e de Computação da UNICAMP ao qual faço parte. O \textit{software} renderiza em tempo real volumes de ressonância magnética (\textit{magnetic resonance imaging} - MRI) e possui ferramentas de exploração 3D para volumes DWI a partir do DTI, no qual há funcionalidade de exploração local a partir de glifos superquádricos e tractografia (Fig. \ref{fig::intro_ex_DTI}). 



%renderiza em tempo real volumes de ressonância magnética (\textit{magnetic resonance imaging} - MRI) e possui ferramentas de exploração 3D para volumes DWI a partir do DTI, no qual há funcionalidade de exploração local a partir de glifos superquádricos e tractografia (Fig. \ref{fig::intro_ex_DTI}).

%\todo[inline]{A motivação não está bem contextualizada, principalmente depois de ler um parágrafo só sobre as vantagens de DTI no uso clínico. Talvez caiba aqui uma referência em que os autores falam sobre desafios para tornar HARDI popular no uso clínico ... que justificaria o seu trabalho.}

%Nosso grupo de pesquisa tem a intenção de fazer um ambiente exploratório para volumes de difusão através de um método de alta ordem. Neste ambiente, \todo{Isso já não é feito com DTI?}\textcolor{magenta}{um especialista tem total liberdade para construção e análise de forma não invasiva de fibras} e para este fim, desenvolveremos um sistema de visualização interativa de perfis de difusão gerados pelo método de imageamento utilizado em glifos e um algoritmo de tractografia interativo, como ilustrado na fluxograma da Fig. \ref{fig::flowchart_vmtk_hardi}.


Diante destes desafios em aberto, este trabalho aborda a implementação de um método de alta ordem, no qual escolhemos a Amostragem Generalizada no Espaço-Q (\textit{Generalized Q-Sampling Imaging}, GQI) para processamento de volumes de difusão e a proposição de um algoritmo para renderização interativa de glifos que sintetizem as funções obtidas através deste método. Este algoritmo é integrado ao ambiente de visualização multimodal desenvolvido e publicado por \citeonline{voltoline2021}.

Os glifos mais comumente utilizados por pesquisadores da área relacionados a ODFs obtidas através de métodos de alta ordem consistem em suas plotagens polares esféricas. Sua visualização interativa, onde estes objetos são renderizados sobre as suas respectivas regiões no volume melhora a qualidade da pesquisa na área \cite{peeters2009}. A partir dos glifos pode-se inferir visualmente sobre os dados do método de imageamento. A partir disto, o desenvolvedor tem um \textit{feedback} sobre o método de alta ordem implementado, bem como a relação entre método de imageamento e cada aquisição DWI particular.

Adicionalmente, conjecturamos que o uso de glifos superquádricos posicionados em seus respectivos \textit{voxels} em um ambiente de exploração interativa pode melhorar o processo de escolha de parâmetros iniciais em tractografia \cite{voltoline2021}, o que também é válido para ODFs mapeadas em glifos, visto que esta categoria de glifos permite a inferência sobre cruzamentos de fibra presentes em ODFs, o que não ocorre com superquádricos, dada a limitação do DTI.



%\textcolor{magenta}{A partir dele, pode-se \todo{Para qê inferir?}inferir visualmente sobre o método de imageamento utilizado quanto a sua adequabilidade para com a aquisição utilizada. Adicionalmente, há evidências que o uso de glifos superquádricos posicionados em seus respectivos \textit{voxels} em um ambiente de exploração interativa pode melhorar o processo de escolha de parâmetros iniciais em tractografia \cite{voltoline2021}, o que também é válido para glifos ODF, visto que, esta categoria de glifos permite o usuário ter a informação de cruzamento de fibras, o que não é presente nos superquádricos pela natureza do DTI.}

%Acerca do algoritmo de tractografia, a interação com um especialista é relevante nos seguintes aspectos: queremos que o usuário tenha a liberdade de escolher os tratos a serem analisados e que ele possa inferir e assegurar a plausabilidade das conexões das amostras de múltiplas orientações que métodos HARDI proveem.

%Acerca da natureza do tipo de interatividade que queremos mostrar, evidentemente que somente informações extraídas de um volume de difusão não assegura a plausabilidade de fibras reconstruídas e é desejável que haja ferramentas de interatividade para com um especialista para que ele possa escolher regiões de análise e verificar a plausabilidade de fibras.

%O conhecimento de tratos a partir de DWIs é escasso e há discrepâncias entre especialistas, não apenas na área de difusão, mas também na literatura anatômica \cite{SCHILLING2019194} e é necessária a análise humana para inferir sobre a plausabilidade do que está sendo reconstruído.





%\todo[inline]{Principal motivação é aprimorar a interatividade no processo de reconstrução de uma fibra? Diante dos desafios ainda em aberto, espera-se que, através de uma visualização interativa dos dados de difusão HARDI devidamente pré-processados, um especialista junto com uma máquina construa de forma mais fiel possível, e não-invasiva, as fibras dos tratos (conhecidos e desconhecidos)?}

%\textcolor{red}{No que diz respeito ao método de síntese de orientações das fibras a partir dos volumes HARDI, integramos a sua formulação matemática diretamente no VMTK-Neuro. Os principais critérios para sua escolha se devem a sua adequabilidade em tractografia, sua aplicabilidade em DWIs de baixa resolução angular e simplicidade em relação a quais métodos???.}

%\todo[inline]{Dentre o estado-da-arte da tecnologia HARDI, qual aspecto te chamou atenção e te motivou a desenvolver este trabalho de Mestrado com o objetivo de "implementar e validar um algoritmo (melhor?) de tractografia baseada na técnica de imageamento HARDI"? Na forma como está colocada a sua proposta leva o leitor questionar se o trabalho é simplesmente um exercício do que já se tem.}

%\textcolor{red}{O conhecimento sobre tratos é ainda precário para reconstruí-los integral e automaticamente. É necessária a análise humana para assegurar a plausibilidade das conexões das amostras de múltiplas orientações que a técnica HARDI provê. Para que um especialista possa ter uma visão sucinta e precisa sobre as informações da difusividade local de uma amostra e ajudar uma máquina tomar decisão na ligação desta amostra com as amostras vizinhas para formar uma fibra, é desejável que ele explore de forma interativa tanto os perfis de difusão em cada amostra como as fibras reconstruídas com base nas conjeturas formuladas e reformuladas.}

%\section{Ambiente de Implementação}
%\label{ssec:ambiente}

%Todas as implementações e experimentos do trabalho são realizados no aplicativo VMTK-Neuro (\textit{Visual Manipulation ToolKit for Neuroimages}) \cite{VMTKNeuro}, que é um ambiente de visualização exploratória multimodal multi-plataforma desenvolvida e mantida pelo grupo de pesquisa da Faculdade de Engenharia Elétrica e de Computação da UNICAMP ao qual faço parte. O \textit{software} renderiza em tempo real volumes de ressonância magnética (\textit{magnetic resonance imaging} - MRI) e possui ferramentas de exploração 3D para volumes DWI a partir do DTI, no qual há funcionalidade de exploração local a partir de glifos superquádricos e tractografia (Fig. \ref{fig::intro_ex_DTI}). 





%Na subseção \ref{ssec:vmtk-neuro} do capítulo Materiais e Métodos, ilustramos as ferramentas para DWI como um fluxograma e descrevemos as funcionalidades correlatas ao presente trabalho.

% conforme mostrado no fluxograma da figura \ref{fig::PipelineDTI_tracto}.%\textcolor{red}{escaneados com o protocolo Overplus \cite{Philips} e de rastreamento das fibras para volumes DTI sintetizados a partir de DWIs}\todo{não necessariamente Overplus. Overplus não sintetiza as sequencias de aquisições de DWI que há por aí.}.

%\begin{figure}[ht]
%   \centering
%       \addtolength{\leftskip} {-2cm} % increase (absolute) value if needed
%    \addtolength{\rightskip}{-2cm}
%
%    %\vspace*{3mm}
%    \centering
%    \includegraphics[width=1.0\linewidth, angle=0]{figs/Fluxogramas/PipelineDTI_tracto.jpg}
%    \caption{Fluxograma para tractografia implementado no VMTK-Neuro.}
%    \label{fig::PipelineDTI_tracto}
%\end{figure}

%Estas ferramentas consistem na visualização em tempo interativo de tensores de difusão mapeados em glifos superquádricos \cite{Kindlmann2004} renderizados sobre as suas respectivas amostras (figura \ref{fig::intro_ex_DTI_glifos}), tractografia (figura \ref{fig::intro_ex_DTI_tractografia}) e o corregistro de volumes de difusão com volumes anatômicos T1.

%Na tractografia baseada em DTI, o VMTK-Neuro possui ferramentas de interatividade que possibilitam que o usuário possa inferir sobre as regiões do volume que contém os tratos a serem analisados, bem como filtrar fibras de interesse e eliminar fibras espúrias. Adicionalmente, parâmetros relacionados a reconstrução, que podem diferir de acordo com a região de análise do usuário, também são configuráveis. O algoritmo de tractografia apresenta resultados visuais em tempo interativo para as formas de interação mencionadas.


\todo[inline]{Acho que não foi revisado este capítulo ... Vou parar de ler ... \textcolor{green}{Escrito}}



%\sout{As ferramentas de visualização} O ambiente de visualização multimodal, que integra diferentes modalidades de neuroimagens, incluindo a ressonância de difusão modelada pelo DTI, de forma co-registrada, e, adicionalmente um algoritmo de tractografia interativo, baseado em \citeonline{Weinstein1999}.

%\todo{Motivação?}\textcolor{magenta}{Motivados} pela pesquisa que evidenciam as vantagens da tractografia baseadas em métodos mais avançados em aquisições de alta resolução angular, temos a intenção de fazer a visualização multimodal com DWIs através de algum.




%Adicionalmente, temos a conjectura que os glifos possam ser utilizados para detectar anormalidades nas neuroimagens, bem como servir de suporte visual para escolha de parâmetros iniciais em tractografia, conforme evidenciado em \citeonline{voltoline2021} para superquádricos do DTI.





\section{Contribuição}
\label{sec:contribuicoes}

A contribuição esperada para o presente trabalho dentro do escopo do ambiente exploratório para DWI através de métodos avançados de imageamento é a implementação de um método avançado para difusão, no qual escolhemos a amostragem generalizada no espaço-Q (\textit{Generalized Q-Space Imaging}, GQI) \cite{yeh2010} e a proposição e validação de um algoritmo de renderização interativo de glifos que sintetizem as ODFs geradas pelo método integrado ao ambiente de visualização exploratória multimodal interativo.



%\textcolor{red}{A expectativa é aplicar os resultados na implementação do fluxograma mostrado na Figura ??? no VMTK-Neuro ...}



%\todo[inline]{Sugiro que mostre em algum ponto uma visão geral do fluxo de controle da sua proposta de construção de tractografia a partir de DWIs de alta resolução angular.}

\section{Desafios}
\label{sec::desafios}

Para implementação do sistema, muito da infraestrutura necessária para alcançar os objetivos estabelecidos estão implementadas no VMTK-Neuro para visualização de volumes DWI por DTI. Portanto, muitos dos desafios enfrentados dizem respeito a complexidade matemática e a questões de implementação do método alta ordem e seu esquema de visualização em glifos.

A própria implementação computacional de um método de alta ordem para sintetizar o perfil de difusão é uma tarefa desafiadora. Os métodos demandam uma quantidade de memória da CPU razoavelmente maior que o DTI. Enquanto o DTI é codificado na memória com apenas seis elementos por \textit{voxel} (matriz 3x3 simétrica), métodos de alta ordem usam dezenas ou centenas de elementos. %Métodos de alta ordem não estabelecem um critério mínimo, entretanto é usual que centenas de elementos sejam utilizados para descreverem o perfil de difusão de forma razoável.

A implementação de um algoritmo de renderização de ODFs em tempo interativo é algo desafiador pela grande quantidade de dados necessários para sintetizar um glifo. Além disso, o algoritmo de renderização é integrado ao pipeline da renderização multimodal volumétrica baseada em \textit{ray-casting} de volumes de ressonância magnética, o que diminui ainda a sua margem de tempo de execução para manutenção da interatividade.


\section{Organização}
\label{sec:intro_organizacao}

O trabalho está organizado em cinco capítulos. No Capítulo \ref{chapter::metodos_hardi}, descreveremos brevemente sobre as aquisições DWI, a motivação para utilização de métodos de alta ordem para modelar a difusão, detalharemos a implementação do método GQI, tanto no que diz respeito a sua formulação matemática, como a sua implementação computacional; no Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao} detalhamos o algoritmo interativo de renderização para glifos que sintetizam ODFs integrado ao VMTK-Neuro atrelado a renderização de um volume \textit{ray-casted}; no Capítulo \ref{sec::experimentos}, mostramos os experimentos que validam visualmente o algoritmo proposto e a sua performance computacional integrada ao VMTK-Neuro, adicionalmente detalhamos de forma cronológica os recursos explorados para atingir a interatividade do algoritmo de renderização, bem como os ganhos proporcionados por cada um deles; no Capítulo \ref{chap::conclusao}, concluímos o trabalho e mencionamos oportunidades de trabalhos futuros.


%\chapter{Materiais e Métodos}

%\section{Materiais}






%\subsection{VMTK-Neuro}
%\label{ssec:vmtk-neuro}

%O VMTK-Neuro é um \textit{software} que renderiza em tempo real volumes de ressonância magnética (\textit{magnetic resonance imaging} - MRI) e possui ferramentas de exploração para volumes DWI a partir do DTI, conforme mostrado no fluxograma da figura \ref{fig::PipelineDTI_tracto}. O software utiliza a linguagem de programação em C++ e o OpenGL como API gráfica.

%\begin{figure}[ht]
%   \centering
%       \addtolength{\leftskip} {-2cm} % increase (absolute) value if needed
%    \addtolength{\rightskip}{-2cm}
%
%    %\vspace*{3mm}
%    \centering
%    \includegraphics[width=1.0\linewidth, angle=0]{figs/Fluxogramas/PipelineDTI_tracto.jpg}
%    \caption{Fluxograma para tractografia e glifos implementado no VMTK-Neuro.}
%    \label{fig::PipelineDTI_tracto}
%\end{figure}

%Estas ferramentas consistem na visualização em tempo interativo de tensores de difusão mapeados em glifos superquádricos \cite{Kindlmann2004} renderizados sobre as suas respectivas amostras (figura \ref{fig::intro_ex_DTI_glifos}), tractografia (figura \ref{fig::intro_ex_DTI_tractografia}) e o corregistro \cite{ting2014} de volumes de difusão com volumes anatômicos T1 .



%Na tractografia baseada em DTI, o VMTK-Neuro possui ferramentas de interatividade que possibilitam que o usuário possa inferir sobre as regiões do volume que contém os tratos a serem analisados, bem como filtrar fibras de interesse e eliminar fibras espúrias. Adicionalmente, parâmetros relacionados a reconstrução, que podem diferir de acordo com a região de análise do usuário, também são configuráveis. O algoritmo de tractografia apresenta resultados visuais em tempo interativo para as formas de interação mencionadas.


%\subsection{Volumes}

%%%%%VOLUMES UTILIZADOS NOS EXPERIMENTOS


%Temos a intenção de fazer a investigação com dados reais de pacientes do Hospital das Clínicas da UNICAMP, cujo uso foi aprovado pelo comitê de ética CAAE 0893.0.146-000.09, 


%No decorrer do trabalho tínhamos a intenção de usar o volumes do bancos de dados do Hospital das Clínicas da UNICAMP, porém os resultados preliminares em termos de conjuntos de ODFs obtidos não se mostraram adequados, e descartamos o uso. Fizemos um estudo para diagnosticar a natureza do problema, que está detalhado na subseção \ref{ssec::problema_overplus} do apêndice, e concluímos que está relacionado ao conjunto de gradientes de ponderação de difusão utilizado no padrão \textit{Overplus}.


%\section{Métodos}
%\subsection{Interatividade}

%Pela demanda de visualização interativa do VMTK-Neuro, objetivamos que a visualização dos perfis de difusão de glifos ODF para as amostras visíveis na tela aconteça em tempo interativo. Sendo assim, documentaremos os \textit{benchmarks} de ambos sistemas para atestar o cumprimento deste objetivo.

%\subsection{Tractografia}

%A motivação principal desde trabalho nasceu da seguinte pergunta: "como podemos melhorar a tractografia baseada em DTI do VMTK-Neuro?". Neste contexto, iremos comparar a tractografia baseada em DTI implementada no VMTK-Neuro e a tractografia baseada em HARDI em tratos que há a documentação de falhas do DTI e que são resolvidos pela abordagem que utiliza métodos HARDI.

\todo[inline]{É melhor conversar com o Raphael sobre o uso das imagens da dissertação dele. \textcolor{green}{Falei e ele me autorizou}}


%\textcolor{red}{
\chapter{Imageamento de Difusão Intravoxel}
%\chapter{Imageamento de alta resolução angular para difusão}
\label{chapter::metodos_hardi}
%}

Nesta seção, trazemos a formulação do conceito de função de distribuição de orientação (\textit{orientation distribution function}, ODF), que é a base para as discussões do capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao}, em que detalhamos um esquema de renderização para visualização dos perfis de difusão obtidos através do imageamento cerebral. Para que a dissertação seja auto-contida, faremos uma introdução às técnicas de aquisição DWI e aos métodos de síntese de orientações de difusão a partir dos sinais amostrados. Detalharemos o método de reconstrução GQI (\textit{Generalized Q-Sampling Imaging}) que aplicamos neste trabalho de Mestrado.

Na Seção \ref{sec::aquisicao_dwi}, faremos uma breve descrição da sequência de aquisição de um DWI, no que diz respeito as grandezas envolvidas e parâmetros associados, mas sem entrar nos detalhes da física do processo. Na Seção \ref{sec::dti_limitacoes_hardi}, trazemos uma descrição breve do DTI, suas limitações e a motivação do uso de métodos de mais alta ordem e aquisições de resolução, na Seção \ref{metodos_de_alta_ordem} fazemos uma introdução aos métodos de alta ordem e \todo{Falta uma descrição breve da seção de técnicas de ordem maior\\ \textcolor{green}{feito!}} e na Seção \ref{sec::gqi}, descrevemos o principio do método da amostragem generalizada no espaço-Q, no qual mostramos a base teórica, sintetizamos uma transformada que leva os sinais de difusão para amostras que representam o comportamento de difusão subjacente através de uma multiplicação matricial e formulamos o domínio de amostragem da transformada. \todo{Não é a sua proposta? Cap. 3?}%\sout{e adicionalmente, visando otimizar o uso de memória, exploramos a simetria do comportamento de difusão para diminuir a quantidade de amostras associadas ao domínio armazenadas.}

\section{Aquisição DWI}
\label{sec::aquisicao_dwi}
A sequência de pulsos \textit{Pulsed Gradient Spin Echo}  (PGSE) é comumente utilizada para inserir a componente de difusão molecular no sinal de MRI, e é normalmente combinada à sequência  EPI (\textit{Echo-Planar Imaging}) de aquisição de MRI. Uma introdução ao assunto pode ser encontrada em \citeonline{DTI_Handbook} e \citeonline{mori2013}. Os fundamentos de imageamento por MRI e sequências de pulsos do EPI podem ser encontrados em \citeonline{liang2000}, e a física da difusão e seu imageamento via PGSE, em \citeonline{tuch2002}. Nesta seção, faremos uma introdução às grandezas envolvidas na aquisição que usaremos para derivação do GQI na Seção \ref{sec::gqi}.

Fig. \ref{fig::pgse_ilustrado} ilustra o processo de medição de um sinal ponderado por difusão, no qual dois gradientes de ponderação de difusão são aplicados em uma direção $\mathbf{\hat{q}}$ no eixo horizontal e amplitude $G$. Antes da aplicação do gradiente (período $t_1$), os núcleos de hidrogênios tem seus respectivos \textit{spins} em fase, oscilando na mesma frequência, chamada de frequência de Larmour $f = \gamma \cdot B_0$, onde $\gamma$ é a razão giromagnética do núcleo de hidrogênio e $B_0$ é a magnitude do campo magnético estático principal que excita os \textit{spins} na sequência EPI. O sinal gerado é forte com frequência $f$.

\begin{figure}[ht]

%\subfigcapskip = -5pt
    \centering
    \includegraphics[width=.8\linewidth, angle=0]{figs/HARDI/pgse2.png}
    \caption{Ilustração da medição de difusão das moléculas de água realizada na aquisições DWI nos \textit{scanners} de MRI \\
    Fonte: \cite{voltoline2016}
    }
    \label{fig::pgse_ilustrado}
   \hspace{1pt}
\end{figure}

Em $t_2$, o gradiente de intensidade $G$ em um intervalo de tempo $\delta$ é aplicado. O gradiente é um campo magnético que varia linearmente ao longo da direção $\mathbf{\hat{q}}$ e modifica a frequência de oscilação dos \textit{spins} do núcleo hidrogênio. Quando o gradiente cessa $(t_3)$, os núcleos voltam a ter a mesma frequência de oscilação do período $t_1$, mas com fases diferentes, levando a intensidade do sinal ser enfraquecida.

Depois de um intervalo de tempo $\Delta$ a partir do início da aplicação do primeiro gradiente, o processo de equalizar as fases é inicializado ($t_4$) utilizando um novo gradiente com mesma intensidade e duração, mas com sentido oposto em relação ao primeiro. Os núcleos pertencentes às moléculas que se difundiram na direção durante o intervalo de tempo $\Delta$, destacados em verde na janela de tempo $t_3$, terão suas fases corrigidas de forma a não ter a fase inicial novamente, pois estavam em lugares diferentes no espaço, consequentemente estando sob campos magnéticos diferentes nos instantes de defasagem e equalização de fase. Depois de um intervalo de refasagem, $\delta$, a intensidade do gradiente volta a ser balanceada em $t_5$.
O sinal resultante em $t_5$ é atenuado em relação ao sinal ao intervalo $t_1$ (que está tracejado no instante $t_5$), devido a diferença de fase dos \textit{spins}. Consequentemente, diz-se que o sinal está ponderado em difusão.

Em $t_3$, perceba a movimentação dos núcleos em direção perpendicular ao gradiente de difusão, ilustrado pelas moléculas no retângulo com contorno vermelho. A difusão que ocorre de forma perpendicular à $\mathbf{\hat{q}}$ e não afeta o sinal gerado em $t_5$, pois a refasagem restaura a mesma fase das moléculas que não se difundiram. Esta ilustração mostra que a atenuação do sinal gerada se deve à projeção da direção da difusão em $\mathbf{\hat{q}}$. Assim, há a necessidade de gerar os sinais ponderados em difusão para outras direções para que a modelagem do processo possa ser mais precisa.

A atenuação da ponderação por difusão pode ser configurada através da manipulação dos parâmetros de aquisição  $G$,  $\delta$ e $\Delta$. Para sequência PGSE, é comum estas grandezas serem sintetizadas em um fator de ponderação de difusão chamado de valor $b$, que é usualmente expresso em $s/mm^2$. Sua formulação em função dos parâmetros de difusão é dada por \cite{DTI_Handbook}:

%\textcolor{green}{ defini como "um intervalo de tempo $\delta$"}

\begin{equation}
\label{eq::bvalue}
    b = \gamma^2G^2\delta^2(\Delta - \frac{\delta}{3}).
\end{equation}

Nesta dissertação, usaremos o termo \textsf{volume} ~para referenciar uma imagem 3D composta por imagens 2D e o termo \textsf{fatia} para referenciar estas imagens 2D. Será usado também o termo \textsf{aquisição DWI} quando quisermos referenciar, de uma vez, o conjunto de volumes escaneados numa sessão de aquisição. Nós adotamos o termo \textsf{b0}  para referenciar volumes não-ponderados em difusão em uma aquisição DWI.



A respeito da atenuação gerada pelo gradiente de difusão, uma abordagem simplista no que diz respeito ao cômputo em relação ao sinal não ponderado de difusão, contido no volume $b0$ é dado pela equação de Stejskal-Tanner \cite{DTI_Handbook}:

\begin{equation}
\label{eq::stanner}
    S(b) = S_0\exp{(-bD)}
\end{equation}
onde $S_0$ é o sinal de difusão sem ponderação, contido no volume b0, S(b) é o sinal de difusão atenuado e $D$ é o coeficiente de difusão aparente (\textit{Apparent Diffusion Coefficient}, ADC), que mensura a quantidade de difusão na direção do gradiente associado ao valor $b$. Observe que o valor $b$ abstrai em um coeficiente os parâmetros de difusão no cômputo da difusão aparente. Esta relação, que não leva em consideração a direção, é válida em difusão livre (Fig. \ref{fig::intro_difusao_isotropica}). Para ambientes em que o ADC depende da orientação $\mathbf{\hat{g}}$ (Fig. \ref{fig::intro_difusao_anisotropica}), é necessária a sua extensão para um ADC$(\mathbf{\hat{g}})$.

\todo[inline]{\textcolor{green}{Adicionei este parágrafo pois acho importante frisar que esta sequência não é única e há outras com mais vantagens, mas que fogem do escopo do trabalho}}

Nesta seção introduzimos as grandezas relacionadas à medição de difusão através da ressonância magnética, e os apresentamos como uma sequência de pulsos de imageamento que promovem uma sequência de defasagem e refasagem, utilizando dois gradientes em sentidos opostos. Há outras sequências que apresentam vantagens em relação a abordagem apresentada, que podem ser encontradas em \citeonline{mori2013}.

\section{Síntese de Direções Intra \textit{Voxels}}

Nesta seção, abordaremos de forma introdutória os métodos de imageamento para modelagem de difusão. Na Seção \ref{sec::dti_limitacoes_hardi}, mencionamos brevemente o imageamento por tensor de difusão (\textit{diffusion tensor imaging}, DTI) e suas limitações, na Seção \ref{metodos_de_alta_ordem}, fazemos uma introdução aos métodos de alta ordem, nos quais categorizamos os métodos em técnicas de misturas e métodos livres de modelo dentre os quais, situamos o GQI; na Seção \ref{sec::gqi}, apresentamos o método GQI.

\todo[inline]{É mais estilo ... Não vale a pena de dar uma breve introdução em vez de deixar uma seção vazia? Algo como ``Distinguem-se duas classes de técnicas de reconstrução das direções das fibras intravóxeis a partir dos sinais dos volumes DWI: tensores de difusão de ordem 2 e de alta ordem ... Nesta seção vamos apresentar brevemente as técnicas representativas de cada classe.'' \textcolor{green}{Feito!}}



\subsection{DTI}
%\section{DTI e limitações}
\label{sec::dti_limitacoes_hardi}

\citeonline{Basser1994} propõem o imageamento por tensor de difusão (DTI), que visa modelar o decaimento do sinal de difusão a partir de um modelo Gaussiano: 
\begin{equation}
\label{eq::dti_model}
    S(\mathbf{\hat{g}}, b) = S_0\exp{(-b\mathbf{\hat{g}^T}\mathbf{D}\mathbf{\hat{g}})}, 
\end{equation}
no qual podemos sintetizar o modelo pelo tensor de difusão $\mathbf{D}$ de ordem 2 e representá-lo por uma matriz 3x3 simétrica:

\begin{equation}
\label{eq::tensor}
\mathbf{D} = 
\begin{bmatrix}
D_{xx} & D_{xy} & D_{xz} \\ 
D_{xy} & D_{yy} & D_{yz} \\ 
D_{xz} & D_{yz} & D_{zz}  
\end{bmatrix}
\end{equation}
e o coeficiente de difusão aparente de difusão $D(\mathbf{\hat{g}})$ é modelado por:

\begin{equation}
\label{eq::dti_model_adc}
    D(\mathbf{\hat{g}}) = \mathbf{\hat{g}^T}\mathbf{D}\mathbf{\hat{g}}.
\end{equation}
%e o decaimento da difusão, derivado da Eq. \ref{eq::stanner}, se torna uma função dada por:

Observe que para cômputo do modelo, o DTI precisa de pelo menos seis volumes de difusão e um $b0$, para resolver o sistema de equações de seis incógnitas do tensor de difusão a partir do ADC $D(\mathbf{\hat{g}})$, onde $\mathbf{\hat{g}} = [g_x, g_y, g_z]^T$, mostrado na Eq. \ref{eq::sistema_dti}:

\begin{equation}
\label{eq::sistema_dti}
\frac{1}{b}\ln{\frac{S_0}{S(\mathbf{\hat{g}})}}=D_{x x} g_{x}^{2} +D_{y y} g_{y}^{2}+D_{z z} g_{z}^{2}+2 D_{x y} g_{x} g_{y} +2 D_{x z} g_{x} g_{z}+2 D_{y z} g_{y} g_{z}
\end{equation}
onde o termo à esquerda é o cômputo do coeficiente aparente de difusão para o sinal $S(\mathbf{\hat{g}})$, derivado da Eq. \ref{eq::stanner} e à direita, expandimos a operação mostrada na Eq. \ref{eq::dti_model_adc}. Na prática, as aquisições DTI tem entre 6 e 32 volumes ponderados por difusão e um volume b0 \cite{descoteaux2015}. 

Usualmente, a informação referente ao processo de difusão é extraída dos três autovetores e autovalores da matriz $\mathbf{D}$ (Eq. \ref{eq::tensor}), onde a direção da fibra é usualmente paralela a direção do autovetor associado ao maior autovalor.
Porém, o DTI apresenta limitações, que se devem ao próprio modelo Gaussiano utilizado.

O modelo descreve bem regiões de fibras em que o comportamento de difusão ocorre predominantemente em uma direção. Em pontos que contém múltiplas fibras e que estão dispostas nas mais variadas configurações (por exemplo: cruzamento, bifurcação, fusão, espalhamento, "beijo") o modelo Gaussiano não sintetiza de forma correta o comportamento da difusão, impedindo o cômputo das direções plausíveis para reconstrução de uma fibra de interesse \cite{fillard2011, daducci2014}. Há um estimativa de que entre 66\% a 90\% da substância branca do cérebro contém múltiplas configurações de cruzamento de fibra \cite{descoteaux2015} e a limitação do DTI é um obstáculo para modelar as direções de fibras subjacentes de forma adequada dentro de um \textit{voxel}.

\subsection{Métodos de alta ordem}
\label{metodos_de_alta_ordem}

Devido às limitações do DTI para inferir sobre a substância branca do cérebro na resolução de cruzamento de fibras, houve uma agenda de pesquisa que começa no início da década de 2000 para distinguir múltiplas orientações numa amostra, e consequentemente houve uma demanda por mais amostras de sinais de difusão por \textit{voxel} nas aquisições DWI. %denominadas de imageamento difusão de alta resolução angular para difusão (HARDI - \textit{high angular resolution diffusion imaging}). Tipicamente aquisições HARDI \textit{single-shell} contém 45 volumes ponderados por e $1000 \leq b \leq 4500$ $s/mm^2$.

Houve mais de cem artigos que propuseram métodos de imageamento para transformação do sinal de difusão para o seu perfil de densidade de probabilidade de direções de difusão de fibras entre 2000-2010 \cite{descoteaux2015}. Os métodos consistem essencialmente na síntese do sinal de difusão em funções de distribuição de orientações (ODF) que dão a possibilidade de inferir sobre a distribuição de fibras subjacentes. Uma ODF consiste em uma associação entre um conjunto de direções, usualmente representadas por um vetor unitário $\mathbf{\hat{u}}$ (ou par $(\theta, \phi)$ em coordenadas esféricas), em um valor escalar $\psi(\mathbf{\hat{u}})$, representativo da probabilidade de difusividade em $\mathbf{\hat{u}}$. Em geral, estes métodos podem ser categorizados de duas formas de acordo com a natureza da técnica de transformada do sinal de difusão para a ODF: técnicas de misturas (\textit{mixture models techniques}) e técnicas livres de modelo, que abrange o GQI.

Estes métodos requerem uma quantidade maior de volumes ponderados por difusão em um DWI, além de maiores valores $b$. Tipicamente, a quantidade de gradientes de ponderação por difusão é acima de 45, e $1000 \leq b \leq 4500s/mm^2$ \cite{descoteaux2015}. Comumente, aquisições DWI possuem um valor $b$ fixo para os volumes ponderados por difusão. Estas aquisições são chamadas de \textit{single-shell} porque suas amostras estão contidas em uma esfera no espaço-Q (Seção \ref{metodos_livres_de_modelo}). Aquisições \textit{single-shell} adequadas para métodos de alta ordem são chamadas de imagem de difusão de alta resolução angular (\textit{High Angular Resolution Diffusion Imaging, HARDI}).

Em adição às aquisições HARDI \textit{single-shell}, há mais duas que valem mencionar: aquisições HARDI \textit{multi-shell}, no qual as aquisições são feitas para múltiplos valores $b$, tipicamente dois ou três, que são exemplificados no banco de dados do projeto Connectomme \cite{essen2012} e a aquisição cartesiana no Espaço-Q, que normalmente é associada ao método \textit{Diffusion Spectrum Imaging}, e é inviável clinicamente (Seção \ref{metodos_livres_de_modelo}). \citeonline{cheng2018} discutem e formulam aquisições \textit{single-shell} e \textit{multi-shell} HARDI.


\subsubsection{Técnicas de misturas}

Técnicas de misturas assumem que o sinal de difusão medido para um \textit{voxel} é a soma dos sinais gerados por cada população de fibra presente nele \cite{tournier2011}. Como exemplos, há a abordagem multi-tensor, também presente na tese de doutorado de \citeonline{tuch2002}, e a abordagem por deconvolução esférica, proposta originalmente por \citeonline{Tournier2004DirectEO}.

A abordagem multi-tensor modela a difusão como uma soma ponderada de modelos Gaussianos, com diferentes tensores associados a cada um. Enquanto na abordagem por deconvolução esférica, parte-se da premissa de que o sinal de difusão é gerado a partir da resposta da fibra ao gradiente de ponderação de difusão e este fenômeno é representado por uma convolução da função de distribuição de orientação de fibras (\textit{fiber orientation distribution function}, fODF) por uma função resposta para uma fibra única. Assim, a fODF é reconstruída a partir de uma técnica de deconvolução. O aplicativo MRTrix\footnote{Disponível em: https://www.mrtrix.org/} utiliza a abordagem \textit{constrained spherical deconvolution} \cite{tournier2007} para sintetizar o sinal de difusão em uma fODF.

\subsubsection{Métodos livres de modelo}
\label{metodos_livres_de_modelo}

Nos métodos livres de modelo, os sinais de difusão são modeladas como amostras no espaço-Q em coordenadas tridimensionais $\mathbf{q}$. Os sinais de difusão $W(\mathbf{r}, \mathbf{q})$ no \textit{voxel} $\mathbf{r}$ são amostrados no ponto representado por\footnote{\citeonline{tuch2002} representa esta relação por $\mathbf{q} = (\gamma G \delta)\cdot \mathbf{\hat{q}}$} \cite{yeh2010}:

\begin{equation}
    \label{eq::ting}
    \mathbf{q} = \frac{\gamma G \delta}{2\pi} \cdot \mathbf{\hat{q}},
\end{equation}
onde $\mathbf{\hat{q}} = \mathbf{q}/|\mathbf{q}|$ é a direção do gradiente de ponderação de difusão, $\gamma$ é a razão giromagnética do núcleo de hidrogênio $G$ e $\delta$ são parâmetros do PGSE (Fig. \ref{fig::pgse_ilustrado}). Substituindo a Eq. \ref{eq::bvalue} na Eq. \ref{eq::ting} e definindo $\lambda = \Delta - \delta/3$, chegamos a uma relação em que mostra a amostragem $\mathbf{q}$ como função dos valores $b$:

\begin{equation}
\label{eq::qspace_bvalue}
\mathbf{q} = \frac{1}{2\pi}\sqrt{\frac{b}{\lambda}} \mathbf{\hat{q}}.
\end{equation}

A partir dessas amostras, métodos de imageamento, como o \textit{Diffusion Spectrum Imaging} (DSI) \cite{wedeen2005}, \textit{Q-Ball Imaging} \cite{TuchQBall2004} e GQI \cite{yeh2010}, são utilizados para inferir sobre o perfil de difusão, ou a distribuição de probabilidade direcional de fibras \textit{voxel} a \textit{voxel}, fazendo uso da relação de Fourier entre o $W_{\Delta}(\mathbf{r}, \mathbf{q})$ e o propagador de difusão $\bar{p}_{\Delta}(\mathbf{r}, \mathbf{u})$, onde $\Delta$ é constante e corresponde à duração de difusão (Fig. \ref{fig::pgse_ilustrado}). O propagador de difusão é uma função que gera a probabilidade de deslocamento $\mathbf{u}$ durante o tempo de difusão $t = \Delta$. A relação entre ambas pode ser expressa pela equação \cite{tuch2002}
%está ilustrada na Eq. \ref{eq::propagator}.

%O propagador de difusão $p(\mathbf{r}, \mathbf{u})$ é uma função que gera a probabilidade de deslocamento $\mathbf{u}$ durante um tempo de difusão $t$:

%\todo[inline]{Explique o operador $\mathfrak{F}^{-1}$.}
\begin{equation}
\label{eq::propagator}
    \bar{p}_{\Delta}(\mathbf{r}, \mathbf{u}) =\frac{1}{W_{\Delta}(\mathbf{r},\mathbf{0}) } \int W_{\Delta}(\mathbf{r},\mathbf{q}) e^{-i2 \pi \mathbf{q} \cdot \mathbf{u}} d \mathbf{q} ,
\end{equation}
onde $W_{\Delta}(\mathbf{r},\mathbf{0})$ certifica que $\bar{p}_{\Delta}(\mathbf{r}, \mathbf{u})$ é uma função de densidade de probabilidade.

% \begin{equation}
% \int_{\mathbf{q} \in Q} W(\mathbf{q}, t) \exp (i2 \pi \mathbf{q} \cdot \mathbf{u}) d \mathbf{q}
% \end{equation}



A partir do propagador de difusão, a função de distribuição de orientação de difusão (\textit{Diffusion Orientation Distribution Function}, dODF) $\Psi(\mathbf{\hat{u}})$ para a direção $\mathbf{\hat{u}}$, onde $|\mathbf{\hat{u}}| = 1$,  nos permite sintetizar a distribuição de fibras subjacente. Sua relação com o propagador de difusão é dada por \cite{tuch2002}
\begin{equation}
\label{eq::dodf_propagador}
\Psi(\mathbf{\mathbf{r},\hat{u}})=\int_{0}^{\infty} \bar{p}_{\Delta}(\mathbf{r}, \rho  \mathbf{\hat{u}}) \rho^2 \mathrm{~d}\rho
\end{equation}

%\todo[inline]{Sugiro que insira no parágrafo abaixo o que conversamos: DSI faz aquisições diretas do espectro médio dos deslocamento de \textit{spins} amostrados em intervalos regulares de direções $\mathbf{u}$ e de ponderações em difusão $b$ no espaço-Q,  e faz uso das Eqs. \ref{eq::qspace_bvalue} e \ref{eq::dodf_propagador} para recuperar (diretamente) os sinais no espaço $R^3$ via transformadas inversas de Fourier. Requer multiplos valores b e múltiplos gradientes. E dar uma ideia em que consistem as aquisições menos demandantes, porém equivalentes, entre as quais estão GQI que você vai detalhar na próxima seção. \textcolor{green}{Feito}}

O DSI \cite{wedeen2005} faz o mapeamento mostrado nas Eq. \ref{eq::propagator} e \ref{eq::dodf_propagador} e demanda por uma aquisição com muitos volumes de difusão. A amostragem no espaço-Q para este método são tipicamente uniformemente espaçada nas três dimensões e necessitam de muitos volumes ponderados por difusão (515 volumes \cite{wedeen2005}) e gradientes de ponderação de difusão fortes ($0 \leq b \leq 17000 s/mm^2$), o que é demandado no cômputo da transformada discreta de Fourier 3D. Devido a isto, outros métodos surgem com o objetivo derivar transformações para dODFs com uma menor demanda na quantidade de volumes ponderados por difusão adquiridos, e adequados para aquisições HARDI. O \textit{Q-Ball Imaging} é o primeiro deles, no qual \citeonline{TuchQBall2004} mostra que em uma aquisição HARDI \textit{single shell}, é possível obter uma versão suavizada da dODF do DSI aplicando a transformada de Funk-Radon em uma esfera no Espaço-Q que contém o sinal de difusão.

%O \textit{Q-Ball Imaging} \cite{TuchQBall2004} é um destes métodos e o primeiro a ser proposto após o DSI. \citeonline{TuchQBall2004} prova que a uma versão suavizada da dODF pode ser computada através da Transformada de Funk-Radon aplicada em uma esfera no espaço-Q. Este método é implementado na biblioteca FSL\footnote{Disponível em: https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FSL}.


Neste trabalho, escolhemos o método de modelo livre GQI para reconstruir ODFs a partir dos esquemas de aquisição de alta resolução angular pelas seguintes características \cite{yeh2010}:

\begin{enumerate}
    \item ser aplicável em categorias de aquisição com múltiplos valores $b$;
    \item bom desempenho em volumes de mais baixa resolução angular;
    \item ter parâmetros de regularização e filtragem integrados ao método, o que é necessário para o cômputo das informações direcionais das fibras subjacentes.
\end{enumerate}

Há uma desvantagem na representação em memória do GQI. Os dados gerados pelo método são representados como amostras de função, e podem potencialmente ocupar muito espaço na memória. Há métodos que codificam os dados como coeficientes de uma soma ponderada de funções base \cite{descoteaux2007_QBI, Tournier2004DirectEO, tournier2007} que usualmente demandam menos memória.

Um ponto importante no processo de escolha é referente à adequabilidade em tractografia. No seu trabalho sobre comparações de diferentes métodos de imageamento em tractografia, \citeonline{daducci2014} concluíram que não há métodos que se sobressaem em relação a outros nas mais diferentes condições experimentais.



%O DSI \cite{wedeen2005} - proposto originalmente em 2000 - explora e sintetiza uma função de orientação de orientação de através da relação de Fourier entre o sinal de difusão no espaço-Q e a aquisição

















%consiste em um mapeamento das amostras de difusão em um ponto contido em uma aquisição DWI em um modelo gaussiano, que é sintetizada por tensor de ordem 2, representado por uma matriz 3x3 simétrica (Eq. \ref{eq::tensor}). Para seu cômputo, o DTI necessita de no mínimo seis volumes ponderados por difusão em adição a um $b0$, nos quais geram um sistema para cômputo dos seis coeficientes do tensor. Na prática, os volumes DWI escaneados para serem usados com este método, que é predominante no uso clínico, varia entre 6 e 32 \cite{descoteaux2015}.




%Entretanto, o método apresenta limitações \textcolor{red}{como já destacado na seção \ref{sec:introducao}.}



%e o termo \textsf{resolução angular} \sout{com} \textcolor{red}{à} quantidade de volumes ponderados por difusão em uma aquisição DWI. 

%\todo[inline]{DTI assume que a função densidade de probabilidade é Gaussiana enquanto a representação no espaço q (Q-space imaging) não faz nenhuma suposição quanto a um modelo para a função densidade de probabilidade. As funções de difusão no espaço Q são adquiridas diretamente através da amostragem dos sinais de difusão num reticulado cartesiano 3D. Amostragens sobre calotas esféricas (\textit{spherical shell}) são conhecidas como HARDI. É mostrado que HARDI pode ser transformado em Q-ball imaging, também sem condicionamento a um modelo. Veja \cite{TuchQBall2004}. As explicações que se seguem estão confusas. Parece que você colocou num pacote QSI e HARDI/QBI.}



% \textcolor{magenta}{
% A respeito dos valores $b$ utilizados em uma aquisição DWI, e como utilizá-los no espaço-Q, há normalmente três estratégias de amostragens para a aquisição:
% \begin{enumerate}
%     \item amostragem cartesiana, onde as amostras são igualmente espaçadas no espaço-Q em um espaço cartesiano tridimensional e que é usualmente associado ao imageamento de espectro por difusão (DSI) \cite{wedeen2005};
%     \item amostragem \textit{single-shell}, que consiste na amostragem feita para um valor b constante, que está contido numa esfera no espaço-Q;
%     \item amostragem \textit{multi-shell}, que consiste na amostragem que consiste em diferentes conjuntos de pontos contidos em mais de uma esfera, que se referem a uma quantidade no espaço-Q.
% \end{enumerate}
% }



%!! ILUSTRAR SINGLESHELL- MULTISHELL  e CARTESIANA!!

%Dado um conjunto de amostras de sinais de difusão no espaço-Q, há diversas técnicas para descrever o processo de difusão \textit{voxel} a \textit{voxel} sumarizá-los em potenciais caminhos de fibras, sendo o DTI \cite{Basser1994} a mais utilizada.


%\section{DTI, limitações e HARDI}
%\section{Estimativa de Orientações de Difusão}
%\label{sec::dti_limitacoes_hardi}
%\todo[inline]{Sugiro que façs aqui uma espécie de survey dos métodos ... Fica a seu critério a classificação ... pode ser por forma de amostragem como em \url{https://www.researchgate.net/publication/319558026_High_Angular_Resolution_Diffusion_Imaging_HARDI/link/59e88db8a6fdccfe7f8e8a4f/download} ... Sugiro que poderia fazer um merge com capítulo 3.}

%Na aquisição do DWI, é escaneado um conjunto de volumes em que cada um possui a ponderação de único gradiente de difusão associado a um valor-b\footnote{O valor-b é uma métrica de sensitividade para difusão e é função de parâmetros da aquisição do DWI, como função da intensidade, duração e o intervalo de tempo dos gradientes de ponderação de difusão. Quanto maior o seu valor, maior o decaimento do sinal relativo à difusão.}, e, adicionalmente, um ou mais volumes sem ponderação de gradiente, denominado volume b0. A quantidade de volumes ponderados para diferentes direções de gradiente é denominada de resolução angular. Técnicas para sumarizar os sinais coletados em informações de potenciais caminhos de fibras nervosas são objeto de pesquisa desde o início dos anos 90 \cite{descoteaux2015}.



%\sout{A limitação do DTI acerca da possibilidade de inferir sobre fibras subjacentes é vinculada a modelagem da difusão ao modelo Gaussiano. O modelo descreve bem regiões de fibras em que o comportamento de difusão ocorre predominantemente em uma direção. Em pontos que contém múltiplas fibras e que estão dispostas nas mais variadas configurações (por exemplo: cruzamento, bifurcação, mistura, "beijo") o modelo gaussiano não sintetiza de forma correta o comportamento da difusão, impedindo o cômputo das direções plausíveis para reconstrução de uma fibra de interesse \cite{fillard2011, daducci2014}. Há um estimativa que entre 66\% a 90\% da substância branca do cérebro contém múltiplas configurações de cruzamento de fibra \cite{descoteaux2015} e a limitação do DTI é um obstáculo para modelar as direções de fibras subjacentes de forma adequada.}

%\todo[inline]{Não há Q-space imaging como uma proposta alternativa para DTI?}





%As técnicas livres de modelo buscam \sout{formular} uma \sout{representação para} formulação da \sout{função de} difusão \textcolor{red}{em função do seu perfil angular $\psi(\mathbf{\hat{u}})$,} explorando a relação de Fourier \cite{tuch2002} do sinal de difusão $W(\mathbf{r}, \mathbf{q})$\sout{ para obtenção de características da difusão em seu perfil angular $\psi(\mathbf{\hat{u}})$}. Entre os métodos \sout{foram} propostos, \textcolor{red}{destacam-se} o DSI \textcolor{red}{(\textit{Diffusion Sampling Imaging})} \cite{wedeen2005}, proposto originalmente em 2000 e presente na tese de doutorado de \citeonline{tuch2002}, juntamente com o QBI \textcolor{red}{(\textit{Q-ball Imaging})}, proposto em \citeonline{TuchQBall2004} \sout{em sua forma de artigo}, e o GQI \textcolor{red}{(\textit{Generalized Q-sampling Imaging})} \cite{yeh2010}\sout{ exemplificam esta categoria de métodos}.


%!!Porque geram ODFs?

%Estes métodos geram uma ODF a partir do sinal de difusão. Geralmente ODFs não possui a restrição quanto a regressão uma função tridimensional que o DTI possui e portanto conseguem ser mais descritivos do processo de difusão e gerar boas aproximações das fibras subjacentes, especialmente em cruzamentos \cite{daducci2014}.

% e evidentemente precisamos fazer uma seleção dos quais deles são mais relevantes para o nosso trabalho.

%Há diferentes aplicativos livres\textcolor{red}{, ligados a grupos de pesquisa,} que \sout{utilizam métodos HARDI}\textcolor{red}{não assumem modelos gaussianos} para processamento de DWI\sout{, que estão ligados a grupos de pesquisa na área,}. \sout{alguns destes aplicativos utilizam} \textcolor{red}{Encontram-se implementados} o GQI (DSI-Studio\footnote{Disponível em: http://dsi-studio.labsolver.org}), QBI (FSL\footnote{Disponível em: https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FSL}, FiberNavigator\footnote{Disponível em: https://scilus.github.io/fibernavigator/}), ambos métodos livres de modelo, e o \textit{constrained spherical deconvolution} \cite{tournier2007} (MRTrix\footnote{Disponível em: https://www.mrtrix.org/}), que é uma abordagem de deconvolução esférica.




%A grande desvantagem do GQI implementado na forma proposta por \citeonline{yeh2010} ocorre no uso de memória. A codificação de ODFs é feita por amostras e requer uma grande quantidade de memória, usualmente nas centenas de números por \textit{voxel}. Métodos que armazenam os dados como coeficientes de função base, como o QBI formulado por \citeonline{descoteaux2007_QBI} e o CSD \cite{tournier2007} tendem a utilizar menos memória.

\subsection{Amostragem Generalizada no Espaço Q}
\label{sec::gqi}

Nesta seção faremos uma breve apresentação do método GQI (\textit{Generalized Q-sampling Imaging}), a sua fundamentação teórica, na qual mostraremos a transformação do sinal de difusão $W(\mathbf{r},\mathbf{q})$ para função de distribuição de \textit{spins} (\textit{spin distribution function}, SDF) através de uma multiplicação matricial. Mostraremos uma formulação discreta de SDFs e a sua relação linear com dODFs. Ambas diferem 
por um fator de normalização. Uma boa aproximação da versão discreta de SDFs à versão contínua é usualmente feita a partir de uma amostragem de direções 3D com uma certa uniformidade no domínio esférico e a sua obtenção a partir de subdivisões do icosaedro é frequentemente utilizado \cite{tuch2002, TuchQBall2004, descoteaux2007, yeh2010}. Discutiremos, adicionalmente, uma técnica para obter tal amostragem.

%o método de reconstrução de funções de densidade de probabilidade de difusão em relação às diferentes orientações que usaremos para reconstruir ODF (\textit{Orientation Distribution Function}).

\subsubsection{Formulação}
\label{ssec::gqi_formulacao}

O GQI é um método de livre de modelo, derivado da relação de Fourier entre o sinal de difusão $W(\mathbf{r},\mathbf{q})$ no \textit{voxel}, de coordenadas $\mathbf{r}$, no espaço-Q, e o deslocamento dos \textit{spins} devido à difusão, modelado pela função de distribuição de \textit{spins} (\textit{Spin Distribution Function}, SDF) $\psi_Q(\mathbf{r}, \mathbf{\hat{u}})$, onde a orientação $\mathbf{\hat{u}}$ representa a direção dos spins submetidos ao processo de difusão. % \todo{Conteúdo angular ou orientação/direção de spin?}\textcolor{magenta}{o conteúdo angular da SDF}.

Para isso, o método explora a relação de Fourier em três dimensões entre o sinal de difusão $W(\mathbf{r}, \mathbf{q})$ e a função de densidade de \textit{spins} $Q(\mathbf{r}, \mathbf{u})$, introduzida:
\begin{equation}
\label{eq::spin_densidade_presentacao}
    Q(\mathbf{r}, \mathbf{u}) = W_{\Delta}(\mathbf{r}, \mathbf{0}) \bar{p}_{\Delta}(\mathbf{r}, \mathbf{u})
\end{equation}
onde $W_{\Delta}(\mathbf{r}, \mathbf{0})$ é o valor da densidade de \textit{spins}. Multiplicando a Eq. \ref{eq::propagator} por  $W_{\Delta}(\mathbf{r}, \mathbf{0})$ e substituindo a expressão à esquerda por $Q(\mathbf{r}, \mathbf{u})$, temos:


\begin{equation}
\label{eq::spin_diffsignal_1}
    Q(\mathbf{r}, \mathbf{u}) =
    \int \! W(\mathbf{r}, \mathbf{q})e^{-i2\pi \mathbf{q}\cdot \mathbf{u} } \,\mathrm{d}\mathbf{q} .
\end{equation}

Como $Q(\mathbf{r}, \mathbf{u})$ é real e $W(\mathbf{r}, \mathbf{q})$ é simétrica, podemos considerar a parte real da transformada, reduzindo a expressão em:

\begin{equation}
\label{eq::spin_diffsignal_2}
    Q(\mathbf{r}, \mathbf{u}) =
     \int \! W(\mathbf{r}, \mathbf{q})\text{cos}(2\pi \mathbf{q}\cdot \mathbf{u}) \,\mathrm{d}\mathbf{q} .
\end{equation}

Por outro lado, podemos estimar a quantidade de \textit{spins} que se submetem a difusão em uma direção $\mathbf{\hat{u}}$ (|$\mathbf{\hat{u}}$| = 1) através da integração da função $Q(\mathbf{r}, \mathbf{u})$ nesta direção, o que resulta em:
\begin{equation}
\label{eq::sdf_spin}
    \psi_Q(\mathbf{r}, \mathbf{\hat{u}}) =
   \int_{0}^{L_{\Delta}} Q(\mathbf{r}, L\mathbf{\hat{u}})\!  \,\mathrm{d}L , 
\end{equation}
onde $L_\Delta$ é a distância de difusão na direção  $\mathbf{r}$.

Combinando as Eq. \ref{eq::spin_diffsignal_2} e \ref{eq::sdf_spin}, obtemos a relação entre os sinais de difusão $W(\mathbf{r}, \mathbf{q})$ e $\psi_Q(\mathbf{r}, \mathbf{\hat{u}})$:
\begin{equation}
\label{eq::sdf_continuous_1}
    \psi_Q(\mathbf{r}, \mathbf{\hat{u}}) =
    \int_{0}^{L_{\Delta}}\int \! W(\mathbf{r}, \mathbf{q}) \text{cos}(2\pi L_{\Delta} \mathbf{q} \cdot \mathbf{\hat{u}}) \,\mathrm{d}\mathbf{q} \mathrm{d}L .
\end{equation}

Integrando em $L$, obtemos $\psi_Q(\mathbf{r}, \mathbf{\hat{u}})$ em função do sinal de difusão: 
\begin{equation}
\label{eq::sdf_continuous_2}
    \psi_Q(\mathbf{r}, \mathbf{\hat{u}}) =
    L_{\Delta} \int \! W(\mathbf{r}, \mathbf{q}) \text{sinc}(2\pi L_{\Delta} \mathbf{q} \cdot \mathbf{\hat{u}}) \,\mathrm{d}\mathbf{q} ,
\end{equation}
onde $\text{sinc}(x) = \text{sin}(x)/x$ para todo $x$ real, exceto $0$ e $\text{sinc}(0) = 1$.

Assumindo que a área de quadratura seja constante $A_q$ na discretização da Eq. \ref{eq::sdf_continuous_2}, chegamos na forma discreta de SDF que, em notação, diferenciamos da sua forma contínua $\psi_Q(\mathbf{r}, \mathbf{\hat{u}})$ mudando o índice $Q$ por $m$:


\begin{equation}
\label{eq::sdf_discrete_1}
    \psi_m(\mathbf{r}, \mathbf{\hat{u}}) =
     A_qL_{\Delta}\sum_{\mathbf{q} \in \mathbf{Q}} W(\mathbf{r}, \mathbf{q})\text{sinc}(2\pi L_{\Delta} \mathbf{q}\cdot\mathbf{\hat{u}}),
\end{equation}
onde $\mathbf{Q}= [
\mathbf{q}_1,
\mathbf{q}_2,
\mathbf{q}_3, ...,
\mathbf{q}_T
]$ corresponde às $T$ amostras no espaço-Q.

Observe que a distância de difusão ajusta a contribuição de cada $W(\mathbf{r}, \mathbf{q})$ no cômputo de $\psi_m(\mathbf{r}, \mathbf{\hat{u}})$ e funciona como um parâmetro de regularização. Se $L_{\Delta}$ tende a infinito, a função de distribuição irá se comportar como um impulso na origem, gerando um $\psi_m(\mathbf{r}, \mathbf{\hat{u}})$ fortemente ponderado pelas direções de $\mathbf{q}$ ortogonais a $\mathbf{\hat{u}}$. Um $L_{\Delta}$ pequeno implica em uma maior ponderação para coeficientes que não são ortogonais a $\mathbf{\hat{u}}$, o que atua como uma filtragem. No caso extremo, $L_{\Delta} = 0$, implica que todos os pesos aplicados para cômputo de ODFs em todas as direções $\mathbf{\hat{u}}$ se tornem iguais.

Considerando que a distribuição da difusão seja Gaussiana, a distância de difusão é dada por $L_{\Delta}=(6D\lambda)^{1/2}$, onde $D$ é o coeficiente de difusão da água na temperatura do corpo e $\lambda = \Delta - \delta/3$, que correspondem aos parâmetros de aquisição mostrados em Fig. \ref{fig::pgse_ilustrado}. 
Tipicamente, assume-se $D = 3.0*10^{-3} mm^2/s$ \cite{yeh2019_DSI}. Podemos ponderar $L_{\Delta}$ por um fator $\sigma$, isto é, $L_{\Delta} = \sigma(6D\lambda)^{1/2}$. Para $\sigma$ = 1.3, $80\%$ da difusão é considerada no cômputo da $\psi_Q(\mathbf{r}, \mathbf{\hat{u}})$.

Substituindo $L_{\Delta}$ por $\sigma(6D\lambda)^{1/2}$ e trocando $\mathbf{q}$ de acordo com a Eq. \ref{eq::qspace_bvalue} na Eq. \ref{eq::sdf_discrete_1}, obtemos:


%Uma SDF é formada pela soma de várias SDF bases oferecidos por um esquema de amostragem. A relação entre o sinal de difusão é dada pela expressão:

\begin{equation}
\label{eq::sdf_discrete_2}
    \psi_m(\mathbf{r}, \mathbf{\hat{u}}) =
    A_qL_{\Delta}\sum_{\mathbf{q} \in \mathbf{Q}}W(\mathbf{r}, \mathbf{q})\text{sinc}(\sigma \sqrt{6D\cdot b(\mathbf{q})}\,\,  \mathbf{\hat{q}}\cdot\mathbf{\hat{u}}) .
\end{equation}

 Na prática, as informações de ponderação de difusão em cada volume na aquisição DWI estão associadas a um valor $b(\mathbf{q})$ e uma direção associada ao gradiente de ponderação de difusão $\mathbf{\hat{q}}$. Vale a pena ressaltar que aquisições cujos sinais DWI são amostrados na metade de uma esfera para gradientes na direção tem o seu simétrico associado a ser adicionado no espaço-Q, no qual tem o valor de sinal de difusão $W(\mathbf{r}, -\mathbf{q}) = W(\mathbf{r}, \mathbf{q})$ \cite{descoteaux2015}.

A estimativa da SDF por \textit{voxel}, 
$\boldsymbol{\psi}_m(\mathbf{r}) = [
\psi_m(\mathbf{r}, \mathbf{\hat{u}}_1), 
\psi_m(\mathbf{r}, \mathbf{\hat{u}}_2), 
\psi_m(\mathbf{r}, \mathbf{\hat{u}}_3),$
$ ..., 
\psi_m(\mathbf{r}, \mathbf{\hat{u}}_S)
]^T$
é feita por meio de $S$ amostras, nas quais são reconstruídas num domínio de $S$ direções de interesse $\mathbf{U} = [
\mathbf{\hat{u}}_1, 
\mathbf{\hat{u}}_2, 
\mathbf{\hat{u}}_3, \dots, 
\mathbf{\hat{u}}_S 
]$, a partir de sinais de um conjunto de difusão $\mathbf{W}(\mathbf{r}) = [
W(\mathbf{r},\mathbf{q}_1),
W(\mathbf{r},\mathbf{q}_2),
W(\mathbf{r},\mathbf{q}_3), \dots ,
W(\mathbf{r},\mathbf{q}_T)
]^T$. Detalharemos o processo de escolha de $\mathbf{U}$ na Seção \ref{ssec::dominio_esferico}.

Assim, definimos a relação entre $\boldsymbol{\psi}_m(\mathbf{r})$ em função de $\mathbf{W}(\mathbf{r})$ através de uma multiplicação matricial definida pela matriz $\mathbf{S}_{S\times T}$:
\begin{equation}
\label{eq::gqi_vec}
    \boldsymbol{\psi}_m(\mathbf{r}) = \mathbf{S}*\mathbf{W}(\mathbf{r}) ,
\end{equation}
onde $s_{i,j} \in \mathbf{S}$:
\begin{equation}
\label{eq::s_ij}
s_{i,j} = A_qL_{\Delta}\text{sinc}(\sigma \sqrt{6D.b(\mathbf{q}_j)} )\mathbf{\hat{q}}_j.\mathbf{\hat{u}_i}) ,
\end{equation}

A partir de $\boldsymbol{\psi}_m(\mathbf{r})$, obtemos as dODFs $\boldsymbol{\psi}_d(\mathbf{r})$ fazendo a normalização pela soma dos valores de SDF em cada \textit{voxel} afim de cumprir o requisito de se tornar uma função de densidade de probabilidade \cite{yeh2010}:
\begin{equation}
\label{eq::SDF2dODF_prob}
    \boldsymbol{\psi}_d(\mathbf{r}, \mathbf{\hat{u}}) =
    \frac{\boldsymbol{\psi}_m(\mathbf{r}, \mathbf{\hat{u}})}{\sum \limits_{\mathbf{\hat{u}} \in \mathbf{U}}\boldsymbol{\psi}_m(\mathbf{r}, \mathbf{\hat{u}})}.
\end{equation}
Observe que a normalização cancela o fator de escala $A_qL_{\Delta}$ da Eq. \ref{eq::sdf_discrete_1}.

%


%O próximo passo é transformação de $\boldsymbol{\psi}_m(\mathbf{r})$ em ODF, somando seus valores e dividindo cada elemento pela soma dos vetores. Observe que esta operação, aproxima $\boldsymbol{\psi}_m(\mathbf{r})$ de uma dODF, visto a formulação do GQI sem o fator de escala $W_{\Delta}(\mathbf{r}, \mathbf{0})$, poderia ser 

%Observe que a diferença entre e a dODF $\Psi(\mathbf{r}, \mathbf{\hat{u}})$ é o escalonamento pelo fator , e a normalização pela soma cancela este fator.

%\begin{equation}
%\label{eq::s_ij}
%s_{i,j} = A_qL_{\Delta}\text{sinc}(\sigma \sqrt{6D.b(\mathbf{q}_j)} )\mathbf{\hat{q}}_j.\mathbf{\hat{u}_i}) ,
%\end{equation}

%\sout{Com o objetivo de enfatizar as direções dominantes de difusão na renderização de glifos, \citeonline{TuchQBall2004} sugere normalizar cada função de distribuição de \textit{spins} $\boldsymbol{\psi}_m(\mathbf{r})$ pela normalização min-max, \textcolor{red}{cujo resultado Sicrano \cite{???} mostrou que é uma} ODF $\boldsymbol{\psi}(\mathbf{r})$\sout{, conforme mostrado na Eq. \ref{eq::SDF2dODF}.} }

% \begin{equation}
% \label{eq::SDF2dODF}
%     \boldsymbol{\psi}(\mathbf{r}) = [ \frac{\boldsymbol{\psi}_m(\mathbf{r}) - \text{min}(\boldsymbol{\psi}_m(\mathbf{r}))}{\text{max}(\boldsymbol{\psi}_m(\mathbf{r})) - \text{min}(\boldsymbol{\psi}_m(\mathbf{r}))}], m = 1, \cdots, S ,
% \end{equation}
% \sout{onde $\text{min}(\boldsymbol{\psi}_m(\mathbf{r}))$ e $\text{max}(\boldsymbol{\psi}_m(\mathbf{r}))$ são, respectivamente, o mínimo e o máximo dos $S$ valores associados à amostra $\mathbf{r}$.}

%\sout{O efeito da normalização está ilustrado na Fig. \ref{fig::normalizacao_min_max}. Observe que a normalização cancela o fator de escala $A_qL_{\Delta}$ da Eq. \ref{eq::s_ij}.}

%\begin{equation}
%\label{eq::SDF2dODF}
%    \boldsymbol{\psi}(\mathbf{r}) = [ \frac{\boldsymbol{\psi}_m(\mathbf{r}) - %\text{min}(\boldsymbol{\psi}_m(\mathbf{r}))}{\text{max}(\boldsymbol{\psi}_m(\mathbf{r})) - %\text{min}(\boldsymbol{\psi}_m(\mathbf{r}))}], m = 1, \cdots, S
%\end{equation}

%\begin{figure}[ht]
%\centering
%\captionsetup[subfloat]{farskip=0pt,nearskip=0pt}
%\centering
    %\subfloat[ODF não normalizada] {\includegraphics[width=.30\linewidth, angle=0]{figs/HARDI/ODF_normalizacao/ODF-pura.png}
    %\label{fig::odf_pura}
    %}
    %\hspace{1em}
    %\subfloat[ODF min-max normalizada] {\includegraphics[width=.17\linewidth, angle=0]{figs/HARDI/ODF_normalizacao/ODF_minmax.png}
    %\label{fig::odf_minmax}
    %}
     %\caption{Glifo ODF da mesma ODF com e sem a normalização min-max. A disposição de cores glifo enfatiza a orientação da ODF, no qual a direção dos eixos x, y, z estão mapeadas nas cores vermelha, verde e azul. Note que em \ref{fig::odf_minmax}, a estrutura orientacional da ODF é enfatizada com uma forte componente na direção do eixo y. O Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao} traz a formulação com detalhes do glifo.}
    %\label{fig::normalizacao_min_max}
%\end{figure}

\subsubsection{Domínio de amostragem}
%\subsection{Domínio esférico}
\label{ssec::dominio_esferico}

Tipicamente, as $S$ direções espaçadas para amostragem de dODFs,
$\mathbf{U} = [
\mathbf{\hat{u}}_1$, 
$\mathbf{\hat{u}}_2$, 
$\mathbf{\hat{u}}_3$, ..., 
$\mathbf{\hat{u}}_S]$ como ilustra a Fig. \ref{fig::direcoes}, são obtidas através das coordenadas dos pontos de uma malha esférica gerada por subdivisões sucessivas de um icosaedro inscrito numa esfera unitária, uma vez que as coordenadas dos pontos coincidem com as coordenadas dos vetores normais da esfera no ponto. Na comunidade de métodos de alta ordem para DWI, esta categoria de malha é amplamente utilizada \cite{yeh2010, TuchQBall2004, descoteaux2007} pois apresenta certas propriedades desejáveis  \cite{popko2012}:

\begin{enumerate}
    \item Seus doze vértices são uniformemente\footnote{O conceito de uniformidade em uma distribuição de pontos em uma esfera, apesar de intuitivo, é algo cuja avaliação não se dá em apenas uma métrica. O Capítulo 9 de \cite{popko2012} introduz métricas para este fim e compara malhas esféricas obtidas a partir de subdivisões de sólidos de Platão.} distribuídos e estão contidos em uma esfera.
    \item Os triângulos que definem a sua face são equiláteros.
    \item Todos os vértices tem um vértice antipodal correspondente.
    \item Os pontos sobre malhas esféricas são \textit{quasi}-isotrópicos. \cite{popko2012}.
\end{enumerate}

%\todo{\textcolor{green}{Na verdade, a questão do uso do icosaedro é algo que é um aparente consenso e ninguém coloca referência do motivo do uso. Só apenas menciona que usou. Eu entendo o uso mais pela minha experiência do que pela justificativa da comunidade.}}
%Das propriedades descritas, \citeonline{descoteaux2007} mostra que a \textit{quasi}-isotropia torna esta malha desejável para o cômputo de máximos locais e cômputo de distribuição de fibras subjacentes.\todo{Cap. 3?}\sout{e o fato de cada um dos seus vértices possuírem sua respectiva antípodas, permite que nós possamos nos aproveitar da simetria de ODFs de difusão para armazená-la em um só valor para ambas antípodas na memória.}

%\footnote{\citeonline{descoteaux2007} utiliza esta categoria de malha para cômputo de máximos locais.}
\todo[inline]{Adequar a legenda da Figura 2.2.}

 \begin{figure}[ht]
 %\subfigcapskip = -5pt
     \centering
     \includegraphics[width=.8\linewidth, angle=0]{figs/HARDI/icosphere_normals.png}
     \caption{
     Ilustração da extração do conjunto $\mathbf{U}$ da malha esférica obtida através da tesselação de $4^a$ ordem do icosaedro. Os vetores em vermelho indicam os vetores em $\mathbf{U}$, extraídos a partir das normais dos pontos da esfera. Devido a simetria em relação aos eixos das funções de difusão, as amostramos apenas em uma semi-esfera.% no hemisfério $y > 0 \cup (y = 0 \cap x > 0)$.
     }
     \label{fig::direcoes}
   \hspace{1pt}
 \end{figure}

\citeonline{popko2012} discute diversas maneiras de aproximar uma esfera a partir de um icosaedro (Fig. \ref{fig::icosaedro}), entre as quais, escolhemos a subdivisão por cordas iguais  (\textit{Class I - Equal-Chords}). \todo{Cap. 3} Mencionamos a subdivisão por arcos iguais (\textit{Class I - Equal Arcs, three great circles}), a qual, além de gozar das mesmas propriedades presentes na subdivisão por cordas iguais, os vértices computados na subdivisão são mais uniformemente distribuídos na esfera, a custo de uma complexidade computacional maior.

\begin{figure}[ht]
%\subfigcapskip = -5pt
    \centering
    \includegraphics[width=.3\linewidth, angle=0]{figs/HARDI/icosaedro.png}
    \caption{
    Icosaedro.
    }
    \label{fig::icosaedro}
   \hspace{1pt}
\end{figure}


A subdivisão por cordas iguais é efetuada em cada face do icosaedro. Para cada aresta do triângulo, um conjunto de \todo[inline]{grids ou segmentos? \textcolor{green}{Segmentos! O nome utilizado pelo autor é grid e eu não consegui pensar em coisa melhor}}segmentos paralelos à aresta e equidistantes entre si são traçados. As intersecções dos dos segmentos constituem novos vértices e são projetados na esfera. Fig. \ref{fig::icosaedro_faces_2} ilustra o procedimento de uma subdivisão. Traçamos somente um segmento paralelo a cada aresta da face triangular, equidistante da aresta e do vértice oposto à aresta. As intersecções, v01', v12'e v20', dividem as arestas em arcos iguais e são inseridos como novos vértices da malha. Esses vértices são, então, projetados sobre a esfera. O procedimento é feito em todas as faces da malha, conforme ilustrado nas Fig.\ref{fig::icosaedro_nao_norm}. Fig. \ref{fig::icosaedro_norm} mostra o espaço de amostras após a projeção de todos os novos vértices sobre a esfera unitária.

\begin{figure}[htb]
    \centering
    \subfloat[Subdivisão dos pontos] {\includegraphics[width=.7\linewidth,  angle=0]{figs/Esquema_Glifo/ico_subdivision_2.png}
    \label{fig::icosaedro_faces_2}
    }
    \\
     \subfloat[Subdivisão dos triângulos do icosaedro. Os vértices do icosaedro destacados por círculos vermelhos]{\makebox[1.35\width]
     {\includegraphics[width=.30\linewidth,  angle=0]{figs/HARDI/icosaedro_nao_norm.png}
    \label{fig::icosaedro_nao_norm}
    }
    }
     \subfloat[Resultado da projeção da subdivisão na esfera.]{\makebox[1.35\width]
     {\includegraphics[width=.35\linewidth,  angle=0]{figs/HARDI/icosaedro_norm.png}
    \label{fig::icosaedro_norm}
    }
    }
    \caption{ Ilustração da subdivisão por cordas iguais. Traçamos um segmento paralelo a cada aresta, no qual é equidistante da aresta e do vértice oposto. Os vértices $v0'$, $v1'$ e $v2'$ consistem na intersecção dos segmentos com as arestas do triângulo. A projeção na esfera da interseção gera $v01$, $v12$ e $v20$, que são adicionados ao conjunto de pontos da subdivisão.
    }
    \label{fig::triangle_subdivisao}
\end{figure}

Na Fig. \ref{fig::icosaedro_subdivisao_4}, ilustramos o processo de subdivisão, no qual definimos a quantidade de segmentos paralelos a cada aresta dos triângulos igual a três, dividindo as arestas em quatro cordas iguais, resultando numa malha mostrada na Fig. \ref{fig::icosaedro_faces_4} que, após a projeção dos novos vértices sobre a esfera chegamos a um espaço de amostras ilustrado na Fig. \ref{fig::icosaedro_normalizada_4}.

\begin{figure}[ht]
\centering
\captionsetup[subfloat]{farskip=0pt,nearskip=0pt}
\centering
    \subfloat[Novos vértices computados através da subdivisão de cada aresta em quatro segmentos] {\includegraphics[width=.45\linewidth, angle=0]{figs/HARDI/Subdivisao_icosaedro/divisao_faces_4.png}
    \label{fig::icosaedro_faces_4}
    }
    \hspace{1em}
    \subfloat[Novos vértices projetados na esfera.] {\includegraphics[width=.325\linewidth, angle=0]{figs/HARDI/Subdivisao_icosaedro/divisao_normalizada_4.png}
    \label{fig::icosaedro_normalizada_4}
    }
     \caption{Processo de subdivisão do icosaedro de quarta ordem.}
    \label{fig::icosaedro_subdivisao_4}
\end{figure}

Podemos sintetizar esta classe de subdivisão através de um parâmetro $t$, que indica a quantidade de subdivisões aplicadas a cada aresta do icosaedro. Nesta dissertação, referenciamos o processo descrito pela subdivisão por $t$ cordas iguais do icosaedro como a \textsf{$t$-ésima ordem de tesselação do icosaedro} ou \textsf{subdivisão de ordem $t$ do icosaedro}. Podemos também inferir a quantidade de vértices $N$ e de faces $\tau$ da malha em função de $t$, de acordo com o mostrado nas Eq. \ref{eq::icosphere_vertices} e \ref{eq::icosphere_triangulos}, respectivamente \cite{popko2012}.

\begin{equation}
\label{eq::icosphere_vertices}
    N = 10\times t^2 + 2
\end{equation}

\begin{equation}
\label{eq::icosphere_triangulos}
\tau = 20\times t^2
\end{equation}

%Observe que a projeção dos pontos intermediários adicionados na esfera subdivide cada aresta em dois e quatro, no exemplo ilustrados em Fig. \ref{fig::icosaedro_subdivisao} e \ref{fig::icosaedro_subdivisao_4}. Portanto, podemos referenciar esta categoria de subdivisão, que é classe I, na qual todas as arestas são divididas em $t$ segmentos de reta, pelo parâmetro $t$, no qual podemos inferir a quantidade de vértices e faces, representados nas Eq. \ref{eq::icosphere_vertices} e \ref{eq::icosphere_triangulos}, respectivamente \cite{popko2012}.


Neste trabalho, escolhemos a subdivisão por cordas iguais e restringimo-nos a categoria de malhas feitas através das subdivisões de ordem $2^k$ do icosaedro. Além de todos os vértices da malha possuírem suas antípodas, esta categoria de malha apresenta mais uma característica desejável: há uma regularidade das facetas subdivididas\todo{Cap. 3}. Algumas esferas aproximadas por tesselações de ordem $2^k$ do icosaedro estão ilustradas na Fig. \ref{fig::icosphere}. A quantidade de vértices para $2^a$, $4^a$, $8^a$ e $16^a$ ordem de tesselação é de 42, 162, 642 e 2562, respectivamente. Na Seção \ref{sec::renderizacao_de_glifos_ODF} do Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao}, discutiremos os aspectos computacionais da tesselação do icosaedro e descrevemos um algoritmo de tesselação.

\begin{figure}[ht]
\centering
\captionsetup[subfloat]{farskip=0pt,nearskip=0pt}
\centering
    \subfloat[Tesselação de $2^a$ ordem] {\includegraphics[width=.25\linewidth, angle=0]{figs/HARDI/Icosphere/icosphere_1.png}
    \label{fig::icosphere_1}
    }
    \hspace{1em}
    \subfloat[Tesselação de $4^a$ ordem] {\includegraphics[width=.25\linewidth, angle=0]{figs/HARDI/Icosphere/icosphere_2.png}
    \label{fig::icosphere_2}
    }
    \\
    \subfloat[Tesselação de $8^a$ ordem] {\includegraphics[width=.25\linewidth, angle=0]{figs/HARDI/Icosphere/icosphere_3.png}
    \label{fig::icosphere_3}
    }
    \hspace{1em}
    \subfloat[Tesselação de $16^a$ ordem]{\includegraphics[width=.25\linewidth, angle=0]{figs/HARDI/Icosphere/icosphere_4.png}
    \label{fig::icosphere_4}
    }
     \caption{Esferas obtidas através da tesselação de um icosaedro.}
    \label{fig::icosphere}
\end{figure}

\todo[inline]{Eu passaria os seguintes parágrafos para um capítulo em que você apresenta a sua proposta. \textcolor{green}{Todo o conteúdo de estrutura de dados está no capítulo 3}}

%\sout{
%Escolhida a ordem de tesselação de amostragem do icosaedro, a partir do conjunto de pontos $\Pi = \{P_1, P_2, \dots, P_N\}$ vértices da malha centrada em $(0,0,0)$, categorizamos os pontos com subíndice ímpar $\Pi_{impar} = \{P_1, P_3, ..., P_{N-3}, P_{N-1}\}$ como os pontos contidos no hemisfério $\{P(x, y, z) \in \Pi | y > 0 \cup (y = 0 \cap x > 0)\}$, e o restante dos pontos da malha estão categorizadas em $\Pi_{par} = \{P_2, P_4, ..., P_{N-2}, P_{N}\}$. Observe que, devido a simetria da malha, as antípodas de um ponto em $\Pi_{impar}$ estão em $\Pi_{par}$ e vice versa. Adicionalmente, condicionamos que $P_{2i+2} = -P_{2i+1}$, $(0 \leq K \leq \frac{N-2}{2})$.
%}

%\footnote{Na Seção \ref{ssec::geometria_base} do Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao}, sugerimos diretrizes para a formulação da estrutura de dados dos pontos de $\Pi$.} 

%\sout{
%Para utilização mais eficiente do uso de memória, exploramos a simetria em relação aos eixos da SDF, i. e. $\psi_m(\mathbf{u}) = \psi_m(-\mathbf{u})$ e definimos $\mathbf{U}$ para normais dos vértices da malha esférica dos pontos em $\Pi_{impar}$, conforme ilustrado em Fig. \ref{fig::direcoes}. Logo, para malha esférica escolhida com $N$ vértices, $\mathbf{U}_{3\times \frac{N}{2}} = [
%\mathbf{n}_1,
%\mathbf{n}_3, ..., 
%\mathbf{n}_{N-3},
%\mathbf{n}_{N-1}
%]$, onde $\mathbf{n}_k$ é o vetor unitário com direção e sentido de $P_k$.
%}

%\sout{
%No que diz respeito ao acesso computacional, em $\boldsymbol{\psi_m}(\mathbf{r}) = [
% \psi_m(\mathbf{n}_1    )$,
%$\psi_m(\mathbf{n}_3    )$, ..., 
%$\psi_m(\mathbf{n}_{N-3})$,
%$\psi_m(\mathbf{n}_{N-1})
%]^T$, para a referência em uma direção $\mathbf{n}$ das normais das amostras do icosaedro tesselado, se $\mathbf{n} \in \mathbf{U}$, retornamos $\psi_m(\mathbf{n})$, caso contrário, retornamos $\psi_m(-\mathbf{n})$ referente à sua antípoda.
%}

%através de \textit{grids}  divisão de cada aresta do icosaedro em N segmentos  corresponde à N-ésima ordem de tesselação do icosaedro 

%modalidade de subdivisão do icosaedro para geração da esfera para geração dos \textit{grids} pode ser referenciada pela quantidade de segmentos que dividimos cada aresta para gerar os grids



%para a classe de subdivisão escolhida, classificaremos a tesselação do icosaedro quanto a quantidade de pontos . 

%\sout{Recomendamos que a ordem de tesselação para amostragem seja a oitava ou, no máximo, a décima sexta, implicando em 321 e 1281 amostras de ODF por \textit{voxel}. Para tesselação de oitava ordem, em que armazenamos os dados em um ponto flutuante de 4 \textit{bytes}, são necessários 1284 bytes por \textit{voxel}, que gera aproximadamente 4,480 \textit{Gigabytes} de memória para um volume de $145 \times 174 \times 145$ de memória do \textit{Human Connectome Project} \cite{essen2012}. Observe que há um alto uso de memória na codificação dos dados, e esta questão está relacionada ao armazenamento por amostras. Na área DWI, há métodos de alta ordem que visam codificar os dados como coeficientes de funções base \cite{descoteaux2007_QBI, tournier2007} e se comportam melhor neste aspecto.}

%Neste trabalho, restringimo-nos a categoria de malhas feitas através das subdivisões de ordem $2^k$ do icosaedro. Esta categoria de malha apresenta duas características desejáveis: a primeira se refere a presença de pares simétricos em relação aos eixos coordenados (i.e., se o ponto $P$ está na malha, $-P$ também está);\todo{Esta segunda característica vale para quaisquer subdivisões ...} a segunda se refere a \sout{possibilidade de tirar proveito da percepção visual na renderização de glifos ODF,}\textcolor{red}{regularidade das facetas subdivididas,} o que possibilita aumentar e diminuir a resolução dos glifos ODF de acordo com um modelo que relaciona sua ocupância na tela e resolução \textcolor{red}{mantendo a qualidade da malha}, conforme será detalhado no capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao}.

%\sout{A quantidade de amostras em função da ordem de tesselação do icosaedro é dada por:}
%\begin{equation}
%\label{eq::icosphere_vertices}
%    N = 10\times t^2 + 2
%\end{equation}
%\sout{onde $t$ é a ordem de tesselação. A respeito das malhas esféricas mostradas na Fig. \ref{fig::icosphere}, a quantidade de vértices para $2^a$, $4^a$, $8^a$ e $16^a$ ordem de tesselação é 42, 162, 642 e 2562, respectivamente.}

%\sout{
%Seja o conjunto $\Pi = \{P_1, P_2, \dots, P_N\}$o conjunto de vértices da malha esférica obtida através da subdivisão do icosaedro. Para que possamos tomar vantagem da simetria de ODFs, condicionamos que $P_{2K+2} = -P_{2K+1}$ $(0 \leq K \leq \frac{N-2}{2})$.
%}

%\sout{
%Pode-se atribuir ao vetor $\mathbf{U} = [
%\mathbf{n}_1, 
%\mathbf{n}_2, ...,
%\mathbf{n}_{N-1},
%\mathbf{n}_N
%]$, nos quais cada $\mathbf{n}_i$ é o vetor unitário na direção e sentido do vetor normal de $P_i$ ($P_i \in \Pi$), no entanto podemos tirar vantagem da simetria da ODF e reduzir o seu tamanho pela metade. Os pontos simétricos em relação aos eixos da esfera tem normais em sentidos opostos, ou seja, $\mathbf{n}_{2K+2} = -\mathbf{n}_{2K+1}$, $(0 \leq K \leq \frac{N-2}{2})$. Observe que a função $\psi_m(\mathbf{r}, \mathbf{\hat{u}})$ (Eq. \ref{eq::sdf_discrete_2}) é simétrica em relação aos eixos em $\mathbf{\hat{u}}$, $\psi_m(\mathbf{r}, \mathbf{\hat{u}}) = \psi_m(\mathbf{r}, \mathbf{-\hat{u}})$, implicando que $\psi_m(\mathbf{r}, \mathbf{n}_{2K+2}) = \psi_m(\mathbf{r}, \mathbf{n}_{2K+1})$.
%}

%\sout{
%Assim, para utilização mais eficiente do uso de memória, definimos $\mathbf{U}$ para normais dos vértices da malha esférica, mapeando o par de normais de sentidos opostos em uma única direção. Logo $\mathbf{U}_{3\times \frac{N}{2}} = [
%\mathbf{n}_1,
%\mathbf{n}_3, ..., 
%\mathbf{n}_{N-3},
%\mathbf{n}_{N-1}
%]$, onde o vetor na K-ésima  posição de $\mathbf{U}$ é $\mathbf{\hat{n}}_{2K-1}$. Observe que após o cômputo, $\boldsymbol{\psi}(\mathbf{r})$ tem na K-ésima posição os valores de ODF associadas à $\mathbf{n}_{2K-1}$, e também a direção $\mathbf{n}_{2K}$.
%}

%\sout{
%Recomendamos que a ordem de tesselação para amostragem seja a oitava ou, no máximo, a décima sexta, implicando em 321 e 1281 amostras de ODF por \textit{voxel}. Valores acima destes computados para todo DWI pode incorrer no uso de uma quantidade proibitiva de memória.
%}



%Pode-se estabelecer que a estrutura de dados de $\mathbf{U}$ seja $[\mathbf{u_1}, \mathbf{u_2}, ..., \mathbf{u_{N-1}}, \mathbf{u_{N}}]^T$. Porém, podemos aproveitar a simetria dos dados e da malha esférica utilizada e organizarmos os dados de tal forma que um valor de ODF guardado na memória seja associado a duas direções simétricas.

\section{Visualização de Direções Intravoxeis}
\label{sec::vis_dODFs}

\todo[inline]{Sugiro incluir referências aos métodos citados nesta seção}

%Há duas formas de visualização de dados de ODF, que consistem em mapas escalares, onde codificam através de cor características de ODFs, como o mapa de anisotropia fracionada generalizada \cite{TuchQBall2004, yeh2010}, e através de glifos. Mapas escalares tendem a ser limitadas no que diz respeito de gerar a possibilidade de inferir sobre cruzamentos de fibra e síntese das ODFs, pois consistem em um mapeamento de centenas ou milhares de dados que geram ODFs em componentes em uma cor tricromática.  

Embora as dODFs proveem informações mais precisas sobre as direções de potenciais fibras que cruzam um \textit{voxel}, a grande quantidade de dados numéricos envolvidos em dODFs de um volume de ressonância magnética ponderada por difusão torna difícil avaliar a plausibilidade das amostras adquiridas em relação à anatomia da substância branca cerebral e aplicá-las para provas de conceito em esquemas de aquisição de alta resolução angular. A forma mais comum de superar esta dificuldade é visualizar os dados numéricos em glifos. 

\todo[inline]{Talvez seja interessante fazer um apanhado geral do conceito de glifo e o seu uso na síntese de dados multivariáveis (alta dimensão). Pode-se mapear diferentes atributos dos dados em diferentes atributos gráficos de forma que se consegue distinguir os dados só pela aparência visual dos seus glifos correspondentes. Veja \url{https://www.researchgate.net/publication/224285723_Information_Visualization_Perception_for_Design_Second_Edition}.}

Um glifo é um objeto gráfico projetado para representar um ou mais conjunto de atributos relacionados a um objeto de interesse, chamado de entidade \cite{ware2004}. Os atributos podem ser mapeadas em uma ou mais variáveis visuais:

\begin{enumerate}
    \item posição espacial -  três dimensões (x, y, z);
    \item cor - três dimensões (r, g, b);
    \item forma - orientação e tamanho;
    \item textura em superfície - tamanho e contraste.
    \item codificação de movimento - duas/três dimensões; e
    \item codificação por piscamento - uma dimensão.
\end{enumerate}

Como exemplos de glifos, \citeonline{Kindlmann2004} propõe glifos superquádricos para representar tensores de segunda ordem, que sintetizam uma matriz simétrica 3x3 com seis coeficientes em um objeto gráfico, como o DTI. Na visualização da Fig. \ref{fig::intro_ex_DTI_glifos} a cor e a orientação dos glifos dão informação direcional do autovetor associado ao maior autovalor do tensor de difusão. Adicionalmente, a posição espacial do glifo está no seu respectivo \textit{voxel} na cena, dando ao usuário a noção espacial da localidade de referência dos dados.

Ressaltamos que na Fig. \ref{fig::intro_ex_DTI_glifos}, os eixos x, y e z da cena são coerentes com a direção horizontal, vertical e normal à página e as cores vermelho, verde e azul reforçam a informação da dominância das componentes x, y e z na orientação dos glifos, respectivamente. Este esquema de cores é comumente utilizado para visualização de dados de difusão \cite{DTI_Handbook}.

\todo[inline]{Falar dos glifos para representar DTI: De acordo com Ware,
os glifos propostos por Kindleman ... para representar os dados dos tensores de difusão de segunda ordem são exemplos de uso de glifos para representar várias variáveis numa única figura. \textcolor{green}{OK!}}

A forma mais difundida para visualizar os dados numéricos das ODFs são os glifos provenientes da superfície definida pela plotagem polar esférica $R(\mathbf{\hat{u}})$ \cite{descoteaux2015, daducci2014, TuchQBall2004}, no qual seu uso na área é mostrado pela primeira vez por \citeonline{tuch2002}, em seu trabalho seminal. Estes glifos permitem sintetizar numa única imagem não só o comportamento local (intra \textit{voxel}) de difusão como também as relações inter \textit{voxels}, quando glifos referentes à \textit{voxels} vizinhos são renderizados lado a lado.

%\textcolor{red}{Esta seção apresenta as ideias básicas no projeto de glifos para representar a densidade de difusão em cada amostra de um volume de DWI.}

Nesta seção, apresentamos o projeto de glifos para representar ODFs referentes a cada \textit{voxel} em um volume DWI, no qual utilizamos as variáveis visual de forma, cor e posição espacial.

%\subsection{Glifos ODF}
\subsection{Mapeamento de Densidade de Spins em Formas Geométricas}
\label{sec::glifos_odf}

%Como descrito na seção \ref{sec::trabalhos_relacionados_glifos}
%\subsubsection{Superfície}

A superfície do glifo da ODF no \textit{voxel} de coordenadas $\mathbf{r}$ $\psi_d(\mathbf{r}, \mathbf{\hat{u}})$ consiste na plotagem polar esférica $R(\mathbf{\hat{u}})$ de $\psi(\mathbf{r}, \mathbf{\hat{u}})$, onde $\psi(\mathbf{r}, \mathbf{\hat{u}})$ é $\psi_d(\mathbf{r}, \mathbf{\hat{u}})$ min-max normalizada  (Eq. \ref{eq::dODF2min_max}). A plotagem polar esférica $R(\mathbf{\hat{u}})$ é uma superfície na qual a distância da origem para um dos seus respectivos pontos na direção $\mathbf{\hat{u}}$ é dado por $R(\mathbf{\hat{u}})$. Esta normalização foi sugerida por \citeonline{TuchQBall2004} com o objetivo de enfatizar as direções dominantes dos glifos, como ilustrado na Fig. \ref{fig::normalizacao_min_max}. A normalização min-max de $\psi_d(\mathbf{r}, \mathbf{\hat{u}})$ é dada por:

% é dada por  na modulação do raio na direção $\mathbf{u}$ de uma esférica de acordo com uma versão normalizada do seu valor de imagem na função $\psi(\mathbf{u})$. A normalização que fizemos neste trabalho para representação está representado na equação \ref{eq::normglifo2}.

%\begin{equation}
%\label{eq::normglifo2}
%    R(\mathbf{u}) = \frac{\psi(\mathbf{u}) - min(\psi(\mathbf{u}))}{max(\psi(\mathbf{u})) - min(\psi(\mathbf{u}))}
%\end{equation}



\begin{equation}
\label{eq::dODF2min_max}
    \boldsymbol{\psi}(\mathbf{r}) = [ \frac{\boldsymbol{\psi}_d(\mathbf{r}) - \text{min}(\boldsymbol{\psi}_d(\mathbf{r}))}{\text{max}(\boldsymbol{\psi}_d(\mathbf{r})) - \text{min}(\boldsymbol{\psi}_d(\mathbf{r}))}],
\end{equation}
onde $\text{min}(\boldsymbol{\psi}_d(\mathbf{r}))$ e $\text{max}(\boldsymbol{\psi}_d(\mathbf{r}))$ são, respectivamente, o mínimo e o máximo dos $S$ valores associados de dODF à amostra $\mathbf{r}$. O efeito da normalização está ilustrado na Fig. \ref{fig::normalizacao_min_max}. 

Há um problema intrínseco à normalização min-max, no qual regiões onde o meio de ocorrência da difusão é isotrópico, que consiste na produção de picos devido ao ruído, que pode potencialmente mostrar resultados visuais de difusão isotrópica aparentar ser anisotrópica \cite{TuchQBall2004}.
%Observe que a normalização cancela o fator de escala $A_qL_{\Delta}$ da Eq. \ref{eq::s_ij}.


%\begin{equation}
%\label{eq::SDF2dODF}
%    \boldsymbol{\psi}(\mathbf{r}) = [ \frac{\boldsymbol{\psi}_m(\mathbf{r}) - %\text{min}(\boldsymbol{\psi}_m(\mathbf{r}))}{\text{max}(\boldsymbol{\psi}_m(\mathbf{r})) - %\text{min}(\boldsymbol{\psi}_m(\mathbf{r}))}], m = 1, \cdots, S
%\end{equation}

\begin{figure}[ht]
\centering
\captionsetup[subfloat]{farskip=0pt,nearskip=0pt}
\centering
    \subfloat[ODF não normalizada] {\includegraphics[width=.30\linewidth, angle=0]{figs/HARDI/ODF_normalizacao/ODF-pura.png}
    \label{fig::odf_pura}
    }
    \hspace{1em}
    \subfloat[ODF min-max normalizada] {\includegraphics[width=.17\linewidth, angle=0]{figs/HARDI/ODF_normalizacao/ODF_minmax.png}
    \label{fig::odf_minmax}
    }
     \caption{Glifo da ODF com e sem a normalização min-max. A disposição de cores glifo enfatiza a orientação da ODF, no qual a direção dos eixos x, y, z estão mapeadas nas cores vermelha, verde e azul. Note que em \ref{fig::odf_minmax}, a estrutura orientacional da ODF é enfatizada com uma forte componente na direção do eixo y. %O Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao} traz a formulação com detalhes do glifo.
     }
    \label{fig::normalizacao_min_max}
\end{figure}

Observe em Fig. \ref{fig::glifo_ilustrado} que pode-se inferir sobre o comportamento local de fibras. No glifo mais a esquerda, temos uma componente forte na horizontal, o que sugere que a dODF tem uma fibra subjacente na horizontal; o glifo ODF localizado no meio sugere que há um cruzamento entre uma fibra na direção vertical e outra com uma leve inclinação na direção horizontal; e o glifo ODF à direita sugere que há uma fibra subjacente predominantemente na vertical.



\begin{figure}[ht]

%\subfigcapskip = -5pt
    \centering
    \includegraphics[width=.8\linewidth, angle=0]{figs/Esquema_Glifo/Glifos3Ex.png}
    \caption{Exemplos de glifos ODF. Os glifos consistem em uma superfície plotagem polar com a cor esquematizada de acordo com a equação \ref{eq::cor_glifo}.}
    \label{fig::glifo_ilustrado}
   \hspace{1pt}
\end{figure}

\subsection{Mapeamento de Direções em Cores}
%\subsubsection{Cor}

As componentes r, g e b do mapeamento de cor esférica do glifo é dado em função da direção $\mathbf{\hat{u}} = (u_x, u_y, u_z)$, como definido em Eq. \ref{eq::cor_glifo} e ilustrado nos glifos da Fig. \ref{fig::glifo_ilustrado}. Esta forma de mapear, além de simples, é comumente utilizado pela comunidade DWI. %\todo{É imprescincível adicionar esta informação?}\sout{Não foi implementado o cômputo de vetores normais à superfície representadas pelo glifo, que consequentemente não tem iluminação associada.}

\begin{equation}
\label{eq::cor_glifo}
    r = |u_x| ~~~~ g = |u_y| ~~~~ b = |u_z|, 
\end{equation}


A respeito de planos anatômicos, a cor vermelha (r) representa a direção mediolateral, a verde (g), se refere a direção anteroposterior, e a azul (b), a direção inferior-superior.

\subsection{Posicionamento e escala}

Renderizamos os glifos em um ambiente de visualização multimodal \cite{VMTKNeuro}, no qual estão sobrepostos ao volume anatômico co-registrado ao de difusão.

No ambiente, cada glifo é posicionado no centro de seu \textit{voxel} e é escalonado para caber nele. Assim, o usuário pode inferir sobre as ODFs reconstruída em sua respectiva amostra na cena, bem como correlacioná-la mentalmente cada dODF com as outras dODFs localizadas em suas imediações.

\subsection{Renderização interativa de glifos ODF e desafios}

Como estágio final do processamento dos sinais de difusão, armazenamos as amostras de $\boldsymbol{\psi}_d(\mathbf{r})$ min-max normalizadas em $\boldsymbol{\psi}(\mathbf{r})$ objetivando uma melhor interpretabilidade dos glifos na renderização. Fig. \ref{fig::QBall_glifos_coronal} ilustra a representação dos glifos renderizados sobrepostos ao volume de difusão no ambiente de visualização multimodal.


No próximo capítulo, propomos um novo algoritmo interativo de renderização de glifos ODF acelerado por GPU integrado ao ambiente de visualização multimodal \cite{voltoline2021} a partir das dODF min-max normalizadas pré computadas.

 \begin{figure}[H]
 %\subfigcapskip = -5pt
     \centering
     \includegraphics[width=0.7\linewidth, angle=0]{figs/Exemplos_QBall_visualizacao/Coronal.png}
     \caption{Fatia coronal do ambiente de visualização multimodal de ressonância magnética e glifos ODF. O volume é artificial e usado no ISMRM \textit{Challenge} 2015 \cite{TractometerTool}.}
      \label{fig::QBall_glifos_coronal}
  %   \hspace{1pt}
 \end{figure}

%\subsubsection{Realce}


%\input{cap3_daniel}
%\input{cap3_ting}
\input{cap3_final}


\chapter{Experimentos, resultados e discussão}
\label{sec::experimentos}

Neste capítulo, mostramos os experimentos e resultados do algoritmo de renderização proposto, bem como as funcionalidades adicionadas ao longo do tempo objetivando a interatividade.

Na Seção \ref{sec::glifos_odf_visualizacao_multimodal}, descrevemos os experimentos e resultados do algoritmo de renderização glifos ODF integrados ao ambiente de visualização multimodal. Na Seção \ref{chap::renderizacao_de_perfis_de_difusao}, apresentamos um ambiente de testes e abordamos a evolução do algoritmo de glifos ODFs feitas nesse trabalho, objetivando a interatividade que culminaram no algoritmo de renderização apresentado no Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao}.

Todos os experimentos e medições foram feitas em um computador Macbook Pro Retina 13', com processador Intel Core i5 Dual-Core 2.7GHz, processador gráfico integrado Intel Iris Graphics 6100 1536 MB e memória RAM de 8 GB 1867 MHz DDR3.

\section{Glifos ODF integrados ao ambiente de visualização multimodal}
\label{sec::glifos_odf_visualizacao_multimodal}

Propomos um experimento para avaliar aspectos visuais do nosso algoritmo de esquema de renderização em comparação à superquádricas e medições de performance para atestarmos a interatividade do algoritmo de renderização.

As imagens geradas no experimento foram coletadas a partir o WU-Minn HCP Retest Data pelo \textit{Connectome Project Consortium} \cite{essen2012}.

Os dados de difusão foram adquiridos em um \textit{scanner} Siemens 3T Skyra. A aquisição é \textit{multi-shell} com 90 gradientes de ponderação de difusão para cada \textit{shell} $b = 1000, 2000$ e $3000 s/mm^2$, e estas direções são uniformemente distribuídas nos três \textit{shells}, e adicionalmente foram escaneados 6 aquisições $b0$ para cada \textit{shell}, totalizando 288 volumes. Os dados foram pré-processados com a \textit{pipeline} de pré-processamento para dados de difusão do Human Connectomme Project (HCP) \cite{glasser2013}. A aquisição pré-processada é representada por um volume $145\times 174\times  145$ com espaço entre amostras de $1.25\times 1.25 \times 1.25$mm.

A aquisição anatômica ponderada em T1 foi também pré-processada utilizando a pipeline de pré-processamento do HCP \cite{glasser2013}. Como o seu respectivo DWI, é representada por um volume $145\times 174\times  145$ com espaço entre amostras de $1.25\times 1.25\times 1.25$mm.

As dODFs foram obtidas através do GQI \cite{yeh2010} (Capítulo \ref{chapter::metodos_hardi}) e min-max normalizadas. O fator $\sigma \sqrt{6D}$ que utilizamos é de 0,0239. As amostras foram computadas com base no hemisfério da $8^{a}$ ordem de tesselação do icosaedro e armazenadas na CPU, gerando um total de 321 amostras por \textit{voxel}.

\subsection{Aspectos Visuais}
\label{ssec::aspectos_visuais}

\subsection{Transição de Resolução}

Com o objetivo de evidenciar a diferença na resolução e quantidade de triângulos nas transições de geometria base, fizemos um experimento em que interagimos com o ambiente de visualização multimodal em que modificamos ajustamos o fator de escala na visualização tal que o $max_p$ mensurado esteja no limite da troca da a geometria base utilizada no glifo. Fig.  \ref{fig::multimodal_teste_zoom} ilustra experimento.

Fig. \ref{fig::multimodal_162_hollow} e \ref{fig::multimodal_642_hollow} correspondem aos mesmos glifos em Fig. \ref{fig::multimodal_162_filled} e \ref{fig::multimodal_642_filled}, respectivamente e estão apresentados para evidenciar a mudança na quantidade de triângulos em cada um deles. As imagens foram gerada a partir de uma janela $500 \times 500$ com uma diferença sutil no fator de escala entre ambas. Nas Fig. \ref{fig::multimodal_162_hollow} e \ref{fig::multimodal_162_filled}, o valor de $max_p$ é de 1394 \textit{pixels}, e em \ref{fig::multimodal_642_hollow} e \ref{fig::multimodal_642_filled}, é de 1409. De acordo com Eq. \ref{eq::icosa_order}, o limiar de mudança entre as geometrias é $max_p = 1406.25$.  O glifo mostra uma visão axial do corpo caloso, cujo comportamento de difusão ocorre predominantemente na direção esquerda-direita. Fig. \ref{fig::multimodal_teste_loc} mostra a localização da região mostrada em Fig. \ref{fig::multimodal_teste_zoom}.


\begin{figure}[ht]
    \centering
    %\rule{6cm}{3cm}
    \includegraphics[width=.56\linewidth, angle=0]{figs/Esquema_Glifo/Teste_transicao/base_teste_zoom.png}
    \caption{MRI T1 anatômico co-registrado com DWI. A região dentro do contorno quadrado branco corresponde a região analisada na Fig. \ref{fig::multimodal_teste_zoom}.}
    \label{fig::multimodal_teste_loc}
\end{figure}


\begin{figure}[ht]
\centering
\captionsetup[subfloat]{farskip=0pt,nearskip=0pt}
    \subfloat[$4^a$ ordem de tesselação - apenas contornos dos triângulos]{\includegraphics[width=.49\linewidth, angle=0]{figs/Esquema_Glifo/Teste_transicao/162_Hollow.png}
    \label{fig::multimodal_162_hollow}
    }
    \subfloat[$4^a$ ordem de tesselação - triângulos preenchidos] {\includegraphics[width=.485\linewidth, angle=0]{figs/Esquema_Glifo/Teste_transicao/162_filled.png}
    \label{fig::multimodal_162_filled}
    }
    \hspace{1pt}
    \subfloat[$8^a$ ordem de tesselação - apenas contornos dos triângulos]{\includegraphics[width=.495\linewidth, angle=0]{figs/Esquema_Glifo/Teste_transicao/642_Hollow.png}
    \label{fig::multimodal_642_hollow}
    }
    \subfloat[$8^a$ ordem de tesselação - triângulos preenchidos] {\includegraphics[width=.487\linewidth, angle=0]{figs/Esquema_Glifo/Teste_transicao/642_filled.png}
    \label{fig::multimodal_642_filled}
    }
    \caption{Ilustração da troca de resolução efetuada automaticamente a partir de $max_p$. A troca de resolução ocorre entre as geometrias base derivadas da $4^a$ (\ref{fig::multimodal_162_hollow} e \ref{fig::multimodal_162_filled}) e $8^a$ (\ref{fig::multimodal_642_hollow} e \ref{fig::multimodal_642_filled}) ordem de tesselação. A região ilustrada é do corpo caloso, que está em destaque na Fig. \ref{fig::multimodal_teste_loc}.
    }
    \label{fig::multimodal_teste_zoom}
\end{figure}

Podemos observar a suavidade em que a mudança de resolução ocorre. Observamos que os glifos com os triângulos preenchidos neste nível de resolução não apresentam efeitos característicos de malhas de baixa resolução e que a transição na resolução ocorre de forma sutil.

Adicionalmente, caso o usuário queira analisar os glifos mais de perto ou aumente o tamanho da janela, fazendo-a cobrir mais \textit{pixels}, o glifo é gerado a partir de uma malha suave o suficiente no qual ele tenha total liberdade para visualizar o comportamento das ODFs. Caso o usuário queira ter uma visão mais geral do volume com os glifos e diminua o fator de escala, diminuímos a resolução de cada glifo renderizado para aliviar o processamento computacional associado a cada um deles.


\subsubsection{Cruzamentos de Fibras}

Fig. \ref{fig::multimodal} ilustra uma fatia coronal na região do \textit{centrum semiovale} com um triplo cruzamento de fibras correspondentes do corpo caloso, \textit{corona radiata} e o fascículo longitudinal superior. A região apresenta cruzamentos de fibra conhecidos e é utilizada para análises qualitativas. Fig. \ref{fig::multimodal_highres} mostra que pode-se inferir sobre cada cruzamento de fibra nas regiões mais alongadas da superfície do glifo. Observe também que a resolução do glifo é diferente na Fig. \ref{fig::multimodal_lowres} em comparação a \ref{fig::multimodal_highres} e sua seleção é feita de forma automática. No fundo, há a renderização da ressonância anatômica ponderada em T1 co-registrada.

\begin{figure}[ht]
\centering
\captionsetup[subfloat]{farskip=0pt,nearskip=0pt}
    \subfloat[Fatia coronal de um MRI T1 co-registrado com DWI. A geometria base corresponde a $2^a$ ordem de tesselação do icosaedro.]{\makebox[1.2\width]{\includegraphics[width=.60\linewidth, angle=0]{figs/Esquema_Glifo/LowResImgHighlighted.png}}
    \label{fig::multimodal_lowres}
    }
    \hspace{1pt}
    
    \subfloat[Cruzamento entre fibras de corpo caloso (esquerda-direita), \textit{corona radiata} (descendente-ascendente) e fascículo longitudinal superior (anteroposterior - normal ao plano da página). A geometria base é a $8^a$ ordem de tesselação do icosaedro.] {\makebox[2.0\width]{\includegraphics[width=.45\linewidth, angle=0]{figs/Esquema_Glifo/HighResImg.png}
    \label{fig::multimodal_highres}}
    }
    \caption{Glifos ODF integrados ao ambiente de visualização multimodal para MRI. A imagem se refere a um MRI T1 cor-registrado a o seu respectivo DWI. \ref{fig::multimodal_highres} corresponde a região dentro do contorno de cor branca em \ref{fig::multimodal_lowres}.}
    \label{fig::multimodal}
\end{figure}



\citeonline{voltoline2021} evidenciaram que a sua respectiva renderização multimodal para superquádricas do DTI pode ajudar no processo de escolhas referentes a sementes em tractografia, em comparação à mapas de anisotropia codificados por cor. Fig. \ref{fig::multimodal_superquadric} ilustra a mesma região de Fig. \ref{fig::multimodal_highres} com superquádricas. Note que os glifos apresentam o mesmo problema presente no próprio DTI: em cruzamentos de fibra, a distribuição de fibras subjacente não é inferível. Pode-se perceber isto na região de cruzamento de fibras enquanto nos glifos ODF, é possível inferir sobre a natureza do cruzamento de fibras, nas superquádricas, o glifo apresenta uma forma retangular suave e não gera a possibilidade de inferir sobre as fibras que compõem o cruzamento.


\begin{figure}[ht]
    \centering
    %\rule{6cm}{3cm}
    \includegraphics[width=.35\linewidth, angle=0]{figs/Esquema_Glifo/HighResImgSuperquadric.png}
    \caption{ Renderização multimodal para superquádricos do DTI. A imagem corresponde à mesma região em Fig. \ref{fig::multimodal_highres}.}
    \label{fig::multimodal_superquadric}
\end{figure}

\subsection{Performance}
\label{ssec::performance}

Mensuramos o tempo de performance da renderização multimodal de glifos para ODF. O número de glifos é modificado pela mudança do fator de \textit{zoom}. Evidentemente que, maior o fator de \textit{zoom}, menor a quantidade de glifos, maior é a ocupância dos \textit{voxels} na tela, o que aumenta a resolução do glifos. A resolução da janela de saída é de $850\times 850$ e o número de glifos visíveis varia de 12 e 13205. A resolução dos glifos varia com a utilização de geometria base da $2^a$ ordem de tesselação do icosaedro (menor nível de detalhe, Fig. \ref{fig::multimodal_lowres}) até a $8^a$ (maior nível de detalhe, Fig. \ref{fig::multimodal_highres}). O FPS do esquema de renderização em função da quantidade de glifos renderizados e parâmetros relacionados de fator de escala e geometria base utilizados estão listados na Tabela \ref{tab::glyph_info_experiment}, onde atestamos que o esquema renderiza em taxas interativas \cite{nielsen1994}.



\begin{table}[ht]
\centering
\begin{tabular}{|cccc|}
\hline
\textbf{FPS} & \textbf{Fator de escala} & \textbf{\# glifos} & \textbf{\begin{tabular}[c]{@{}c@{}}Ordem de \\ tesselação\end{tabular}} \\ \hline
33.85 & 92.27 & 12     & 8 \\
33.69 & 61.51 & 20     & 8 \\
34.75 & 41.01 & 42     & 8 \\
34.66 & 27.34 & 90     & 8 \\
36.29 & 18.23 & 182    & 8 \\
35.97 & 12.15 & 380    & 8 \\
32.98 & 8.10  & 870    & 4 \\
35.83 & 5.40  & 1892   & 4 \\
31.92 & 3.60  & 4160   & 4 \\
22.94 & 2.40  & 9032   & 4 \\
17.15 & 1.52  & 13205  & 2  \\
\hline
\end{tabular}
\caption{Esquema de renderização multimodal com glifos de ODF renderizados em uma imagem $850\times 850$. O número de vértices e triângulos utilizados são computados de acordo com as Eq. \ref{eq::icosphere_vertices} e \ref{eq::icosphere_triangulos}. A Fig. \ref{fig::multimodal_lowres} do apêndice se refere a imagem gerada pelos parâmetros da última linha da tabela}
\label{tab::glyph_info_experiment}
\end{table}

\subsection{Renderização por Fatias}
\label{ssec::renderizacao_por_fatias}

Podemos comparar nossa abordagem com a de \citeonline{shattuck2008}, uma vez que ambas são baseadas em polígonos, onde amostras de ODF deformam uma malha esférica. Em sua abordagem, \citeonline{shattuck2008} armazena ODFs como coeficientes de funções base na CPU e os glifos são computados e visualizados em fatias, que são visualizadas de forma ortogonal. O cômputo da forma dos glifos é feito na CPU, onde o valor de ODF é computada para as normais dos vértices da malha esférica utilizada, deslocando cada um dos vértices, e o tráfego CPU-GPU consiste no envio de dados de vértices de forma que sua estrutura de dados define a superfície do glifo.

Em nossa abordagem, setamos a geometria base a priori e armazenamos amostras de dados de ODF e mostramos estratégias para escolher a geometria base adequada e estratégias para lidar com o gargalo de tráfego de dados CPU-GPU. Para atingir este objetivo, mostramos formas de organizar os dados de ODF e a da geometria base para utilizar renderização por instâncias, técnica que não estava disponível quando \citeonline{shattuck2008} publicaram seu trabalho\footnote{Em OpenGL, renderização por instâncias foi disponibilizada a partir da versão 3.2, lançada em 2009}. Adicionalmente, no processo de renderização, apenas enviamos um conjunto de escalares de ODF para deslocar a geometria base e deslocamos os pontos da malha nas \textit{threads} da GPU. Assim, o tráfego de dados por glifo é de $N/2 + (4-N/2 \mod{4})$ floats para uma geometria base com $N$ vértices. A possibilidade de diminuir o tráfego de dados por glifo para esta quantidade tem sido crucial para renderizar este glifos com malhas suaves em taxas interativas. Adicionalmente, os glifos são renderizados com apenas um comando de desenho e sua quantidade máxima é limitada pelo máximo número de elementos permitidos em uma das dimensões da textura 2D.

Uma vez que nossa abordagem é vinculada à renderização de um volume com \textit{ray-casting}, apenas os \textit{voxels} visíveis são requisitados a serem desenhados, e não há a restrição a uma fatia inteira. Além disso, no ambiente interativo de visualização, onde o usuário tem a possibilidade de mudar a escala e mover o volume, a detecção de \textit{voxels} visíveis certifica que os \textit{voxels} que estão fora da cena não são demandados na renderização, consequentemente, seus dados não são enviados à GPU e nem são processados no \textit{vertex shader} para serem descartados na rasterização.

Nosso esquema é também aplicável em renderização de glifos baseada em fatia. Observe que, o conjunto $D$ pode se referir a um conjunto de índices referentes a \textit{voxels} que definem uma fatia. Adicionalmente, os atributos de translação podem posicionar os glifos em um \textit{grid} $W \times H$, onde este atributo posiciona cada objeto ao centro de cada célula, que é escalonado pelo fator que o faz estar contido.

%Objetivando gerar resultados de performance do algoritmo e renderização em uma fatia 2-D, fizemos o seguinte experimento: os eixos x e y são divididos em $H$ intervalos ($W = H$), gerando o total de $H^2$ células quadriculadas, no qual glifos são renderizados em cada uma delas. Cada glifo é escalonado para estar contido em sua respectiva célula e posicionado em seu centro. Fixamos a geometria base, assim como os atributos de translação e, para evidenciar a interatividade do algoritmo sob a circunstância de uma frequente troca de fatias, a cada requisição de desenho, os atributos de translação e a matriz de amostras de ODF são preparados e enviados à GPU, conforme mostrado na Subseção \ref{ssec::atributos}.

%Mensuramos o FPS como uma função da quantidade de glifos renderizados com $H$ variando de 5 até 100. O gráfico de $FPS \times \text{glifos renderizados}$ é ilustrado na Fig. \ref{fig::slice_benchmark} para diferentes geometria base utilizadas em uma janela $1200\times 1200$.

% \begin{figure}[htb]
%     \centering
%     %\rule{6cm}{3cm}
%     \includegraphics[width=.65\linewidth, angle=0]{figs/Esquema_Glifo/benchmark_half_texopt.png}
%     \caption{FPS $\times$ quantidade de glifos renderizada. As cores azul, laranja, verde e vermelha correspondem a geometria base gerada pela $2^{a}$ $4^{a}$, $8^{a}$ e $16^{a}$ ordem de tesselação do icosaedro. Suas respectivas quantidades de vértices e triângulo são computadas nas Eq. \ref{eq::2ordem_icosphere_vertices} e \ref{eq::2ordem_icosphere_triangulos}, respectivamente.}
%     \label{fig::slice_benchmark}
% \end{figure}

%Os resultados indicam que nosso esquema dá resultados satisfatórios para uso interativo, e mostramos que é possível renderizar milhares de glifos em taxas interativas utilizando a $4^{a}$ ordem de tesselação do icosaedro e centenas com a malha suave gerada pela $16^{a}$ ordem de tesselação.

Na próxima seção, descrevemos uma infra-estruturada fora do ambiente de renderização multimodal para renderização de glifos ODF no qual a utilizamos para fazer testes e validações da melhora do algoritmo. Nela, apresentamos o primeiro protótipo do algoritmo, no qual tem semelhanças com o trabalho de \citeonline{shattuck2008} e as funcionalidades adicionadas ao longo do tempo. Para mensurar ganhos obtidos para cada funcionalidade adicionada, mensuramos o FPS do algoritmo para diferentes quantidade de glifos renderizadas para diferentes resoluções e comparamos com à abordagem anterior.

%Objetivando gerar resultados de performance do algoritmo e renderização em uma fatia 2-D, fizemos o seguinte experimento: os eixos x e y são divididos em $H$ intervalos ($W = H$), gerando o total de $H^2$ células quadriculadas, no qual glifos são renderizados em cada uma delas. Cada glifo é escalonado para estar contido em sua respectiva célula e posicionado em seu centro. Fixamos a geometria base, assim como os atributos de translação e, para evidenciar a interatividade do algoritmo sob a circunstância de uma frequente troca de fatias, a cada requisição de desenho, os atributos de translação e a matriz de amostras de ODF são preparados e enviados à GPU, conforme mostrado na Subseção \ref{ssec::atributos}.


%, no qual foi aperfeiçoado por \cite{almsick2011}. Esta abordagem possibilitou incrementos em performance em relação a \citeonline{shattuck2008}.

%\citeonline{raphael_dissertacao} propôs um esquema de renderização interativa do tensor de difusão em glifos superquádricos \cite{Kindlmann2004} utilizando polígonos. Em seu trabalho, os glifos são renderizados a taxas interativas e a sua abordagem consiste na minimização de tráfego de dados entre CPU-GPU, que consiste apenas em parâmetros que customizam e deslocam os glifos, e o uso de renderização por instâncias. Adicionalmente, este esquema está integrado ao VMTK-Neuro. Os resultados obtidos neste trabalho nos influenciou a adaptar o seu esquema para glifos HARDI.



%\subsection{\sout{Abordagem de renderização}}

%\sout{\citeonline{peeters2009} apresentou pela primeira vez um esquema de renderização para esta categoria de glifos, nos quais são aperfeiçoados por \citeonline{almsick2011} e \citeonline{hlawitschka2012}. Estes esquemas utilizam a abordagem \textit{raycasting}.}

%\sout{No VMTK-Neuro, um dos algoritmos de renderização do tensor difusão por glifos superquádricos é feita por instanciações de uma malha esférica, no qual é customizada por parâmetros particulares a cada tensor de difusão referentes a cada \textit{voxel} detectado e posicionado na cena de acordo. Este esquema de renderização desenha os glifos em tempo interativo.}

%\sout{Pela maior simplicidade e boa efetividade da renderização por instanciações de uma malha esférica, o esquema desenvolvido neste trabalho utiliza esta abordagem.}



%Dados relativos ao desempenho \sout{serão mais detalhados na dissertação de mestrado}\textcolor{blue}{estão disponíveis no link ...}.



%\sout{Medições do tempo relativo ao desempenho foram feitas para a quantidade de 197 vértices da malha esférica \sout{em um}\textcolor{blue}{num} volume de resolução 128x128x90. Para uma quantidade na faixa de 5000 glifos renderizados simultaneamente sobre uma fatia completa, obtemos tem um tempo de resposta entre 80 e 110ms. Para uma quantidade pequena de glifos na faixa das dezenas, o tempo de resposta cai para o intervalo entre 60 e 70ms. Esse tempo de resposta está nas proximidades ou é menor do que o tempo de 0,1s, que é o limite máximo para que o usuário tenha a percepção de resposta instantânea da máquina e que suas ações são a causa de que algo aconteça na tela \cite{nielsen1994}.}

%\sout{No cômputo das ODFs do \textit{QBall}, é feito o mapeamento do sinal de DWI para a ODF a partir das direções derivadas da malha esférica. O glifo para visualização é gerado diretamente de acordo a representação gráfica polar esférica em que $R(\textbf{u}) = \psi(\mathbf{u})$, onde \textbf{u} é a direção de difusão. A malha esférica utilizada para geração dos glifos em \ref{section::QBall_Glifos} está representada na figura \ref{fig::MalhaEsferico}.}

%A priori, todas as ODFs são calculadas e normalizadas para o intervalo $[0,1]$ para cada um dos \textit{voxels} do volume e referenciadas no processo de renderização.

%O formato de armazenamento dos valores ODF associados à malha consiste numa lista de valores escalares associados a cada um dos \textit{voxels}.



%\todo[inline]{Falta uma descrição melhor de como são construídos os glifos a partir de ODFs e o seu mapeamento às entidades gráficas. Isso torna difícil o entendimento da sua implementação. !!Descrito em trabalhos relacionados!}
\section{Funcionalidades adicionadas e ganhos de performance}
\label{chap::renderizacao_de_perfis_de_difusao}

Nesta seção, abordamos a evolução do algoritmo de renderização de glifos ODF feitas neste mestrado objetivando a interatividade. Apresentamos o ambiente de testes, o protótipo inicial e todas as funcionalidades adicionais que implementamos durante o trabalho que culminaram no algoritmo de renderização apresentado no Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao}.

Na Seção \ref{sec::ambiente_teste}, descrevemos o ambiente de teste que implementamos para fazer a validação  de todas as funcionalidades adicionadas no algoritmo de renderização.


Na Seção \ref{sec::primeiro_prototipo}, descrevemos o primeiro protótipo do algoritmo, onde o utilizamos na infraestrutura do ambiente de visualização multimodal para renderização dos glifos. Inicialmente, o protótipo consistiu em uma ferramenta visual para visualização de dados de ODFs em seus respectivos \textit{voxels}.

O primeiro protótipo do algoritmo integrada ao ambiente de visualização multimodal não renderizava de forma interativa, então passamos a explorar ferramentas proporcionadas pela GPU e características da percepção visual humana para que pudéssemos otimizá-lo objetivando a interatividade.

Assim, na Seção \ref{sec::renderizacao_por_instancias} discutimos o uso da instanciação da GPU para renderização dos glifos; na Seção \ref{sec::otimizacao_da_simetria} mostramos como podemos tomar vantagem da simetria das ODFs e melhorar a performance de renderização; na Seção \ref{sec::estrutura_de_dados_para_textura_RGBA} mostramos como podemos minimizar o uso de memória de textura da GPU e seu impacto em performance; e na Seção \ref{sec::adaptatividade_de_resolucao} discutimos como exploramos a percepção visual humana para tornar a resolução dos glifos adaptativa. A ordem de disposição das seções é coerente com a ordem cronológica de integração de cada funcionalidade.

Nas Seções \ref{sec::renderizacao_por_instancias}, \ref{sec::otimizacao_da_simetria} e \ref{sec::estrutura_de_dados_para_textura_RGBA}, fizemos a validação da funcionalidade adicionada no algoritmo pela comparação gráfica em FPS médio de cada procedimento em relação à seção anterior através do ambiente de teste.% para cada resolução de malha utilizada.

Na Seção \ref{sec::adaptatividade_de_resolucao}, introduzimos a adaptabilidade na resolução como uma função da máxima quantidade de \textit{pixels} contidos em um único \textit{voxel}, o que é algo intrínseco à métricas do ambiente de visualização multimodal. A validação da inserção deste tópico está nos resultados mostrados na Tabela \ref{tab::glyph_info_experiment}, no qual comparamos com o algoritmo de renderização de glifos ODF integrado ao ambiente de visualização multimodal onde a resolução dos glifos é fixa e derivada da $8^a$ ordem de tesselação do icosaedro, que está anotada na Tabela \ref{tab::glyph_info_experiment_fixed}.

%As medições foram feitas em um computador Macbook Pro Retina 13', com processador Intel Core i5 Dual-Core 2.7GHz, processador gráfico integrado Intel Iris Graphics 6100 1536 MB e memória RAM de 8 GB 1867 MHz DDR3. 



\subsection{Ambiente de teste e validação}
\label{sec::ambiente_teste}

Para validar funcionalidades adicionadas que resultam em melhor performance no algoritmo de renderização, fizemos um ambiente para testes. Em uma janela de resolução $1200 \times 1200$ \textit{pixels}, dividimos os eixos x e y em $H$ intervalos, gerando $H^2$ células quadradas, nos quais os glifos são renderizados em cada uma delas, conforme mostrado em Fig. \ref{fig::ambiente_validacao}.

Cada glifo é deslocado ao centro da sua respectiva célula e escalonado para caber nela, tendo a sua geometria base fixa. A cada requisição de desenho, todos os atributos de translação e os dados que geram os glifos e que consistem no tráfego de dados CPU-GPU são enviados à GPU, o que é demandado no ambiente de visualização multimodal, conforme mostrado no fluxograma da Fig. \ref{fig::vmtk_simplified}.

\begin{figure}[ht]
\centering
\captionsetup[subfloat]{farskip=5pt,nearskip=0pt}
    %!!VER SE ISSO TA CERTO
    \subfloat[H = 5. 25 glifos renderizados] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Ilustracao_ambiente/ambiente_5.png}
    \label{fig::ambiente_validacao_5}
    }
    \subfloat[H = 25. 625 glifos renderizados]{\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Ilustracao_ambiente/ambiente_25.png}
    \label{fig::ambiente_validacao_25}
    }
    
    \subfloat[H = 50. 2500 glifos renderizados]{\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Ilustracao_ambiente/ambiente_50.png}
    \label{fig::ambiente_validacao_50}
    }
    \subfloat[H = 100. 10000 glifos renderizados]{\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Ilustracao_ambiente/ambiente_100.png}
    \label{fig::ambiente_validacao_100}
    }
     \caption{Ambiente de avaliação do algoritmo de renderização para ODFs. As cores dos glifos referenciam a direção dos eixos de acordo com a Eq. \ref{eq::cor_glifo}.}
    %\hfill
    \label{fig::ambiente_validacao}
\end{figure}

Variamos a quantidade de células $H$ de cinco até cem, anotamos os dados de FPS médio e os mostramos de forma gráfica. Fizemos os experimentos utilizando  as esferas obtidas através da $2^a$, $4^a$, $8^a$ e $16^a$ ordem de tesselação do icosaedro como geometria base.

 No ambiente, as amostras que geram os glifos são computadas a priori a partir de ODFs computadas a partir de funções harmônicas esféricas, cujo o grau das funções varia de zero a três. Utilizamos esta classe de funções porque geram glifos conhecidos\footnote{A página https://chem.libretexts.org/@go/page/283935 oferece a visualização das funções harmônicas esféricas em plotagens polares esféricas.}, o que serviu de suporte para depuração. Esta classe de funções também é comumente utilizada pela comunidade de pesquisa de métodos de alta ordem em DWI \cite{Tournier2004DirectEO, tournier2007, descoteaux2007_QBI}.% e \citeonline{descoteaux2007_QBI} faz uma apresentação delas aplicada a esta área.



Indexamos as células nas quais os glifos são renderizados como $1$, $2$, ..., $M$, cuja sequência é crescente na ordem esquerda para direita, cima e para baixo, e $M = H^2$. Associamos o conjunto de amostras a serem renderizadas na $j$-ésima $(1 \leq j \leq M)$ célula como $\boldsymbol{\psi}(j) = [
\psi(j, \mathbf{n}_1), 
\psi(j, \mathbf{n}_2), 
\psi(j, \mathbf{n}_3), ..., 
\psi(j, \mathbf{n}_N)
]^T$, onde $\mathbf{n}_k$ é o vetor unitário com direção e sentido associado à normal do ponto $P_k$ de uma malha esférica $(\Pi, I)$, onde $\Pi = [P_1, P_2, \dots, P_N]$. $I_{3\tau \times 1}$ é o conjunto de índices que triangulam $\Pi$ afim de gerar a malha esférica, onde $\tau$ é a quantidade de triângulos da malha.%\footnote{Escolhemos esta forma de indexar as variáveis envolvidas para que fique similar à forma utilizada no Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao}.}

Utilizamos dez funções harmônicas esféricas, em que, na Fig. \ref{fig::ambiente_validacao_5}, da esquerda para direita e parte superior para inferior, consistem em: $Re(Y_1^{-1})$,
$Re(Y_1^0)$,
$Im(Y_1^{-1})$,
$Re(Y_2^{-2})$,
$Im(Y_2^{-2})$,
$Re(Y_2^{-1})$,
$Im(Y_2^{-1})$,
$Y_2^0$,
$Y_0^0$ e
$Y_3^0$, onde $Y_l^m$ se refere a harmônica esférica de grau $l$ e ordem $m$. Na Seção \ref{sec::harmonicas_esfericas} do Apêndice, escrevemos a formulação analítica das funções utilizadas. Fazemos a associação entre cada $\boldsymbol{\psi}(j)$, a sua respectiva harmônica esférica de acordo com a Tabela \ref{tab::harmonicas_esfericas}, na qual computamos o seu valor absoluto e fazemos a normalização min-max para o intervalo $[0, 1]$ dos valores amostrados\footnote{No caso da harmônica esférica $(Y_0^0)$, que é constante e mapeada em um glifo esférico, normalizamos a função para ser constante igual a um.}, que são pré-computadas na CPU. Fig. \ref{fig::ambiente_validacao} ilustra os glifos no ambiente de teste para diferentes valores de $M$. O cômputo do valor absoluto torna estas funções simétricas em relação ao eixos coordenados, assim como as funções e sinais de difusão.

\begin{table}[ht]
\centering
\begin{tabular}{cc}
$j \mod 10$ & Harmônica Esférica \\ \hline
1 & $Re(Y_1^{-1})$  \\
2 & $Re(Y_1^0)$     \\
3 & $Im(Y_1^{-1})$  \\
4 & $Re(Y_2^{-2})$  \\
5 & $Im(Y_2^{-2})$  \\
6 & $Re(Y_2^{-1})$  \\
7 & $Im(Y_2^{-1})$  \\
8 & $Y_2^0$         \\
9 & $Y_0^0$         \\
0 & $Y_3^0$        
\end{tabular}
\caption{Associação de índice de célula para função harmônica esférica utilizada. Adicionamos o cômputo dos valores absolutos e fizemos a normalização min-max para cômputo de $\boldsymbol{\psi}(j)$. Os glifos ODF estão ilustrados em Fig. \ref{fig::ambiente_validacao}.}
\label{tab::harmonicas_esfericas}
\end{table}




\subsection{Primeiro protótipo}
\label{sec::primeiro_prototipo}

No primeiro protótipo, recebendo um conjunto de índices de células cujos glifos ODF são renderizados $D = [
1,
2, ..., 
M
]$, o esquema gera três matrizes $\mathbf{V}$, $I^D$ e $T$ a serem enviados à GPU em função de todas as amostras min-max normalizadas referentes a
$\boldsymbol{\psi}(1)$,
$\boldsymbol{\psi}(2)$, ...,
$\boldsymbol{\psi}(M)$ pré-computadas na CPU. $\mathbf{V}$, se refere ao conjunto de vértices de todos os glifos, $I^D$, se refere ao conjunto de índices que triangulam os vértices dos glifos e $T$ consiste nos dados de translação para as células.

%Para geração dos glifos, uma malha esférica base ($\Pi, I$) é utilizada, Onde $\Pi_{3\times N} = [P_1, P_2, \dots, P_N]$ é o conjunto de vértices da malha, onde $P_k = [P_{xk}, P_{yk}, P_{zk}]^T$, e $I_{3\tau \times 1}$ é o conjunto de índices que triangulam $\Pi$ afim de gerar a malha esférica, onde $\tau$ é a quantidade de triângulos da malha.

%O primeiro vetor, que consistia no conjunto de vértices de todos os glifos renderizados nos seus respectivos sistemas de coordenadas. Para isso, os vértices da malha esférica , $P_k = [P_{xk}, P_{yk}, P_{zk}]^T$ é armazenada e referenciada na CPU.

Na CPU, a matriz $\mathbf{V}_{3\times N\cdot M}$ que contém todos os vértices de todos os glifos é definida. Para isto, cópias dos vértices da malha esférica $\Pi$ são escalonados pelas amostras de ODF dos glifos a serem renderizados, compondo-a, como mostrado na Eq. \ref{eq::vertices_prototipo1}:

\begin{equation}
\label{eq::vertices_prototipo1}
    \mathbf{V} = 
    \begin{bmatrix}
    \Pi\cdot\boldsymbol{\psi}(1)^D &
    \Pi\cdot\boldsymbol{\psi}(2)^D &
    \Pi\cdot\boldsymbol{\psi}(3)^D & \cdots &
    \Pi\cdot\boldsymbol{\psi}(M)^D
    \end{bmatrix}
    ,
\end{equation}
onde $\boldsymbol{\psi}(j)_{N\times N}^D$ é a matriz diagonal, onde $\boldsymbol{\psi}(j)^D[i, i] = \boldsymbol{\psi}(j, \mathbf{n}_i)$.% em que $\mathbf{n}_i$ é o vetor unitário com direção e sentido da normal de $P_i$.

Também na CPU, o vetor $I_{3 \tau M \times 1}^D$ é definido e consiste na replicação de $I$ para formar as malha esférica esféricas de cada um dos objetos definidos por $\Pi\cdot\boldsymbol{\psi}(j)^D$. Como todos os glifos são triangulados da mesma forma, $I^D$ consiste em $M$ replicações de $I$ dispostas em sequência, na qual a $j$-ésima replicação consiste na adição de um fator de índice dado por $j\cdot N$. Logo $I^D$ tem a seguinte formulação:
\begin{equation}
\label{eq::index_prototipo1}
    I^D = 
    \begin{bmatrix}
    I \\
    (I +  N\mathbf{1}_{3\tau}  ) \\
    (I + 2N\mathbf{1}_{3\tau} ) \\ \vdots \\ 
    (I + MN\mathbf{1}_{3\tau})
    \end{bmatrix}
    ,
\end{equation}
onde $\mathbf{1_{3\tau}}$ é o vetor coluna com todos os $3\tau$ elementos iguais a um.

Por último e também na CPU, a matriz $T_{3 \times MN}$ consiste no conjunto de atributos de translação, que são aplicados aos vértices dos glifos no \textit{vertex shader}. Para isto, considerando as coordenadas de translação para o centro de cada célula $j$ como $V_j = [V_{jx}, V_{jy}, V_{jz}]^T$, formulamos $T_{3 \times MN}$:

\begin{equation}
\label{eq::translation_prototipo1}
    T_{3 \times MN} =
    \begin{bmatrix}
    V_1 \cdot \mathbf{1}_N^T &
    V_2 \cdot \mathbf{1}_N^T &
    V_3 \cdot \mathbf{1}_N^T & \cdots &
    V_M \cdot \mathbf{1}_N^T
    \end{bmatrix}
,
\end{equation}
onde $\mathbf{1}_N$ é o vetor coluna com todos os N elementos iguais a um.

$\mathbf{V}$, e $T$ são enviados à GPU como atributos e $I^D$ é enviado para referenciar $\mathbf{V}$ e $T$ afim de formar os triângulos. As transformações geométricas feitas na GPU consistem na translação de cada glifo ao centro de sua respectiva célula e escala para cada glifo caber em sua célula, cujo parâmetro é enviado à GPU uma vez como variável uniforme. A renderização é efetuada com apenas um comando de desenho.

%A cor é definida na GPU através da normalização do vértice do glifo no \textit{vertex shader}.%, e há um problema quando ODFs para cômputo direto na GPU de ODFs mapeadas em zero, no qual, neste experimento, quando isso ocorre, mapeamos em branco.

Os resultados em FPS desta abordagem estão mostrado na Fig. \ref{fig::FPS_prototipo_1}. Este protótipo é o mais próximo da abordagem \citeonline{shattuck2008}. A similaridade reside em que os vértices dos glifos são computados na CPU, mas, enquanto na nossa abordagem, as amostras já são pré-computadas, \citeonline{shattuck2008} as computa na CPU em tempo de execução a partir de funções base.% implicando um custo computacional maior para renderização, que é compensado pelo menor uso de memória da CPU, pois os dados de ODF são codificados como coeficientes de funções base.



\begin{figure}[htb]
    \centering
    %\rule{6cm}{3cm}
    \includegraphics[width=.65\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/FPS_prototipo1_Geral.png}
    \caption{FPS $\times$ quantidade de glifos renderizada do primeiro protótipo. As cores azul, laranja, verde e vermelha correspondem a geometria base gerada pela $2^{a}$ $4^{a}$, $8^{a}$ e $16^{a}$ ordem de tesselação do icosaedro, respectivamente. Suas quantidades de vértices e triângulo são computadas nas Eq. \ref{eq::icosphere_vertices} e \ref{eq::icosphere_triangulos}, respectivamente.}
    \label{fig::FPS_prototipo_1}
\end{figure}

Esta abordagem gera um tráfego de dados excessivo entre CPU-GPU. Observe que a quantidade de dados por glifo consiste em: $N$ vértices de glifos, $3\tau$ conjunto de índices e $N$ coordenadas de translação. Codificando os vértices e coordenadas de translação em \textit{floats} e o conjunto de índices como inteiro sem sinal, onde cada um destes tipos possui quatro bytes, temos um tráfego CPU-GPU de $24N + 12\tau$ bytes por glifo. Adicionalmente, há uma redundância excessiva na quantidade de dados referentes a translação, e as operações de geração de glifos através do escalonamento dos pontos da esfera podem ser paralelizados, o que torna o uso da GPU para seu cômputo uma potencial vantagem.

Observe que mesmo com o tráfego de dados excessivo, foi possível obter uma taxa de quadros razoável com as subdivisões de $2^a$ e $4^a$ ordem.

%Poderíamos usar $M$ chamadas de desenhos, em que $I$ seria colocado na GPU como um procedimento inicial, e a cada comando de desenho, os dados de vértices dos glifo $d_k$ de ODF são computados e baixados como atributos na GPU; e de translação $V_k$ como uma variável uniforme, levando a um tráfego de $3N + 3$ floats, totalizando $12N + 12$ \textit{bytes}. Mas, o uso de instanciação da GPU, como mostrada na Seção \ref{sec::renderizacao_por_instancias}, provê um tráfego de dados menor, além do uso de apenas um comando de desenho.


\subsection{Instanciação}
\label{sec::renderizacao_por_instancias}

Com o objetivo de diminuir o tráfego de dados e a redundância nos dados de translação, bem como paralelizar o escalonamento dos vértices na malha esférica base afim de obtermos os vértices do glifo, utilizamos renderização por instâncias.

A malha esférica base $(\Pi, I)$ e o parâmetro de escala são enviados à GPU a priori. A malha é instanciada $M$ vezes para os $M$ glifos a renderizar e o parâmetro de escala é enviado como uma variável uniforme. A cada requisição de desenho, parâmetros de ODF min-max normalizada e translação consistem no tráfego de dados CPU-GPU.

O parâmetro de translação deixa de ser um atributo por vértice e se torna um atributo único por instância. Para isso, redefinimos $T$ na CPU, como a seguinte matriz:

\begin{equation}
\label{eq::vertices_prototipo2}
    T_{3\times M} = 
    \begin{bmatrix}
    V_1 & V_2 & V_3 & \cdots & V_M
    \end{bmatrix}
    .
\end{equation}

Definimos a matriz $\boldsymbol{\mathscr{R}}_{N \times M}$, computada na CPU, e que consiste em todas as amostras de ODF que sintetizam os glifos a serem renderizados nas células:%, ilustrada em Eq. \ref{eq::odf_prototipo2}.

\begin{equation}
\label{eq::odf_prototipo2}
\boldsymbol{\mathscr{R}} = 
\begingroup % keep the change local
\setlength\arraycolsep{2pt}
\begin{bmatrix} 
    \psi(1, \mathbf{n}_1) &
    \psi(2, \mathbf{n}_1) & \cdots & 
    \psi(M, \mathbf{n}_1)  \\
    
    \psi(1, \mathbf{n}_2) &
    \psi(2, \mathbf{n}_2) & \cdots & 
    \psi(M, \mathbf{n}_2) \\ \vdots & \vdots & \vdots & \vdots  \\
    
    \psi(1, \mathbf{n}_N) & 
    \psi(2, \mathbf{n}_N) & \cdots & 
    \psi(M, \mathbf{n}_N)
\end{bmatrix}
\endgroup
\end{equation}

Enviamos $\boldsymbol{\mathscr{R}}$ como uma textura 2D, de formato $RED$ e com dimensões $N\times M$. Observe que o acesso na GPU dos elementos pode ser feito a partir dos pares índice de instância e índice de vértice. Na $j$-ésima instância, onde o glifo da $j$-ésima célula é processado, o \textit{lookup} na GPU é feito através da função \textit{texelFetch} das coordenadas não normalizadas $(j, Vertex\_ID)$. O acesso da ODF min-max normalizada no processamento do vértice em sua respectiva instância é feito pela leitura do valor da componente $R$ do $RGBA$ do \textit{texel}.

Após o envio de $\boldsymbol{\mathscr{R}}$ e $T$ à GPU, em adição à Seção \ref{sec::primeiro_prototipo}, o \textit{lookup} de ODFs e o escalonamento dos vértices da malha esférica base efetuada para geração do glifo é feita no \textit{vertex shader} e somente um comando de desenho é efetuado.

Fig. \ref{fig::FPS_prototipo_2} traz os resultados gráficos em FPS de forma comparativa da renderização por instâncias com o primeiro protótipo.

\begin{figure}[htb]
\centering
\captionsetup[subfloat]{farskip=5pt , nearskip=0pt}
    %!!VER SE ISSO TA CERTO
    \subfloat[Tesselação de $2^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0] {figs/Renderizacao_glifos_evolucao/Prototipo2/prototipo_2_42.png}
    \label{fig::FPS_prototipo_2_42}
    }
    \subfloat[Tesselação de $4^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Prototipo2/prototipo_2_162.png}
    \label{fig::FPS_prototipo_2_162}
    }
    
    \subfloat[Tesselação de $8^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Prototipo2/prototipo_2_642.png}
    \label{fig::FPS_prototipo_2_642}
    }
    \subfloat[Tesselação de $16^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Prototipo2/prototipo_2_2562.png}
    \label{fig::FPS_prototipo_2_2562}
    }
     \caption{FPS $\times$ Quantidade de glifos para diferentes tesselações do icosaedro. A linha preta ilustra o FPS do primeiro protótipo, enquanto a linha azul mostra o FPS da utilização da instanciação da GPU.}
    %\hfill
    \label{fig::FPS_prototipo_2}
\end{figure}


Note que o tráfego de dados CPU-GPU cai drasticamente. Para cada glifo, $N$ valores escalares de ODF são enviados a GPU, adicionalmente, conseguimos sintetizar as coordenadas de translação em um atributo único por glifo, e o conjunto de índices é apenas enviado uma vez, o que elimina o tráfego de dados relacionado a esta variável. Assim, o tráfego de dados por glifo cai para $N + 3$ \textit{floats}, totalizando $4N + 12$ \textit{bytes}. Adicionalmente, a malha esférica base é escalonada para gerar o glifo de forma paralela na GPU.

Note também que, para $8^a$ e $16^a$ ordem de tesselação, o FPS mais que dobra para milhares de glifos renderizados. Observe também que neste ambiente, conseguimos renderizar mais de 3000 glifos em taxas interativas \cite{nielsen1994} a partir da malha suave gerada pela $16^a$ ordem de tesselação do icosaedro. O uso de renderização por instâncias e a diminuição do tráfego de dados de amostras de ODF para apenas amostras escalares enviadas como textura foi o ponto mais crucial neste trabalho rumo a interatividade.

\subsection{Exploração da simetria}
\label{sec::otimizacao_da_simetria}

Nesta seção, exploraremos a simetria das ODFs, i.e. $\psi(j, \mathbf{n}) = \psi(j, -\mathbf{n})$, para que possamos diminuir o tráfego de dados de ODF discutidos na Seção \ref{sec::renderizacao_por_instancias}. Para isto, impomos a nossa primeira condição: apenas malhas esféricas com pontos simétricos em relação aos eixos são utilizadas, e os simétricos estão em sequência na memória, ou seja, em $\Pi$, N é par e $P_{2i+2} = -P_{2i+1}$, $(0 \leq i \leq \frac{N-2}{2})$, nos levando a uma estrutura de dados $\Pi = [P_1, -P_1, P_3, -P_3, \dots, P_{N-3}, -P_{N-3}, P_{N-1}, -P_{N-1}]$. Tal como na Seção \ref{sec::renderizacao_por_instancias}, enviamos $(\Pi, I)$ à GPU a priori para ser instanciada $M$ vezes.

Reestruturamos os dados
$\boldsymbol{\psi}(j)_{N\times 1} = [
\psi(j, \mathbf{n}_1), 
\psi(j, \mathbf{n}_2), 
\psi(j, \mathbf{n}_3), ..., 
\psi(j, \mathbf{n}_N)
]^T$ para
$\boldsymbol{\psi}(j)_{\frac{N}{2}\times 1} =[
\psi(j, \mathbf{n}_1), 
\psi(j, \mathbf{n}_3), ...
\psi(j, \mathbf{n}_{N-3}),
\psi(j, \mathbf{n}_{N-1})
]^T$.

Neste contexto, na formação do glifo ODF na $j$-ésima célula, na i-ésima posição $\psi(j, \mathbf{n}_{2i-1})$ escalona os pontos $P_{2i-1}$ e $P_{2i}$ da esfera na $j$-ésima instância. Logo, reestruturamos $\boldsymbol{\mathscr{R}}$ para que se torne $\boldsymbol{\mathscr{R}}_{\frac{N}{2}\times M}$, tal que:

\begin{equation}
\label{eq::odf_prototipo3}
\boldsymbol{\mathscr{R}} = 
\begingroup % keep the change local
\setlength\arraycolsep{2pt}
\begin{bmatrix} 
    \psi(1, \mathbf{n}_1) &
    \psi(2, \mathbf{n}_1) & \cdots & 
    \psi(M, \mathbf{n}_1)  \\
    
    \psi(1, \mathbf{n}_3) &
    \psi(2, \mathbf{n}_3) & \cdots & 
    \psi(M, \mathbf{n}_3) \\ \vdots & \vdots & \vdots & \vdots  \\
    
    \psi(1, \mathbf{n}_{N-1}) & 
    \psi(2, \mathbf{n}_{N-1}) & \cdots & 
    \psi(M, \mathbf{n}_{N-1})
\end{bmatrix}
\endgroup
\end{equation}

Assim como na Seção \ref{sec::renderizacao_por_instancias}, enviamos $\boldsymbol{\mathscr{R}}$ à GPU como uma textura 2D, de formato $RED$, com dimensões $\frac{N}{2}\times M$. Observe que o acesso na GPU dos elementos é modificado em função do \textit{Vertex\_ID}. Na $j$-ésima instância, onde o glifo da $j$-ésima célula é processado, o \textit{lookup} na GPU é feito através da função \textit{texelFetch} das coordenadas não normalizadas $\lfloor (j, Vertex\_ID/2)\rfloor$. O acesso da ODF min-max normalizada no processamento do vértice em sua respectiva instância é feito pela leitura do valor da componente $R$ do \textit{texel}\footnote{A função em OpenGL para \textit{lookup} em função dos índices de instância e vértice é dada por texelFetch($\boldsymbol{\mathscr{R}}$,ivec2((gl\_VertexID)/2, gl\_InstanceID), 0).r.}, conforme ilustrado na Fig. \ref{fig::texelfetch_prototipo3}.

\begin{figure}[htb]
%\subfigcapskip = -5pt
    \centering
    \includegraphics[width=.35\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/texellookup_RED_2.png}
    \caption{Ilustração do acesso nas componentes RGBA em \textit{texel} na textura \textbf{R} no índice $K$ e $j$. O \textit{texel} é acessado pelas \textit{threads} que processam os vértices de índices 2K e 2K+1 em uma instância $j$. Os blocos de contorno vermelho, azul, verde e cinza ilustram as componentes R,G,B e A do \textit{texel}, respectivamente. Observe que as componentes G, B e A são inicializadas com valores \textit{default}.}
    \label{fig::texelfetch_prototipo3}
   %\hspace{1pt}
\end{figure}


Fig. \ref{fig::FPS_prototipo_3} traz de forma a performance em FPS da funcionalidade adicionada nesta seção de forma comparativa à Seção \ref{sec::renderizacao_por_instancias}.

\begin{figure}[H]
\centering
\captionsetup[subfloat]{farskip=5pt,nearskip=0pt}
    %!!VER SE ISSO TA CERTO
    \subfloat[Tesselação de $2^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Prototipo3/prototipo_3_42.png}
    \label{fig::FPS_prototipo_3_42}
    }
    \subfloat[Tesselação de $4^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Prototipo3/prototipo_3_162.png}
    \label{fig::FPS_prototipo_3_162}
    }
    
    \subfloat[Tesselação de $8^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Prototipo3/prototipo_3_642.png}
    \label{fig::FPS_prototipo_3_642}
    }
    \subfloat[Tesselação de $16^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Prototipo3/prototipo_3_2562.png}
    \label{fig::FPS_prototipo_3_2562}
    }
     \caption{FPS $\times$ Quantidade de glifos para diferentes tesselações do icosaedro. A linha pontilhada azul ilustra o FPS do segundo protótipo, enquanto a linha vermelha mostra o FPS quando tomamos vantagem da simetria das ODF.}
    %\hfill
    \label{fig::FPS_prototipo_3}
\end{figure}



Observe que esta otimização faz o tráfego de dados CPU-GPU ser reduzido de $N + 3$ para $N/2 + 3$ \textit{floats}, totalizando $2N + 12$ bytes. Em termos de performance, observe em Fig. \ref{fig::FPS_prototipo_3_642} e \ref{fig::FPS_prototipo_3_2562} que aproximadamente 4900 e 1225 glifos puderam ser renderizados a 60 FPS para $8^a$ e $16^a$ ordem de tesselação, enquanto na abordagem em que não tomamos vantagem da simetria, 3600 e 900 puderam ser gerados.

Por outro lado, observe que os maiores ganhos de performance ocorrem na faixa que compreendem 600 a 1600 glifos para $16^a$ ordem de tesselação e 2400 até 5000 glifos para para $8^a$ ordem, no qual, nesta região, há um ganho em FPS acima de 20\%.

Note que as componentes B, G e A do \textit{texel} são alocadas, setadas para valores padrão e não são utilizadas\footnote{Informações sobre a alocação de memória em uma textura de formato RED e RGBA podem ser encontradas em https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/glTexImage2D.xhtml}. Adicionalmente, as componentes R, G, B e A na memória de textura em cada \textit{texel} estão em sequência na GPU e nesta abordagem, as amostras que sintetizam o glifo estão espaçadas em 3 \textit{floats}. Neste leiaute de memória, no qual os coeficientes de ODF não estão em sequência, alocamos memória em excesso da GPU para valores não utilizados (componentes B, G e A de cada \textit{texel}) e não utilizamos o cache da GPU de forma ótima.



\subsection{Estrutura de dados para textura RGBA}
\label{sec::estrutura_de_dados_para_textura_RGBA}

Para evitar o desperdício de memória e mal uso do cache da GPU, enviamos $\boldsymbol{\mathscr{R}}$ como uma textura de formato RGBA, de tamanho $\lceil \frac{N/2}{4}\rceil \times M$ em que agrupamos os valores escalares da $j$-ésima coluna em sequência de quatro em quatro. Se $N/2$ não é divisível por quatro, é necessária a inserção de linhas com valores \textit{dummy} em $\boldsymbol{\mathscr{R}}$ afim de completar a divisibilidade por quatro, para que cada coluna da matriz possa ser acessada via índice de instância.

Assim, em cada \textit{texel} há quatro amostras de ODF que escalonam 8 pontos da malha esférica. No Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao}, a Fig. \ref{fig::texelfetch} ilustra a forma que o \textit{lookup} é feito, onde neste contexto $j = d_j$. O argumento da função \textit{texelFetch} para a $j$-ésima instância se torna as coordenadas não-normalizadas $(j, \lfloor \frac{Vertex\_ID}{8} \rfloor)$ e o acesso do ponto processado ao seu respectivo valor de ODF min-max normalizado, considerando que as componentes R, G, B e A são mapeados nos índices 0, 1, 2 e 3 nos \textit{texels} é mapeado por $\lfloor Vertex\_ID \mod{8}/2 \rfloor$.

Fig. \ref{fig::FPS_prototipo_4} traz de forma comparativa o FPS gerado por esta nova organização de $\boldsymbol{\mathscr{R}}$ no envio como textura em comparação à Seção \ref{sec::otimizacao_da_simetria}.

\begin{figure}[ht]
\centering
\captionsetup[subfloat]{farskip=5pt,nearskip=0pt}
    %!!VER SE ISSO TA CERTO
    \subfloat[Tesselação de $2^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Prototipo4/prototipo_4_42.png}
    \label{fig::FPS_prototipo_4_42}
    }
    \subfloat[Tesselação de $4^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Prototipo4/prototipo_4_162.png}
    \label{fig::FPS_prototipo_4_162}
    }
    
    \subfloat[Tesselação de $8^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Prototipo4/prototipo_4_642.png}
    \label{fig::FPS_prototipo_4_642}
    }
    \subfloat[Tesselação de $16^a$ ordem] {\includegraphics[width=.45\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Prototipo4/prototipo_4_2562.png}
    \label{fig::FPS_prototipo_4_2562}
    }
     \caption{FPS $\times$ Quantidade de glifos para diferentes tesselações do icosaedro. A linha pontilhada vermelha ilustra o FPS do terceiro protótipo, enquanto a linha magenta mostra o FPS do uso das componentes RGBA dos \textit{texels} da memória de textura.}
    %\hfill
    \label{fig::FPS_prototipo_4}
\end{figure}


Observe que este procedimento faz o tráfego de dados CPU-GPU ser sutilmente aumentado para $N/2 + 3 + (4 -N/2 \mod{4})$ \textit{floats} por glifo, mas a quantidade de memória alocada para $\boldsymbol{\mathscr{R}}$ na GPU cai para aproximadamente um quarto em comparação à abordagem anterior.

Observe que há um aumento em FPS quando milhares de glifos são renderizados a partir das malhas da $8^a$ e $16^a$ ordem de subdivisão. Na subdivisão de ordem 8, o ganho em FPS é acima de 10\% para mais de 5600 glifos. Na subdivisão de ordem 16, o ganho de FPS é cerca de 10\% para 1600 glifos renderizados e se estabiliza na faixa de 15\% para mais de 5600 glifos renderizados. Por outro lado, a diferença é desprezível quando a quantidade de glifos renderizados é menor que 1000 para estas malhas e totalmente desprezível quando utilizamos as tesselações de ordem dois e quatro.


%Isso ocorre devido a maior alocação de dados de ODF no cache da GPU devido a este procedimento.


\subsection{Adaptatividade de resolução}
\label{sec::adaptatividade_de_resolucao}

Aplicamos todos os conceitos apresentados até a versão do algoritmo de renderização de ODFs, apresentada na Seção \ref{sec::estrutura_de_dados_para_textura_RGBA}, integramos ao ambiente de visualização multimodal e fizemos as medições de performance conforme descrita na Seção \ref{ssec::performance}, onde utilizamos a tesselação de $8^a$ ordem do icosaedro de forma fixa.

No experimento, integramos o algoritmo à estrutura apresentada no Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao}, no qual algoritmo é integrado ao ambiente multimodal e recebe apenas o conjunto de \textit{voxels} detectados como entrada. O cômputo do parâmetro de ocupância do glifo ($max_p$) efetuado na GPU e o algoritmo de escolha da geometria base foram desativados para fins de teste. Adicionalmente, usamos o mesmo volume e métodos descrito na seção \ref{sec::experimentos} do Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao} para gerar os resultados. Os resultados estão apresentados na Tabela \ref{tab::glyph_info_experiment_fixed}.

\begin{table}
\centering
\begin{tabular}{|cccc|}
\hline
\textbf{FPS} & \textbf{Fator de escala} & \textbf{\# glifos} & \textbf{\begin{tabular}[c]{@{}c@{}}Ordem de \\ tesselação\end{tabular}} \\ \hline
34.29 & 86.50 & 12     & 8 \\
35.23 & 58.15 & 20     & 8 \\
35.43 & 38.76 & 42     & 8 \\
35.83 & 25.84 & 90     & 8 \\
32.78 & 17.23 & 182    & 8 \\
35.70 & 11.49 & 380    & 8 \\
32.96 & 7.66  & 870    & 8 \\
28.53 & 5.10  & 1892   & 8 \\
23.17 & 3.40  & 4160   & 8 \\
14.58 & 2.27  & 9166   & 8 \\
 7.96 & 1.51  & 13205  & 8 \\
\hline
\end{tabular}
\caption{Esquema de renderização multimodal com glifos ODF renderizados em uma imagem $850\times 850$ com a geometria base fixa. A última linha da tabela descreve a geração da imagem na Fig. \ref{fig::multimodal_highres} no apêndice.}
\label{tab::glyph_info_experiment_fixed}
\end{table}

Observe que não conseguimos renderizar os glifos em taxas interativas quando há muitos deles sendo renderizados e para resolver este problema, resolvemos tornar a geometria base dos glifos adaptativa. Assim, dividimos este problema em duas partes: (1) como podemos alternar geometrias base para sub-malhas de malha esférica base em tempo de execução; e (2) como podemos diminuir o tráfego de dados para que apenas os dados referentes às sub-malhas sejam enviados à GPU.

Com este objetivo, propomos a segunda condição que restringe o uso da malha esférica base $(\Pi, I)$: $(\Pi, I)$ se torna $(\Pi, I_k)$ e tem $k$ sub-malhas, onde cada sub-malha é denotada por $(\Pi_i, I_i)$,  $(0 \leq i \leq k)$. Adicionalmente, o número de pontos das sub-malhas é crescente de acordo com os sub-índices, i.e. se $(0 \leq i < j < k)$, implica $|\Pi_j| > |\Pi_i|$. Os primeiros $|\Pi_i|$ elementos na estrutura de dados de $\Pi$ corresponde aos elementos de $\Pi_i$. Note que esta condição também implica que, para $i$, $j$ tais $0 \leq i < j < k$, $\Pi_i$ é subconjunto de $\Pi_j$.

Aplicadas estas condições, resolvemos a alternância de malhas esféricas, fazendo com que, no processo de inicialização do algoritmo de renderização, os conjunto de vértices $\Pi$ e os conjunto de índices $I_0$, $I_1$, ..., $I_{k-1}$, $I_k$ sejam carregados na GPU.

Resolvemos o problema de tráfego de dados no envio das amostras, no qual as amostras que deformam a sub-malha esférica de mais baixa resolução são colocadas na parte inicial de $\boldsymbol{\psi(\mathbf{r})}$, as amostras que deformam a sub-malha esférica de segunda mais baixa resolução, envolve as amostras da primeira e as suas próprias amostras em $\boldsymbol{\psi(\mathbf{r})}$, e assim por diante.

Sugerimos tesselações do icosaedro de ordem potência de dois para este fim, no qual propomos que os vértices do icosaedro consistam nos primeiros 12 vértices da estrutura de dados, a subdivisão de $2^a$ ordem consista nos 42 primeiros vértices, a subdivisão de $4^a$ ordem consista nos primeiros 162 vértices na estrutura de dados, e assim sucessivamente\footnote{A Eq. \ref{eq::icosphere_vertices} formula a quantidade de vértices em função da ordem de tesselação.}. Adicionalmente, as antípodas estão dispostas de forma consecutiva na memória no conjunto de vértices $\Pi$, assim como nas Seções \ref{sec::otimizacao_da_simetria} e \ref{sec::estrutura_de_dados_para_textura_RGBA}.

A forma que escolhemos para fazer a escolha entre uma destas é baseado na relação heurística de \citeonline{voltoline2021}, que estabelece uma quantidade mínima de triângulos para manutenção de uma boa qualidade visual dos glifos, dado a sua ocupância em \textit{pixels}, que está formulada na Seção %\ref{sssec::formulação_da_geometria_e_estruturação_de_dados}, 
\ref{malha_esferica}. A quantidade de amostras enviadas à GPU para customizar o glifo das sub-malhas se torna adaptativa, na Seção \ref{sec::renderizacao_de_glifos_ODF}, estruturamos os dados afim de gerar essa adaptabilidade e na Seção \ref{ssec::preparacao_de_dados}, aproveitamos essa estruturação para limitarmos a matriz com somente as amostras que customizam o glifo para a sub-malha escolhida.
% e \ref{sssec::dados_de_odf}
.

Na Seção \ref{sec::qualidade_visual_longe} do apêndice, apresentamos duas imagens com 13205 glifos onde utilizamos a geometria base derivadas da $2^a$ e $8^a$ ordem de tesselação integradas ao ambiente de visualização multimodal, em que estão mapeadas nas Fig. \ref{fig::qualidade_visual_longe_lowres} e \ref{fig::qualidade_visual_longe_highres}, respectivamente. As imagens foram geradas com os parâmetros das últimas linhas das Tabelas \ref{tab::glyph_info_experiment} e \ref{tab::glyph_info_experiment_fixed}, respectivamente. A partir delas, podemos observar que não há diferença visual perceptível, o que nos leva a crer que não há contrapartida em qualidade visual dos glifos para adaptabilidade da geometria base.

Na Tabela \ref{tab::glyph_info_experiment} do Capítulo \ref{chap::renderizacao_interativa_de_perfis_de_difusao} consta o experimento feito com a malha esférica adaptativa, e ao comparamos os resultados entre ambas, podemos concluir que conseguimos obter aproximadamente 10 FPS a mais quando 13205 glifos são renderizados e 8,5 FPS quando pouco mais de 9000 glifos são renderizados, e que conseguimos uma solução satisfatória para o problema da interatividade da visualização quando uma grande quantidade de glifos é renderizada.

Há uma diminuição do FPS mostrado nas ultimas duas linhas da tabela \ref{tab::glyph_info_experiment}, onde 9032 e 13205 glifos são renderizados. O gargalo que diminui a performance do algoritmo está relacionada ao alto tráfego de dados GPU-CPU com as coordenadas dos \textit{voxels} detectados. Nesta abordagem de renderização, não podemos compensar este gargalo pois a alta dimensionalidade das ODFs tornam inviável o seu armazenamento completo na GPU.




\chapter{Conclusão}
\label{chap::conclusao}


Neste trabalho abordamos a renderização de funções de distribuição de orientação de métodos de alta ordem para DWI integrado a um ambiente de visualização multimodal que envolve DWI co-registrado a volumes escalares de outras modalidades \cite{VMTKNeuro}. Para alcançar este objetivo, implementamos o cômputo do método de alta ordem Amostragem Generalizada no Espaço-Q e a visualização das ODFs estimadas, aproveitando a infraestrutura e funcionalidades implementadas de co-registro entre dois volumes \cite{ting2014} e a infraestrutura para renderização multimodal para DTI e glifos superquádricos \cite{voltoline2021}.

Para estimação de ODFs de difusão, implementamos o cômputo do método de imageamento amostragem generalizada no espaço-Q de acordo com o sugerido por \citeonline{yeh2010}. Derivamos o método até chegarmos em uma formulação que relaciona o sinal e o perfil de difusão em uma ODF através de uma multiplicação matricial. Armazenamos as ODFs em amostras e exploramos sua simetria para armazenarmos ODFs de direções simétricas em um somente um valor.

Afim de prover um ambiente que se propõe a ser utilizado para avaliação de ODFs, desenvolvemos um algoritmo de renderização de ODFs em glifos, nos quais são posicionados em seus respectivos \textit{voxels} na renderização multimodal. Nos baseamos no algoritmo de renderização multimodal para volumes de ressonância magnética DWI e T1 co-registrados com glifos superquádricos proposto por \citeonline{voltoline2021} e exploramos a simetria de ODFs e a percepção visual humana para renderizar os glifos em tempo interativo.

Levando estes pontos em consideração, propomos uma forma de estruturar dados de amostras de ODF armazenadas na CPU. Adicionalmente, propomos o cômputo da resolução da malha, como os dados são enviados e acessados na GPU para gerar cada um dos glifos e como utilizamos a renderização por instanciação para gerar múltiplos glifos com um comando de desenho.

Nos experimentos que fizemos, atestamos que o algoritmo integrado ao ambiente de visualização multimodal renderiza quadros a uma taxa interativa e também mostramos que, através deles, é possível inferir acerca de cruzamentos de fibras.

\section{Futuros Trabalhos}

Para futuros trabalhos, podemos pesquisar o cômputo da distribuição local de fibras subjacentes às ODFs, bem como pesquisar e desenvolver uma abordagem de tractografia para gerar tratos do cérebro baseados na distribuição local, como mostrado no fluxograma da Fig. \ref{fig::flowchart_vmtk_hardi}. Podemos explorar o algoritmo de \citeonline{Chamberland2016}, que propôs um algoritmo onde as fibras são reconstruídas em tempo interativo a partir de distribuição local de fibras subjacentes pré-computadas e que entram de acordo com a visualização interativa proposta no VMTK-Neuro. Ressaltamos que métodos de tractografia baseadas em ODFs é um problema em aberto e alguns dos desafios da área podem ser encontrados em \citeonline{SCHILLING2019194}.

Por questões de otimização no uso de memória, que é muito demandada por dados gerados a partir de métodos de alta ordem, destacamos que é importante que haja uma forma de segmentar o cérebro para aquisição de difusão, para que métodos de alta ordem não aloquem memória para \textit{voxels} que não estão contidos no cérebro.


Na renderização multimodal para glifos ODF, podemos investigar e pesquisar o uso dos princípios mostrados no algoritmo de renderização de glifos para ODFs que propomos e investigar o seu uso em funções que estejam representadas como uma soma ponderada de harmônicas esféricas, que são frequentemente utilizadas na comunidade de pesquisa de métodos de alta ordem \cite{descoteaux2007_QBI, Tournier2004DirectEO, tournier2007}.


%bem como desenvolver aplicações de visualização associadas. Adaptando muito do que já fora desenvolvido para o DTI, as aplicações desenvolvidas para o método consistem na estimação de ODFs via transformada de Funk-Radon, visualização em tempo interativo de ODFs em glifos e o desenvolvimento de um algoritmo de tractografia associado.

%Objetivando prover um ambiente que permite a avaliação de ODFs, aproveitando as funcionalidades presentes no VMTK-Neuro para exploração de DWIs e MRI anatômicos, foi desenvolvido um esquema de renderização em tempo interativo que mapeia as ODFs em suas representações gráficas polares esféricas.

%Com o objetivo de melhorar e tractografia baseada em DTI, foi implementado um protótipo de algoritmo de tractografia baseado em um conjunto de direções de métodos HARDI. !!(No trato corticoespinhal, no qual o DTI não consegue resolver).
%Adicionalmente, a tractografia gera resultados em tempo interativo para o usuário, permitindo-o explorar livremente para diferentes parâmetros.

%\section{Futuros trabalhos}

%Na renderização de glifos, pode-se implementar o cômputo de vetores normais para serem usados na iluminação das superfícies, o que é algo comum na apresentação por glifos. Adicionalmente, podemos implementar as representações polares esféricas sugerida por \citeonline{hlawitschka2012} e/ou \citeonline{almsick2011} para fins de comparação de performance com a nossa abordagem.

%Em tractografia, o próximo passo é a implementação do afiamento de ODFs, o que melhora extração de direções plausíveis de direções a serem usadas no \textit{tracking} de fibras \cite{fillard2011, SCHILLING2019194}.
\pagebreak
 \chapter{Apêndice}
 \section{Qualidade visual dos glifos a uma visão distante}
 \label{sec::qualidade_visual_longe}


% \section{Imagens de ODFs mapeadas em glifos renderizadas no VMTK-Neuro}

% \label{section::QBall_Glifos}

 \begin{figure}[H]
 %\subfigcapskip = -5pt
     \centering
     \includegraphics[width=1.0\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Adaptividade-multimodal/Fatia_42.png}
      \caption{13205 glifos renderizados sobre um volume \textit{ray-casted}. A geometria base utilizada é proveniente da tesselação de $2^a$ ordem do icosaedro.}
       \label{fig::qualidade_visual_longe_lowres}
  %   \hspace{1pt}
 \end{figure}
 
  \begin{figure}[H]
 %\subfigcapskip = -5pt
     \centering
     \includegraphics[width=1.0\linewidth, angle=0]{figs/Renderizacao_glifos_evolucao/Adaptividade-multimodal/Fatia_642.png}
      \caption{13205 glifos renderizados sobre um volume \textit{ray-casted}. A geometria base utilizada é proveniente da tesselação de $8^a$ ordem do icosaedro.}
       \label{fig::qualidade_visual_longe_highres}
  %   \hspace{1pt}
 \end{figure}
 
 \section{Expressões analíticas para harmônicas esféricas}
 \label{sec::harmonicas_esfericas}
 A conversão de $\mathbf{\hat{u}} = (u_x, u_y, u_z)$, $|\mathbf{\hat{u}}| = 1$ para o par $(\theta, \varphi)$ é dado por:
 \begin{equation}
     (\theta, \varphi) = (\arccos (u_z), \arctan (\frac{u_y}{u_x}))
 \end{equation}
 
 As expressões analíticas para as harmônicas esféricas de ordem zero a dois e $Y_3^0$ utilizadas no Capítulo \ref{chap::renderizacao_de_perfis_de_difusao} são:
\begin{equation}
\begin{array}{l}
Y_{0}^{0}(\theta, \varphi)=\frac{1}{2} \sqrt{\frac{1}{\pi}} \\
Y_{1}^{-1}(\theta, \varphi)=\frac{1}{2} \sqrt{\frac{3}{2 \pi}} \sin (\theta) e^{-i \varphi} \\
Y_{1}^{0}(\theta, \varphi)=\frac{1}{2} \sqrt{\frac{3}{\pi}} \cos (\theta) \\
Y_{1}^{1}(\theta, \varphi)=\frac{-1}{2} \sqrt{\frac{3}{2 \pi}} \sin (\theta) e^{i \varphi} \\
Y_{2}^{-2}(\theta, \varphi)=\frac{1}{4} \sqrt{\frac{15}{2 \pi}} \sin ^{2} (\theta) e^{-2 i \varphi} \\
Y_{2}^{-1}(\theta, \varphi)=\frac{1}{2} \sqrt{\frac{15}{2 \pi}} \sin (\theta) \cos (\theta) e^{-i \varphi} \\
Y_{2}^{0}(\theta, \varphi)=\frac{1}{4} \sqrt{\frac{5}{\pi}}\left(3 \cos ^{2} (\theta)-1\right) \\
Y_{2}^{1}(\theta, \varphi)=\frac{-1}{2} \sqrt{\frac{15}{2 \pi}} \sin (\theta) \cos (\theta) e^{i \varphi} \\
Y_{2}^{2}(\theta, \varphi)=\frac{1}{4} \sqrt{\frac{15}{2 \pi}} \sin ^{2} (\theta) e^{2 i \varphi} \\
Y_{3}^{0}(\theta, \varphi)=\frac{1}{4} \sqrt{\frac{7}{\pi}}\left(5 \cos ^{3} (\theta)-3 \cos (\theta)\right)
\end{array}
\end{equation}

% \begin{figure}[H]
% \label{fig::QBall_glifos_sagital}
% %\subfigcapskip = -5pt
%     \centering

%     \includegraphics[width=.7\linewidth, angle=0]{figs/Exemplos_QBall_visualizacao/Sagital.png}
%     \caption{Projeção Sagital.}
%  %   \hspace{1pt}
% \end{figure}

% \begin{figure}[H]
% \label{fig::QBall_glifos_coronal}
% %\subfigcapskip = -5pt
%     \centering

%     \includegraphics[width=0.7\linewidth, angle=0]{figs/Exemplos_QBall_visualizacao/Coronal.png}
%     \caption{Projeção Coronal.}
%  %   \hspace{1pt}
% \end{figure}

% \begin{figure}[H]
% \label{fig::QBall_glifos_Coronal_CC_CS}
% %\subfigcapskip = -5pt
%     \centering
%     \includegraphics[width=.7\linewidth, angle=0]{figs/Exemplos_QBall_visualizacao/Coronal_Cruzamento_MapaFA.png}
%     \caption{Projeção Coronal - Região de cruzamento de fibras. Glifos renderizado sobre mapa FA codificado por cores do DTI.}
%  %   \hspace{1pt}
% \end{figure}

% \begin{figure}[H]
% \label{fig::QBall_glifos_azul}
% %\subfigcapskip = -5pt
%     \centering

%     \includegraphics[width=.4\linewidth, angle=0]{figs/Exemplos_QBall_visualizacao/Glifo_Azul.png}
%     \caption{Glifo referente a um voxel com direção de difusão predominantemente ascendente.}
%  %   \hspace{1pt}
% \end{figure}

\pagebreak


% \section{\textit{Overplus} e problemas com o mapeamento do sinal de difusão em ODFs}
% \label{ssec::problema_overplus}

% Após um estudo que visou comparar ODFs geradas a partir de diferentes esquemas de amostragem de gradientes de ponderação de difusão, concluímos que a falta de uniformidade do conjunto de gradientes do \textit{Overplus} no domínio esférico compromete a interpolação de sinais de difusão no processo de cômputo do \textit{Q-Ball}. A figura \ref{fig::shell_Overplus_VS_ISMRM} mostra a distribuição no \textit{shell}\footnote{\textit{Shell} é um consiste em um conjunto definido em uma esfera.} das direções dos gradientes do \textit{Overplus}, em adição ao utilizado no volume ISMRM 2015.

% \begin{figure}[ht]
% \centering
% \captionsetup[subfloat]{farskip=5pt,nearskip=0pt}
%     %!!VER SE ISSO TA CERTO
%     \subfloat[\textit{Overplus}.] {\includegraphics[width=.4\linewidth, angle=0]{figs/Overplus_VS_ISMRM/shell_overplus.png}}    
%     \hfill
%     \subfloat[Esquema utilizado no ISMRM.]{\includegraphics[width=.4\linewidth, angle=0]{figs/Overplus_VS_ISMRM/shell_ismrm.png}}
%      \caption{Domínio esférico com pontos de amostragem referentes a direção de gradientes de difusão. Vermelho: direções de amostragem. Azul: sentido oposto da direção de amostragem.}
%     %\hfill
%     \label{fig::shell_Overplus_VS_ISMRM}
% \end{figure}


% Um bom conjunto de gradientes de codificação de difusão vinculada a um DWI não tem uma preferência direcional, as amostras no domínio esférico possuem uma boa invariância à orientação das estruturas do tecido ou coordenadas da máquina e a separação angular entre um par de pontos mais próximos é máxima e constante para todos os elementos \cite{cheng2018}. Um conjunto que segue essas propriedades estão distribuídos uniformemente sobre o \textit{shell}.

% Há uma certa concordância na literatura de que uma uniformidade no domínio esférico em aquisições \textit{single shell}\footnote{Denomina-se aquisição \textit{single shell} como volumes de ressonância de difusão escaneados com apenas um valor b, além do b0.} é importante para uma boa reconstrução de ODFs. \citeonline{yeh2010} mencionam a importância da uniformidade além de propor uma métrica para aferir o seu grau. \citeonline{cheng2018} discorrem sobre formulações de esquemas de amostragem de gradientes de forma uniforme e mencionam as suas vantagens.

% Como parte do processo de investigação dos resultados não esperados de ODFs gerados a partir dos volumes adquiridos através do protocolo \textit{Overplus}, foram escaneados para um mesmo indivíduo um volume com o conjunto de direções da competição ISMRM, o padrão, e um usando o protocolo \textit{Overplus} da Philips, em que todos possuem a mesma resolução angular de 32 direções. A análise feita consistiu na inspeção da forma dos glifos na região do corpo caloso que contém uma forte componente na direção mediolateral. A localização desta região se dá através do mapa FA codificado por cor gerado pelo DTI, em que não foi constatado nenhum problema nestes esquemas de aquisição.


% Nesta inspeção, foi possível gerar glifos das ODFs razoáveis para o esquema de amostragem do ISMRM (Figura \ref{fig::Overplus_VS_ISMRM_b}), o que não aconteceu com o \textit{Overplus}, em que as ODFs ficaram totalmente descaracterizadas em comparação com os códigos de cores, conforme mostrado na Figura \ref{fig::Overplus_VS_ISMRM_a}.

% \begin{figure}[ht]
% \centering
% \captionsetup[subfloat]{farskip=5pt,nearskip=0pt}
    
%     \subfloat[\textit{Overplus}] {\label{fig::Overplus_VS_ISMRM_a} \includegraphics[width=.45\linewidth, angle=0, ]{figs/Overplus_VS_ISMRM/Overplus.png}}
%     \hfill
%     \subfloat[Esquema da competição ISMRM]{\label{fig::Overplus_VS_ISMRM_b} \includegraphics[width=.47\linewidth, angle=0]{figs/Overplus_VS_ISMRM/ISMRM.png}}
%     %\hfill
%     \caption{Glifos do Corpo Caloso - Mediolateral. Glifos de ODF sobre mapa FA codificado por cor do DTI.} %!!VER SE ISSO TA CERTO
%     \label{fig::Overplus_VS_ISMRM}
% \end{figure}
\pagebreak


%\bibliographystyle{}
\bibliography{references.bib}

% ----------------------------------------------------------
% Glossário
% ----------------------------------------------------------
%
% Consulte o manual da classe abntex2 para orientações sobre o glossário.
%
%\glossary

% ----------------------------------------------------------
% Apêndices
% ----------------------------------------------------------

% ---
% Inicia os apêndices
% ---
%\begin{apendicesenv}
%\end{apendicesenv}
% ---


% ----------------------------------------------------------
% Anexos
% ----------------------------------------------------------

% ---
% Inicia os anexos
% ---
\begin{anexosenv}
\end{anexosenv}

%---------------------------------------------------------------------
% INDICE REMISSIVO
%---------------------------------------------------------------------
%\phantompart
\printindex
%---------------------------------------------------------------------

\end{document}


